{% extends "homebase.html" %}
{% load i18n %}
{% load static %}
{% load custom_tags %}
{% block sidebar %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@2.0.1/dist/css/multi-select-tag.css">
    <script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@2.0.1/dist/js/multi-select-tag.js"></script>
<!--Multi Select Date Picker Calender-->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="{% static 'assets/js/layout.js' %}"></script>
    <!-- Bootstrap Css -->
    <!-- Icons Css -->
    <link href="{% static 'assets/css/icons.min.css' %}" rel="stylesheet" type="text/css">
    <!-- App Css-->
    <link href="{% static 'assets/css/app.min.css' %}" rel="stylesheet" type="text/css">
    <!-- custom Css-->
    <link href="{% static 'assets/css/custom.min.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'assets/css/custom.css' %}" rel="stylesheet" type="text/css">
    <!--Multi Select Date Picker Calender-->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .app-menu {
        z-index: 88 !important;
    }
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
    color: #212529;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #013744;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.filters {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.filter-input {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 16px;
    width: auto;
}

.btn {
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 16px;
}

.apply-btn {
    background-color: #24d6b6;
    color: white;
}

.bulk-btn {
    background-color: #24d6b6;
    color: white;
}

.save-btn {
    background-color: #013744;
    color: white;
}

.table-container {
    overflow-x: auto;
    position: relative;
}

.attendance-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    background-color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-radius: 12px;
}

.attendance-table th, .attendance-table td {
    border-bottom: 1px solid #ddd;
    padding: 12px;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
}

.attendance-table th:first-child, 
.attendance-table td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
    position: sticky;
    left: 0;
    background-color: #f8f9fa;
    z-index: 1;
}

.attendance-table th:last-child, 
.attendance-table td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

.attendance-table tr:last-child td:first-child {
    border-bottom-left-radius: 12px;
}

.attendance-table tr:last-child td:last-child {
    border-bottom-right-radius: 12px;
}

.day-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px; /
}

.day-hours, .overtime-hours {
    width: 50px; /* Genişlik */
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ddd;
    background-color: #f4f4f4;
    text-align: center; /* İçeriği ortala */
    font-size: 14px; /* Yazı boyutunu artır */
}

.overtime-hours {
    margin-bottom: 0;
}

.attendance-table th, .attendance-table td {
    padding: 5px; /* Hücrelerin iç boşluğu artırıldı */
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
}


.custom-card {
    background-color: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.month-header {
    text-align: left;
    margin-bottom: 20px;
}

.month-header h2 {
    font-size: 18px;
    font-weight: 500;
    color: #013744;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
    padding-top: 60px;
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.modal-content p {
    margin-bottom: 20px;
    font-size: 16px;
}

.close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.total-box {
    background-color: #013744;
    color: white;
    padding: 10px 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.total-box p {
    margin: 0;
    font-size: 14px;
}

.total-box h3 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #fff;

}

@media only screen and (max-width: 768px) {
    .filters {
        flex-direction: column;
        align-items: flex-start;
    }

    .filter-input {
        width: 100%;
    }

    .table-container {
        overflow-x: scroll;
    }
}
.no-data-message {
    text-align: center;
    color: #666;
    font-size: 16px;
    margin: 20px 0;
}
/* Preloader */
.preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.8);
    font-size: 24px;
    color: #013744;
    z-index: 9999;
}

/* Tablo */
.container {
    margin-top: 20px;
}

.attendance-table {
    width: 100%;
    border-collapse: collapse;
}

.attendance-table th, .attendance-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

</style>
<style>
#preloader {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
}

.spinner {
    border: 8px solid #f3f3f3; /* Light grey */
    border-top: 8px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

   <div id="preloader" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; font-size: 20px; color: black;">
    Yükleniyor...
</div>
<main>

    <div class="page-header">
        <div class="page-info">
            <div class="page-title">
                <a href="#"><i class="icon icon-arrow-circle-left"></i></a>
                {% trans "Aylık Puantaj Girişi" %}
            </div>
            <ul class="page-breadcrumb">
                <li><a href="#">{% trans "Dashboard" %}</a></li>
                <li><a href="#">{% trans "Employee Management" %}</a></li>
                <li><a href="#">{% trans "Aylık Puantaj Girişi" %}</a></li>
            </ul>
        </div>

        <div class="page-actions">
            <button id="saveBtn" class="btn save-btn"><i class="fas fa-save"></i> {% trans "Kaydet" %}</button>
           
        </div>
    </div>

           
        <div class="container-fluid">
            <div class="header-top">
                
                
            </div>
            <div class="filters">
            <form id="filterForm" method="GET" >
                <input type="month" id="monthFilter" name="monthFilter" class="filter-input"
       value="{% if request.GET.monthFilter %}{{ request.GET.monthFilter }}{% endif %}">

                <select id="jobTypeFilter" name="jobTypeFilter" class="filter-input">
    <option value="">Kategori Seçin</option>
    {% for i in departmanlar %}
        <option value="{{ i.id }}" {% if request.GET.jobTypeFilter == i.id|stringformat:"s" %}selected{% endif %}>
            {{ i.kategori_isimi }}
        </option>
    {% endfor %}
    <input type="text" id="personelID" hidden name="personelID" class="filter-input"
       value="{% if request.GET.personelID %}{{ request.GET.personelID }}{% endif %}">
</select>

            </form>
                <button id="applyFilters" class="btn apply-btn"><i class="fas fa-filter"></i> Filtreleri Uygula</button>
               <div class="total-box">
                    <p>Toplam Hakediş:</p>
                    <h3 id="totalSalaryDisplay">0 $</h3>
                </div>
            </div>
        </div>
     <!-- Preloader -->
    <div id="preloader" class="preloader">Yükleniyor...</div>

    <div class="container-fluid">
        <div class="month-header">
            <h2 id="selectedMonth">Eylül 2024 Puantajı</h2>
        </div>

        <div class="bulk-entry custom-card">
            <label>Toplu Giriş: </label>
            <input type="date" id="bulkStartDate" class="filter-input" placeholder="Başlangıç Tarihi">
            <input type="date" id="bulkEndDate" class="filter-input" placeholder="Bitiş Tarihi">
            <input type="number" id="bulkHours" class="filter-input" placeholder="Normal Saat">
            <input type="number" id="bulkOvertime" class="filter-input" placeholder="Mesai Saati">
            <button id="applyBulk" class="btn bulk-btn"><i class="fas fa-edit"></i> Uygula</button>
        </div>

        <div class="table-container custom-card">
              <div id="noDataMessage" class="no-data-message" style="display: none;">
        <p>Veri bulunamadı, görüntülemek için ay seçimi yapın.</p>
    </div>
            <table class="attendance-table puantaj-table" id="hafta-1-table">
                <thead>
                    <tr>
                        <th>Ad Soyad</th>
                        <th>Görevi</th>
                        <!-- Günler için başlıklar -->
                        {% for day in gun %}
                        
                        
                        <th>{{day}}</th>
                        {% endfor %}
                        <th>Toplam Çalışma</th>
                        <th>Toplam Mesai</th>
                        <th>Hakediş</th>
                    </tr>
                </thead>
                <tbody>
                    <!--Burda django çalışacak -->
                    {% for i in personeller %}
                    
                    
                <tr>
                        <td>{{i.isim}} {{i.soyisim}}</td>
                        <td>{{i.calisan_kategori.kategori_isimi}}</td>
                        {% for day in gun %}
    {% calismalari_cek i.id day request.GET.monthFilter as bilgi %}
    <td>
        <div class="day-container">
            <input type="number" class="day-hours" data-person="{{i.id}}" data-day="{{day}}" data-type="normal" step="0.01" min="0" max="24" value="{{bilgi.normal_saat|stringformat:'.2f'}}" placeholder="Normal">
            <input type="number" class="overtime-hours" data-person="{{i.id}}" data-day="{{day}}" data-type="overtime" step="0.01" min="0" max="24" value="{{bilgi.mesai_saati|stringformat:'.2f'}}" placeholder="Fazla Mesai">
        </div>
    </td>
{% endfor %}

                            
                        <td class="total-working-hours">0</td>
                        <td class="total-overtime-hours">0</td>
                        <td class="total-salary">0 </td>
                    </tr>
                    <!-- Dinamik personel satırları buraya gelecek -->
                    {% endfor %}
                </tbody>
            </table>
    
    <!-- Başarı Mesajı Modalı -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <p><i class="fas fa-check-circle"></i> Puantaj başarıyla kaydedildi!</p>
        </div>
    </div>

    <!-- Uyarı Mesajı Modalı -->
    <div id="warningModal" class="modal">
        <div class="modal-content">
            <p id="warningMessage">Şu şu tarih aralığında şukadar kişi için veri girişi yapıyorsunuz. Emin misiniz?</p>
            <button id="confirmBulkEntry" class="btn bulk-btn">Evet</button>
            <button id="cancelBulkEntry" class="btn bulk-btn">Hayır</button>
        </div>
    </div>



    </div>

  
<script>
    document.getElementById('monthFilter').addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });

    document.getElementById('jobTypeFilter').addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
    
// Toplu Veri Girişi
document.getElementById('applyBulk').addEventListener('click', function() {
    const bulkStartDate = document.getElementById('bulkStartDate').value;
    const bulkEndDate = document.getElementById('bulkEndDate').value;
    const bulkHours = document.getElementById('bulkHours').value;
    const bulkOvertime = document.getElementById('bulkOvertime').value;

    const startDay = new Date(bulkStartDate).getDate();
    const endDay = new Date(bulkEndDate).getDate();

    // Uyarı modalını göster
    const warningModal = document.getElementById('warningModal');
    const warningMessage = document.getElementById('warningMessage');
    const dayCount = (endDay - startDay) + 1;
    const personnelCount = document.querySelectorAll('.attendance-table tbody tr').length;
    
    warningMessage.textContent = `${dayCount} gün ve ${personnelCount} kişi için veri girişi yapıyorsunuz. Emin misiniz?`;
    warningModal.style.display = 'block';

    // Evet ve Hayır butonları için event listener ekle
    document.getElementById('confirmBulkEntry').addEventListener('click', function() {
        applyBulkEntries(startDay, endDay, bulkHours, bulkOvertime);
        warningModal.style.display = 'none';
    });

    document.getElementById('cancelBulkEntry').addEventListener('click', function() {
        warningModal.style.display = 'none';
    });
});

function applyBulkEntries(startDay, endDay, bulkHours, bulkOvertime) {
    const rows = document.querySelectorAll('.attendance-table tbody tr');
    rows.forEach(row => {
        for (let i = startDay - 1; i < endDay; i++) {
            const dayInput = row.querySelectorAll('.day-hours')[i];
            const overtimeInput = row.querySelectorAll('.overtime-hours')[i];
            dayInput.value = bulkHours;
            overtimeInput.value = bulkOvertime;
        }
    });

    calculateTotal();
}

// Toplam Ücret ve Saat Hesaplama
document.addEventListener('input', function(event) {
    if (event.target.classList.contains('day-hours') || event.target.classList.contains('overtime-hours')) {
        calculateTotal();
    }
});




// Kaydetme ve Başarı Mesajı Gösterme
document.getElementById('saveBtn').addEventListener('click', function() {
    const successModal = document.getElementById('successModal');
    successModal.style.display = 'block';
});

document.querySelector('.close-btn').addEventListener('click', function() {
    const successModal = document.getElementById('successModal');
    successModal.style.display = 'none';
});

window.addEventListener('click', function(event) {
    const successModal = document.getElementById('successModal');
    if (event.target == successModal) {
        successModal.style.display = 'none';
    }
});
// Normal mesai inputları için renk değiştirme fonksiyonu
function updateInputBackground(inputElement) {
    const value = parseFloat(inputElement.value);
    
    if (isNaN(value)) {
        return; // Eğer input boş ise hiçbir değişiklik yapma
    }

    if (value >= 1 && value <= 4) {
        inputElement.style.backgroundColor = '#FEBA33';  // 1-4 arasında
        inputElement.style.color = '#000000';
    } else if (value >= 5 && value <= 8) {
        inputElement.style.backgroundColor = '#1AA5E0';  // 5-8 arasında
        inputElement.style.color = '#000000';
    } else if (value === 9) {
        inputElement.style.backgroundColor = '#23D4AF';  // 9 olduğunda
        inputElement.style.color = '#000000';
    } else if (value > 9) {
        inputElement.style.backgroundColor = '#FF5450';  // 9 üzeri
        inputElement.style.color = '#000000';
    }
}

// Fazla mesai inputları için renk değiştirme fonksiyonu
function updateOvertimeBackground(inputElement) {
    const value = parseFloat(inputElement.value);
    
    if (isNaN(value)) {
        return; // Eğer input boş ise hiçbir değişiklik yapma
    }

    if (value > 0) {
        inputElement.style.backgroundColor = '#F45B42';  // Fazla mesai 0'dan büyükse
        inputElement.style.color = '#000000';
    } else {
        inputElement.style.backgroundColor = '';  // Varsayılan rengi koru
        inputElement.style.color = '';
    }
}

// Toplu veri girişini gerçekleştiren fonksiyon
function applyBulkEntries(startDay, endDay, bulkHours, bulkOvertime) {
    const rows = document.querySelectorAll('.attendance-table tbody tr');
    rows.forEach(row => {
        for (let i = startDay - 1; i < endDay; i++) {
            const dayInput = row.querySelectorAll('.day-hours')[i];
            const overtimeInput = row.querySelectorAll('.overtime-hours')[i];
            dayInput.value = bulkHours;
            overtimeInput.value = bulkOvertime;

            // Toplu giriş sırasında renk değiştirme fonksiyonlarını çağırıyoruz
            updateInputBackground(dayInput);        // Normal mesai için
            updateOvertimeBackground(overtimeInput); // Fazla mesai için
        }
    });

    calculateTotal(); // Toplam ücret ve saat hesaplamasını güncelle
}

// Toplu veri girişi fonksiyonu
document.getElementById('applyBulk').addEventListener('click', function() {
    const bulkStartDate = document.getElementById('bulkStartDate').value;
    const bulkEndDate = document.getElementById('bulkEndDate').value;
    const bulkHours = document.getElementById('bulkHours').value;
    const bulkOvertime = document.getElementById('bulkOvertime').value;

    const startDay = new Date(bulkStartDate).getDate();
    const endDay = new Date(bulkEndDate).getDate();

    // Uyarı modalını göster
    const warningModal = document.getElementById('warningModal');
    const warningMessage = document.getElementById('warningMessage');
    const dayCount = (endDay - startDay) + 1;
    const personnelCount = document.querySelectorAll('.attendance-table tbody tr').length;
    
    warningMessage.textContent = `${dayCount} gün ve ${personnelCount} kişi için veri girişi yapıyorsunuz. Emin misiniz?`;
    warningModal.style.display = 'block';

    // Evet ve Hayır butonları için event listener ekle
    document.getElementById('confirmBulkEntry').addEventListener('click', function() {
        applyBulkEntries(startDay, endDay, bulkHours, bulkOvertime);
        warningModal.style.display = 'none';
    });

    document.getElementById('cancelBulkEntry').addEventListener('click', function() {
        warningModal.style.display = 'none';
    });
});

// Inputların renklerini değiştir
document.addEventListener('input', function (event) {
    if (event.target.classList.contains('day-hours')) {
        updateInputBackground(event.target);  // Normal mesai inputu
    } else if (event.target.classList.contains('overtime-hours')) {
        updateOvertimeBackground(event.target);  // Fazla mesai inputu
    }
});
function toparlama() {
            // Tüm inputları seç
            document.querySelectorAll('.day-hours, .overtime-hours').forEach(input => {
                if (input.value) {  // Eğer değer varsa işlemi uygula
                    if (input.classList.contains('day-hours')) {
                        updateInputBackground(input);
                    } else if (input.classList.contains('overtime-hours')) {
                        updateOvertimeBackground(input);
                    }
                }
            });
        }

        // Sayfa yüklendiğinde toparlama fonksiyonunu çalıştır
        document.addEventListener('DOMContentLoaded', toparlama);

function calculateTotal() {
    const rows = document.querySelectorAll('.attendance-table tbody tr');
    let totalSalary = 0;

    rows.forEach(row => {
        const dayHours = row.querySelectorAll('.day-hours');
        const overtimeHours = row.querySelectorAll('.overtime-hours');
        
        let totalWorkingHours = 0;
        let totalOvertimeHours = 0;

        dayHours.forEach((input, index) => {
            totalWorkingHours += parseFloat(input.value);
            totalOvertimeHours += parseFloat(overtimeHours[index].value);
        });

        const rowTotalSalary = (totalWorkingHours * 10) + (totalOvertimeHours * 15); // Örnek ücret hesaplama
        totalSalary += rowTotalSalary;

        row.querySelector('.total-working-hours').innerText = totalWorkingHours;
        row.querySelector('.total-overtime-hours').innerText = totalOvertimeHours;
        row.querySelector('.total-salary').innerText = rowTotalSalary.toFixed(2) + '';
    });

    document.getElementById('totalSalaryDisplay').innerText = totalSalary.toFixed(2) + '';
}

</script>
<script>
    
document.querySelector('#saveBtn').addEventListener('click', function() {
    const dayInputs = document.querySelectorAll('.day-hours');
    const overtimeInputs = document.querySelectorAll('.overtime-hours');
    const filter_input = document.querySelector(".filter-input");
    const dis_katman = [filter_input.value];
    const dataToSend = [];

    // Preloader'ı göster
    //document.getElementById('preloader').style.display = 'block';

    // Normal saatler için verileri topla
    dayInputs.forEach(input => {
        const person = input.getAttribute('data-person');
        const day = input.getAttribute('data-day');
        const type = input.getAttribute('data-type');
        const value = input.value;

        // Veriyi toplu olarak diziye ekle
        dataToSend.push({
            person: person,
            day: day,
            type: type,
            value: value
        });
    });

    // Fazla mesai saatleri için verileri topla
    overtimeInputs.forEach(input => {
        const person = input.getAttribute('data-person');
        const day = input.getAttribute('data-day');
        const type = input.getAttribute('data-type');
        const value = input.value;

        // Fazla mesai verisini diziye ekle
        dataToSend.push({
            person: person,
            day: day,
            type: type,
            value: value
        });
    });

    dis_katman.push(dataToSend);

    // AJAX isteği ile Django'ya veri gönder
    fetch('/users/savetally/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(dis_katman)  // Tüm verileri gönderiyoruz
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        // Preloader'ı gizle ve sayfayı yenile
        document.getElementById('preloader').style.display = 'none';
        location.reload();
    })
    .catch(error => {
        console.error('Hata:', error);
        // Hata durumunda preloader'ı gizle
        document.getElementById('preloader').style.display = 'none';
    });
});


</script>
<script>
async function loadPersonnelData() {
    try {
        // Test amaçlı gecikme ekleyin
        await new Promise(resolve => setTimeout(resolve, 3000));  // 3 saniyelik gecikme

        const response = await fetch('https://jsonplaceholder.typicode.com/users');  // Veri kaynağı
        const personnelData = await response.json();

        // Tablonun gövdesini doldur
        const tbody = document.getElementById('personnelTableBody');
        personnelData.forEach((person, personIndex) => {
            const row = document.createElement('tr');
            let daysInputs = '';

            // Her gün için input alanları oluştur
            for (let i = 1; i <= 30; i++) {
                daysInputs += `
                    <td>
                        <div class="day-container">
                            <input type="number" class="day-hours" data-person="${personIndex}" data-day="${i}" data-type="normal" min="0" max="24" value="9">
                            <input type="number" class="overtime-hours" data-person="${personIndex}" data-day="${i}" data-type="overtime" min="0" max="24" value="0">
                        </div>
                    </td>`;
            }

            // Satır yapısını tabloya ekle
            row.innerHTML = `
                <td>${person.name}</td>
                <td>${person.username}</td>
                ${daysInputs}
                <td class="total-working-hours">0</td>
                <td class="total-overtime-hours">0</td>
                <td class="total-salary">0 </td>
            `;

            tbody.appendChild(row);
        });

        // Veriler yüklendikten sonra preloader'ı gizle
        preloader.style.display = 'none';
    } catch (error) {
        console.error("Veri yüklenirken hata oluştu:", error);
        preloader.innerHTML = 'Veri yüklenirken hata oluştu.';
    }
}

</script>
        </div>
    </main>
{% endblock sidebar %}