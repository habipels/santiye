{% extends "homebase.html" %}
{% load i18n %}
{% load custom_tags %}
{% load static %}
{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="{% static 'go/content/style/style.css' %}">
<link rel="stylesheet" href="{% static 'go/content/style/report.css' %}">
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://momentjs.com/downloads/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<!-- Add missing static references -->
<script src="{% static 'go/content/script/report-card-layout.js' %}"></script>

<style>

    
table {
    border-collapse: collapse;
    background-color: #fff;
  }
  table tr,
  table td,
  table th {
    border: 1px solid #bbb;
    padding: 2px 0px;
  }
  table th {
    background-color: #d1084b;
    color: #fff;
    font-weight: 600;
  }
                              
                        
        .report-container {
            display: flex;
            height: calc(100vh - 60px);
            background: #f5f5f5;
            gap: 24px;
            padding: 24px;
        }

        .report-sidebar {
            width: 320px;
            background: #fff;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: calc(100vh - 108px);
        }

        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .report-main {
            flex: 1;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: auto;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #052941;
            margin-bottom: 16px;
        }

        .sidebar-filters {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-group {
            margin-bottom: 16px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .components-list {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .component-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 16px;
            font-weight: 600;
            color: #052941;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component-item {
            padding: 12px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .component-item:hover {
            background: #f0f0f0;
            border-color: #22D6B5;
        }

        .component-item.selected {
            background: #22D6B514;
            border-color: #22D6B5;
            color: #22D6B5;
        }

        .component-icon {
            width: 32px;
            height: 32px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .component-info {
            flex: 1;
        }

        .component-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .component-desc {
            font-size: 12px;
            color: #666;
        }

        .preview-container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            background: #fff;
        }

        .preview-header {
            margin-bottom: 15mm;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5mm;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 600;
            color: #052941;
            margin-bottom: 4px;
        }

        .preview-subtitle {
            font-size: 14px;
            color: #666;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 15mm;
        }

        .report-card {
            position: relative;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .report-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-header {
            background: none;
            padding: 0 0 10px 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #052941;
        }

        .card-body {
            padding: 0;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #052941;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .trend {
            font-size: 12px;
            margin-top: 4px;
        }

        .chart-container {
            height: 250px;
        }

        .text-editor {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .editor-toolbar {
            padding: 8px;
            background: #f8f8f8;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 6px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .toolbar-btn:hover {
            background: #e0e0e0;
        }

        .editor-content {
            padding: 12px;
            min-height: 100px;
        }

        .card-actions {
            display: flex;
            gap: 4px;
        }

        .card-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .card-action-btn:hover {
            background: #e0e0e0;
            color: #052941;
        }

        .move-handle {
            cursor: move;
        }

        /* Boyut sınıfları */
        .report-card[data-size="small"] {
            grid-column: span 4;
        }

        .report-card[data-size="medium"] {
            grid-column: span 4;
        }

        .report-card[data-size="large"] {
            grid-column: span 8;
        }

        .report-card[data-size="full"] {
            grid-column: span 12;
        }

        @media print {
            body {
                background: #fff;
            }

            .report-sidebar,
            .preview-actions {
                display: none !important;
            }

            .report-container {
                padding: 0;
                height: auto;
            }

            .report-main {
                margin: 0;
                padding: 0;
                box-shadow: none;
            }

            .preview-container {
                padding: 0;
            }

            .preview-grid {
                gap: 10mm;
            }

            .report-card {
                page-break-inside: avoid;
            }

            .card-actions {
                display: none;
            }
        }

        /* Şablon seçici stilleri */
        .template-selector {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .template-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-item:hover {
            border-color: #22D6B5;
        }

        .template-item.selected {
            border-color: #22D6B5;
            background: #22D6B514;
        }

        .template-preview {
            height: 100px;
            background: #f8f8f8;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-name {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        /* Sayfa yönetimi stilleri */
        .page-tabs {
            display: flex;
            gap: 2px;
            padding: 0 20px;
            background: #f8f8f8;
            border-bottom: 1px solid #e0e0e0;
        }

        .page-tab {
            padding: 12px 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            position: relative;
            top: 1px;
        }

        .page-tab.active {
            border-bottom-color: #fff;
        }

        .page-tab-add {
            width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        /* Rapor kaydetme formu */
        .save-report-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 400px;
            z-index: 1000;
        }

        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* Sayfa ayarları - sabit alt kısım */
        .page-settings {
            flex-shrink: 0;
            border-top: 1px solid #E2E8F0;
            background: #fff;
            padding: 20px;
            border-radius: 0 0 12px 12px;
        }

        /* Components section */
        .components-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .components-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Sürükle-bırak ve boyutlandırma için yeni stiller */
        .drop-zone {
            min-height: 100px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f8f8;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .drop-zone.drag-over {
            border-color: #22D6B5;
            background: #22D6B514;
        }

        .drop-zone .drop-text {
            color: #666;
            font-size: 14px;
        }

        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 1000;
        }

        .resize-handle-e {
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: e-resize;
        }

        .resize-handle-s {
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8px;
            cursor: s-resize;
        }

        .resize-handle-se {
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: se-resize;
            border-right: 3px solid #22D6B5;
            border-bottom: 3px solid #22D6B5;
            border-radius: 0 0 8px 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .report-card:hover .resize-handle-se {
            opacity: 1;
        }

        .card-move-handle {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            display: none;
        }

        .report-card:hover .card-move-handle {
            display: flex;
        }

        /* Grid sistemi için yeni stiller */
        .report-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            min-height: 100%;
        }

        .report-row {
            display: flex;
            gap: 20px;
            min-height: 100px;
            position: relative;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: #fff;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .report-row:hover {
            border-color: #22D6B5;
            background: #f8f8f8;
        }

        .report-column {
            flex: 1;
            min-height: 100px;
            position: relative;
            padding: 10px;
            border: 1px dashed #ddd;
            border-radius: 4px;
            transition: all 0.3s ease;
            background: #fff;
            overflow: hidden; /* Taşmaları engelle */
        }

        .report-column:hover {
            border-color: #22D6B5;
            background: #f8f8f8;
        }

        /* Row kontrolleri */
        .row-controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #e0e0e0;
            z-index: 1000;
            opacity: 1;
        }

        .report-row:hover .row-controls {
            opacity: 1;
        }

        .row-control-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .row-control-btn:hover {
            background: #22D6B5;
            color: #fff;
        }

        .add-row-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border: none;
            background: #22D6B5;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .add-row-btn:hover {
            background: #1ab3a0;
            transform: scale(1.1);
        }

        /* Kolon kontrolleri */
        .column-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .report-column:hover .column-controls {
            opacity: 1;
        }

        .column-control-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .column-control-btn:hover {
            background: #22D6B5;
            color: #fff;
        }

        /* Boyutlandırma tutamaçları */
        .row-resize-handle {
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 10px;
            background: #22D6B5;
            cursor: row-resize;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .report-row:hover .row-resize-handle {
            opacity: 1;
        }

        /* Kolon boyutlandırma tutamaçları */
        .column-resize-handle {
            position: absolute;
            right: -5px;
            top: 0;
            bottom: 0;
            width: 10px;
            background: #22D6B5;
            cursor: col-resize;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .report-column:hover .column-resize-handle {
            opacity: 1;
        }

        /* Grid ayarları */
        .grid-settings {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .grid-settings-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #fff;
            border-radius: 8px;
            color: #052941;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .grid-settings-btn:hover {
            background: #f8f8f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Responsive tasarım */
        @media (max-width: 768px) {
            .report-row {
                flex-direction: column;
            }
            
            .report-column {
                width: 100%;
            }
        }

        .report-info {
            width: 100%;
            /* Diğer stil tanımlamaları */
        }

        .text-content {
            padding: 15px;
            min-height: 100px;
            background: #fff;
            border-radius: 4px;
        }

        .text-edit-modal .modal-content {
            width: 80%;
            max-width: 800px;
        }

        .text-edit-modal .editor-content {
            min-height: 300px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
        }

        .text-edit-modal .editor-toolbar {
            padding: 10px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            display: flex;
            gap: 5px;
        }

        .text-edit-modal .toolbar-btn {
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            color: #666;
        }

        .text-edit-modal .toolbar-btn:hover {
            background: #e0e0e0;
            color: #052941;
        }

        /* Borç/Alacak Bileşeni Stilleri */
        .deleted-row {
            background-color: #f1f1f1;
            color: #888;
        }
        
        .borc-alacak-filters {
            margin-bottom: 15px;
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .filter-row:last-child {
            margin-bottom: 0;
        }
        
        .filter-group {
            flex: 1;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #64748b;
        }
        
        .apply-filters-btn {
            margin-top: 22px;
            padding: 8px 15px;
            background: #052941;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .apply-filters-btn:hover {
            background: #0b3b5f;
        }
        
        .minimal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .minimal-table th {
            text-align: left;
            padding: 10px;
            background: #f1f5f9;
            color: #64748b;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .minimal-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }
        
        .minimal-table tr:last-child td {
            border-bottom: none;
        }
        
        .minimal-table .amount-col {
            font-weight: 600;
            text-align: right;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }
        
        .status-badge.borc {
            background: #fee2e2;
            color: #b91c1c;
        }
        
        .status-badge.alacak {
            background: #dcfce7;
            color: #15803d;
        }
        
        .borc-alacak-summary {
            margin-top: 15px;
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
        }
        
        /* Resize handle düzeltmeleri */
        .resize-handle-e, 
        .resize-handle-s, 
        .resize-handle-se {
            position: absolute;
            background: #22D6B5;
            z-index: 100;
        }
        
        .resize-handle-e {
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            cursor: e-resize;
        }
        
        .resize-handle-s {
            left: 0;
            bottom: 0;
            width: 100%;
            height: 4px;
            cursor: s-resize;
        }
        
        .resize-handle-se {
            right: 0;
            bottom: 0;
            width: 8px;
            height: 8px;
            cursor: se-resize;
            border-radius: 50%;
        }
        
        .component-controls {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .component-controls > div {
            pointer-events: auto;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-row.total {
            margin-top: 5px;
            padding-top: 10px;
            border-top: 2px solid #e2e8f0;
            font-weight: 700;
        }
        
        .summary-label {
            color: #64748b;
        }
        
        .summary-value {
            font-weight: 600;
        }
        
        .summary-value.borc {
            color: #b91c1c;
        }
        
        .summary-value.alacak {
            color: #15803d;
        }
        
        .summary-value.net-positive {
            color: #15803d;
        }
        
        .summary-value.net-negative {
            color: #b91c1c;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #052941;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .page-tabs-container {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .page-tabs {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;
        }

        .page-tab {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .page-tab.active {
            background: #007bff;
            color: white;
        }

        .page-tab .remove-page-tab {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
        }

        .add-page-tab {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .pages-container {
            position: relative;
        }

        .page-content {
            display: none;
            padding: 20px;
        }

        .page-content.active {
            display: block;
        }

        /* Şablon Seçici Stilleri */
        .template-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .template-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .template-item {
            cursor: pointer;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .template-item:hover {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.2);
        }

        .template-item img {
            width: 100%;
            height: auto;
            margin-bottom: 10px;
        }

        /* Bileşen Paneli Stilleri */
        .components-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #fff;
            border-left: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }

        .components-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .component-item {
            cursor: move;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            transition: all 0.3s;
        }

        .component-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .component-item i {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Sayfa İçeriği Stilleri */
        .page-content {
            min-height: 500px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
        }

        /* Sürükle-Bırak Alanı */
        .drop-zone {
            min-height: 100px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            margin: 10px 0;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .drop-zone.drag-over {
            border-color: #007bff;
            background: rgba(0,123,255,0.1);
        }

        /* Bileşen Boyutlandırma */
        .component-resize {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #007bff;
            border-radius: 50%;
        }

        .component-resize.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .component-resize.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .component-resize.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .component-resize.se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* Tablo Stilleri */
        .table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: #fff;
        }

        .table {
            width: 100%;
            margin-bottom: 0;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }

        .table th,
        .table td {
            padding: 3px;
            border: 1px solid #e9ecef;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            min-width: 100px;
        }

        .table th {
            background-color: var(--light-color);
            color: var(--dark-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .table tbody tr:nth-child(even) {
            background-color: var(--light-color);
        }

        .table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* İlerleme Grafiği */
        .progress-chart {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
        }

        /* Görev Tablosu */
        .task-table .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .task-table .status.completed {
            background-color: #d4edda;
            color: #155724;
        }

        .task-table .status.in-progress {
            background-color: #fff3cd;
            color: #856404;
        }

        .task-table .status.pending {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Personel Listesi */
        .staff-table .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .staff-table .department {
            font-size: 11px;
            color: #6c757d;
        }

        /* Puantaj Tablosu */
        .time-sheet-table .date {
            min-width: 100px;
        }

        .time-sheet-table .hours {
            text-align: center;
            min-width: 80px;
        }

        /* İzin Takibi */
        .leave-table .leave-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .leave-table .leave-type.annual {
            background-color: #cce5ff;
            color: #004085;
        }

        .leave-table .leave-type.sick {
            background-color: #fff3cd;
            color: #856404;
        }

        .leave-table .leave-type.other {
            background-color: #e2e3e5;
            color: #383d41;
        }

        /* Yazdırma Stilleri */
        @media print {
            /* UI Elementlerini Gizle */
            .row-controls,
            .column-controls,
            .row-resize-handle,
            .component-resize,
            .ui-draggable-handle,
            .ui-droppable,
            .drop-zone,
            .drop-text,
            .remove-page-tab,
            .add-page-tab,
            .action-btn,
            .grid-settings,
            .report-sidebar {
                display: none !important;
            }

            /* Sürükle-Bırak Göstergelerini Temizle */
            .ui-draggable,
            .ui-droppable {
                cursor: default !important;
            }

            /* Tablo Stillerini Düzenle */
            .table-container {
                page-break-inside: avoid;
                width: 100% !important;
                max-width: 100% !important;
                border: none !important;
            }
            
            .table {
                font-size: 10px;
                width: 100% !important;
                border-collapse: collapse;
            }
            
            .table th,
            .table td {
                padding: 3px;
                max-width: none !important;
                border: 1px solid #000 !important;
            }

            /* Rapor Container Stillerini Düzenle */
            .report-container {
                display: block !important;
                height: auto !important;
                padding: 0 !important;
                background: none !important;
            }

            .report-main {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }

            /* Bileşen Stillerini Düzenle */
            .component {
                page-break-inside: avoid;
                border: none !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
            }

            /* Grid Yapısını Düzenle */
            .report-row {
                page-break-inside: avoid;
                display: flex !important;
                margin-bottom: 20px !important;
            }

            .report-column {
                flex: 1 !important;
                page-break-inside: avoid;
            }

            /* Logo ve Başlık Stillerini Düzenle */
            .preview-header {
                margin-bottom: 20px !important;
            }

            .report-logo img {
                max-width: 200px !important;
            }

            .preview-title {
                font-size: 24px !important;
                margin-bottom: 10px !important;
            }

            .preview-subtitle {
                font-size: 14px !important;
                color: #000 !important;
            }
        }

        /* Header Stillerini Düzenle */
        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .report-logo {
            flex: 0 0 25%;
            text-align: left;
        }

        .report-logo img {
            max-height: 60px;
            max-width: 100%;
        }

        .report-info {
            flex: 0 0 50%;
            text-align: center;
        }

        .preview-title {
            font-size: 11px;
            font-weight: 600;
            color: #052941;
            margin-bottom: 5px;
            text-align: center;
            width: 100%;
        }

        .report-date-project {
            flex: 0 0 25%;
            text-align: right;
            font-size: 9px;
            color: #6c757d;
            display: flex;
            flex-direction: column;
        }

        .date-info, .project-info {
            margin-bottom: 3px;
        }

        /* Yazdırma Stillerini Düzenle */
        @media print {
            .preview-header {
                padding-bottom: 5mm;
                margin-bottom: 10mm;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
            }
            
            .report-logo {
                flex: 0 0 25% !important;
                text-align: left !important;
            }
            
            .report-logo img {
                max-height: 15mm !important;
                max-width: 100% !important;
            }
            
            .report-info {
                flex: 0 0 50% !important;
                text-align: center !important;
            }
            
            .preview-title {
                font-size: 11px !important;
                font-weight: 600 !important;
                color: #000 !important;
            }
            
            .report-date-project {
                flex: 0 0 25% !important;
                text-align: right !important;
                font-size: 9px !important;
                color: #000 !important;
                display: flex !important;
                flex-direction: column !important;
            }
        }

        .sidebar-section {
            padding: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-header {
            margin-bottom: 15px;
        }

        .section-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #052941;
            margin: 0;
        }

        /* Düzenlenebilir Metin Stili */
        .editable-text {
            width: 100%;
            min-height: 30px;
            padding: 10px;
            font-size: 11px;
            line-height: 1.5;
            color: #333;
            outline: none;
            border: none;
            background: transparent;
        }

        .editable-text:focus {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .editable-text:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }

        /* Minimal Tablo Stili */
        .minimal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 0;
            table-layout: fixed; /* Tablo genişliğini düzenli tutar */
        }

        /* Resizable sütun özellikleri */
        .minimal-table th {
            position: relative;
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            user-select: none; /* Metin seçimini engeller */
        }

        .minimal-table th .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background-color: transparent;
            cursor: col-resize;
            z-index: 10;
        }

        .minimal-table th .resizer:hover,
        .minimal-table th .resizing {
            background-color: #007bff;
        }

        /* div olarak kullanılan minimal-table */
        div.minimal-table {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            font-size: 11px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            background: #fff;
        }

        .minimal-table th,
        .minimal-table td {
            padding: 6px 8px;
            text-align: left;
            border: 1px solid #e9ecef;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%; /* Hücre genişliğini sınırlar */
        }

        .minimal-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .minimal-table tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Metni Komponenti Stil Düzenlemeleri */
        .editable-text-container {
            padding: 8px;
            width: 100%;
            height: 100%;
        }

        .editable-text {
            width: 100%;
            min-height: 30px;
            padding: 0;
            font-size: 11px;
            line-height: 1.5;
            color: #333;
            outline: none;
            border: none;
            background: transparent;
        }

        .editable-text:focus {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .editable-text:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }

        .text-component {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }

        /* Tablo container stili */
        .table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto; /* İçerik taşarsa yatay kaydırma çubuğu ekler */
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        /* Şablon seçici için stiller */
        .template-item {
            cursor: pointer;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 4px;
            background-color: #f5f5f5;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
        }

        .template-item:hover {
            background-color: #e9e9e9;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .template-item.active {
            background-color: #007bff;
            color: white;
            border-color: #0069d9;
        }

        /* Resizer için stiller */
        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            cursor: col-resize;
            z-index: 10;
        }

        .resizer.resizing {
            background: rgba(0, 0, 0, 0.5);
        }

        th {
            position: relative;
            min-width: 50px;
        }

        .template-selector-container {
            margin-bottom: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
        }

        .template-selector-container h4 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        .template-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .template-item {
            width: 120px;
            border: 2px solid #eee;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-item:hover {
            border-color: #007bff;
        }

        .template-item.selected {
            border-color: #007bff;
            background-color: #e9f5ff;
        }

        .template-preview {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .template-preview i {
            font-size: 32px;
            color: #666;
        }

        .template-title {
            font-size: 14px;
            font-weight: 500;
        }

        /* Report-charts stili */
        .report-charts {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            width: 100%;
        }
        
        .report-charts .report-card {
            grid-column: span 4; /* Her satırda 3 kart olacak şekilde */
        }
        
        /* İç içe kartlar için ek stil */
        .report-card .report-card {
            grid-column: span 4; /* İç içe kartlarda da 3 sütunlu düzen */
            width: 100%;
            margin: 0;
        }
        
        /* 2 ve 3 sütun seçenekleri için stiller */
        .report-charts[data-columns="2"] .report-card {
            grid-column: span 6 !important; /* 2 sütunlu düzen için */
        }
        
        .report-charts[data-columns="3"] .report-card {
            grid-column: span 4 !important; /* 3 sütunlu düzen için */
        }
        
        .card-body[data-columns="2"] > .report-card {
            grid-column: span 6 !important; /* 2 sütunlu düzen için */
        }
        
        .card-body[data-columns="3"] > .report-card {
            grid-column: span 4 !important; /* 3 sütunlu düzen için */
        }
        
        /* Sütun butonları için stil */
        .column-selector {
            display: flex;
            margin-right: 10px;
        }
        
        .column-btn {
            position: relative;
        }
        
        .column-btn span {
            font-size: 10px;
            position: absolute;
            bottom: 2px;
            right: 2px;
        }
        
        .two-col {
            margin-right: 5px;
        }
        
        /* Kart boyutlandırma için stiller */
        .report-card {
            position: relative;
            transition: box-shadow 0.2s ease;
            min-height: 100px;
        }
        
        .report-card.resizing {
            box-shadow: 0 0 15px rgba(34, 214, 181, 0.5);
            z-index: 100;
        }
        
        .card-resize-handle {
            position: absolute;
            background-color: rgba(34, 214, 181, 0.1);
            transition: background-color 0.2s ease, opacity 0.2s ease;
            opacity: 0;
            z-index: 10;
        }
        
        .report-card:hover .card-resize-handle {
            opacity: 1;
        }
        
        .card-resize-right {
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
        }
        
        .card-resize-left {
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
        }
        
        .card-resize-bottom {
            left: 0;
            bottom: 0;
            width: 100%;
            height: 8px;
            cursor: ns-resize;
        }
        
        .card-resize-corner {
            right: 0;
            bottom: 0;
            width: 16px;
            height: 16px;
            cursor: nwse-resize;
            background-color: rgba(34, 214, 181, 0.2);
            border-radius: 0 0 4px 0;
        }
        
        .card-resize-handle:hover {
            background-color: rgba(34, 214, 181, 0.3);
        }
        
        .card-resize-corner:hover {
            background-color: rgba(34, 214, 181, 0.5);
        }
        
        /* Masonry Grid Stilleri */
        .masonry-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: 1px; /* Otomatik satır boyutlandırma için */
            grid-auto-flow: dense; /* Boşlukları doldur */
        }
        
        /* Masonry grid içindeki kartların yüksekliği için */
        .masonry-grid .report-card {
            overflow: hidden;
            min-height: 100px;
            /* Kartın kenar boşluklarıyla birlikte yüksekliğini ayarla */
            margin-bottom: 15px;
        }
        
        /* Hide-in-pdf sınıfı için stil */
        .report-card.hide-in-pdf {
            opacity: 0.6;
            border: 1px dashed #ccc;
        }
        
        /* PDF çıktısı için gizleme */
        @media print {
            .hide-in-pdf {
                display: none !important;
            }
            
            .card-resize-handle, 
            .visibility-toggle {
                display: none !important;
            }
        }

        /* Kart boyutlandırma için stiller */
        .card-resize-handle {
            position: absolute;
            background-color: rgba(0, 123, 255, 0.2);
            z-index: 100;
        }
        
        .card-resize-right {
            cursor: ew-resize;
            width: 8px;
            height: calc(100% - 16px);
            right: 0;
            top: 8px;
        }
        
        .card-resize-bottom {
            cursor: ns-resize;
            height: 8px;
            width: calc(100% - 16px);
            bottom: 0;
            left: 8px;
        }
        
        .card-resize-corner {
            cursor: nwse-resize;
            width: 14px;
            height: 14px;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 123, 255, 0.4);
            border-radius: 0 0 4px 0;
        }
        
        .report-card {
            position: relative;
            min-height: 100px;
            transition: box-shadow 0.3s ease;
        }
        
        .report-card.resizing {
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            z-index: 200;
        }
        
        /* Masonry grid için stiller */
        .report-charts, .preview-grid, .card-body[data-columns] {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            width: 100%;
        }
        
        /* Şablon seçici için stiller */
        .template-item {
            cursor: pointer;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .template-item:hover {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }
        
        .template-item.selected, .template-item.active {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.4);
        }
        
        .template-preview {
            min-height: 100px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        
        .template-name {
            text-align: center;
            font-weight: bold;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
    </style>
{% endblock head %}
{% block sidebar %}
   <div class="report-container">
        <!-- Sol Panel -->
        <div class="report-sidebar">
            <div class="sidebar-scroll">
                <!-- Filtreler -->
                <div class="sidebar-section filters-section">
                    <div class="section-header">
                        <h3>Rapor Ayarları</h3>
                    </div>
                    <div class="filter-group">
                        <label>Tarih Aralığı</label>
                        <input type="text" id="dateRange" class="form-control " />
                    </div>
                    <div class="filter-group">
                        <label>Proje</label>
                        <select id="projectSelect" onchange="getValue()" class="form-control">
                            <option value="0">Tüm Projeler</option>
                            {% for i in santiyeler %}
                                <option value="{{i.id}}">{{i.proje_adi}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Bileşenler -->
                <div class="sidebar-section components-section">
                    <div class="section-header">
                        <h3>Bileşenler</h3>
                    </div>
                    
                    <!-- Şablon Seçici -->
                    <div class="sidebar-section template-selector">
                        <div class="section-header">
                            <h3>Şablon Seçici</h3>
                        </div>
                        <div id="template-list" class="template-grid">
                            <div class="template-item" data-template="bos">
                                <div class="template-preview">
                                    <i class="fas fa-file"></i>
                                </div>
                                <div class="template-name">Boş Şablon</div>
                            </div>
                            <div class="template-item" data-template="finansal">
                                <div class="template-preview">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <div class="template-name">Finansal Rapor</div>
                            </div>
                            <div class="template-item" data-template="proje">
                                <div class="template-preview">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <div class="template-name">Proje Raporu</div>
                            </div>
                            <div class="template-item" data-template="personel">
                                <div class="template-preview">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="template-name">Personel Raporu</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="components-container">
                        <!-- Finansal Bileşenler -->
                        <div class="component-group">
                            <div class="group-title">Finansal</div>
                            <div class="component-item" data-type="gelir-gider">
                                <div class="component-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">Gelir/Gider Analizi</div>
                                    <div class="component-desc">Aylık gelir ve gider karşılaştırması</div>
                                </div>
                            </div>
                            <div class="component-item" data-type="kasa-durumu">
                                <div class="component-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">Kasa Durumu</div>
                                    <div class="component-desc">Güncel kasa ve banka bakiyeleri</div>
                                </div>
                            </div>
                            <div class="component-item" data-type="borc-alacak">
                                <div class="component-icon">
                                    <i class="fas fa-hand-holding-usd"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">Borç/Alacak</div>
                                    <div class="component-desc">Borç ve alacak takibi</div>
                                </div>
                            </div>
                        </div>

                        <!-- Proje Bileşenleri -->
                        <div class="component-group">
                            <div class="group-title">Proje</div>
                            <div class="component-item" data-type="proje-ozeti">
                                <div class="component-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">Proje Özeti</div>
                                    <div class="component-desc">Genel proje durumu ve özet bilgiler</div>
                                </div>
                            </div>
                            <div class="component-item" data-type="ilerleme-grafik">
                                <div class="component-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">İlerleme Grafiği</div>
                                    <div class="component-desc">İş paketleri ilerleme durumu</div>
                                </div>
                            </div>
                            <div class="component-item" data-type="gorev-tablosu">
                                <div class="component-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">Görev Tablosu</div>
                                    <div class="component-desc">Detaylı görev listesi</div>
                                </div>
                            </div>
                        </div>

                        <!-- Personel Bileşenleri -->
                        <div class="component-group">
                            <div class="group-title">Personel</div>
                            <div class="component-item" data-type="personel-listesi">
                                <div class="component-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">Personel Listesi</div>
                                    <div class="component-desc">Aktif personel listesi</div>
                                </div>
                            </div>
                            <div class="component-item" data-type="puantaj">
                                <div class="component-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">Puantaj</div>
                                    <div class="component-desc">Çalışma süreleri ve mesailer</div>
                                </div>
                            </div>
                            <div class="component-item" data-type="izin-takip">
                                <div class="component-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="component-info">
                                    <div class="component-name">İzin Takibi</div>
                                    <div class="component-desc">İzin kullanımları ve bakiyeler</div>
                                </div>
                            </div>
                        </div>

                        <!-- Metin Bileşeni -->
                        <div class="component-item" data-type="metin">
                            <div class="component-icon">
                                <i class="fas fa-font"></i>
                            </div>
                            <div class="component-info">
                                <div class="component-name">Metin</div>
                                <div class="component-desc">Serbest metin ekleyin</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sağ Panel -->
        <div class="report-main">
            <!-- Üst Bar -->
            <div class="report-topbar">
                <!-- Sayfa Sekmeleri
                <div class="page-tabs-container">
                    <div class="page-tabs">
                        <div class="page-tab active" data-page="page-1">
                            <span>Sayfa 1</span>
                            <button class="remove-page-tab"><i class="fas fa-times"></i></button>
                        </div>
                        <button class="add-page-tab"><i class="fas fa-plus"></i></button>
                    </div>
                </div> -->
                
                <div class="report-actions">
                    <button class="action-btn" title="Temizle">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="action-btn" title="Kaydet">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="action-btn" onclick="openPageSettings()" title="Sayfa Ayarları">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="action-btn primary" onclick="window.reportManager.showPdfPreview()" title="PDF İndir">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>

            <!-- Önizleme -->
            <div class="preview-container">
                <div class="preview-header">
                    <div class="report-logo">
                        <img src="{% static 'go/content/images/biadalogo.png' %}" alt="Logo" class="logo">
                    </div>
                    <div class="report-info">
                        <div class="preview-title" contenteditable="true" data-placeholder="Rapor Başlığı">Proje Raporu</div>
                    </div>
                    <div class="report-date-project">
                        <div class="date-info">Tarih: <span id="reportDateRange">01.03.2024 - 31.03.2024</span></div>
                        <div class="project-info">Proje: <span id="reportProject">Tüm Projeler</span></div>
                    </div>
                </div>

                <!-- Rapor içeriği -->
                <div id="reportPreview" class="report-grid">
                    <!-- Şablon buraya yüklenecek -->
                </div>
            </div>
        </div>
    </div>

    <!-- Grid ayarları butonu -->
    <div class="grid-settings">
        <button class="grid-settings-btn" title="Grid Ayarları" onclick="window.reportManager.showGridSettings()">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <!-- Sayfa Ayarları Modal -->
    <div id="pageSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Sayfa Ayarları</h3>
                <button class="modal-close" onclick="closePageSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4 class="settings-title">Kenar Boşlukları</h4>
                    <div class="margin-inputs">
                        <div class="margin-input">
                            <span>Üst</span>
                            <input type="number" class="margin-control" data-margin="top" value="5" min="0" max="100">
                        </div>
                        <div class="margin-input">
                            <span>Alt</span>
                            <input type="number" class="margin-control" data-margin="bottom" value="5" min="0" max="100">
                        </div>
                        <div class="margin-input">
                            <span>Sol</span>
                            <input type="number" class="margin-control" data-margin="left" value="4" min="0" max="100">
                        </div>
                        <div class="margin-input">
                            <span>Sağ</span>
                            <input type="number" class="margin-control" data-margin="right" value="4" min="0" max="100">
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <h4 class="settings-title">Kağıt Boyutu</h4>
                    <select class="form-control" id="paperSize">
                        <option value="a4">A4</option>
                        <option value="a3">A3</option>
                        <option value="letter">Letter</option>
                    </select>
                </div>
                <div class="settings-section">
                    <h4 class="settings-title">Yönlendirme</h4>
                    <div class="orientation-options">
                        <label class="orientation-option">
                            <input type="radio" name="orientation" value="portrait" checked>
                            <span>Dikey</span>
                        </label>
                        <label class="orientation-option">
                            <input type="radio" name="orientation" value="landscape">
                            <span>Yatay</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button" onclick="closePageSettings()">İptal</button>
                <button class="button button-primary" onclick="savePageSettings()">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- PDF Önizleme Modalı -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>PDF Önizleme</h3>
                <button class="modal-close" onclick="closePdfPreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="pdfPreviewFrame" style="width: 100%; height: 500px;" frameborder="0"></iframe>
            </div>
            <div class="modal-footer">
                <button class="button" onclick="closePdfPreview()">Kapat</button>
                <button class="button button-primary" onclick="window.reportManager.exportToPDF()">PDF İndir</button>
            </div>
        </div>
    </div>

    <!-- Script sıralaması önemli -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <div>
        <!--DATALAR-->
            {% if request.user.kullanicilar_db %}
        {% ozellikler request.user.kullanicilar_db as ozellikleri %}      
        {% else %}
        {% ozellikler request.user as ozellikleri %}                                            
        {% endif %}
    </div>
    
    
    
<script>
    var santiye = "0";
    function getValue() {
        let selectedValue = document.getElementById("projectSelect").value;
        santiye = selectedValue;
    }
var tarih = "01.03.2024 - 31.03.2024";
class ReportManager {
    constructor() {
        this.currentReport = null;
        this.pdfMargins = [5, 4, 5, 4]; // Varsayılan değerler: Üst, Sağ, Alt, Sol
        this.init();
        this.bindEvents();
    }

    init() {
        this.initDatePicker();
        this.initDragAndDrop();
        this.initGridSystem();
    }

    initGridSystem() {
        // İlk row'u oluştur
        this.addRow();
    }

    addRow() {
        const row = $(`
            <div class="report-row">
                <div class="row-controls">
                    <button class="row-control-btn add-column" title="Kolon Ekle">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="row-control-btn remove-row" title="Satırı Sil">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="report-column">
                    <div class="column-controls">
                        <button class="column-control-btn remove-column" title="Kolonu Sil">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="drop-zone">
                        <span class="drop-text">Bileşen eklemek için sürükleyin</span>
                    </div>
                </div>
                <div class="row-resize-handle"></div>
            </div>
        `);

        $('#reportPreview').append(row);
        this.initializeRowControls(row);
        this.initializeDropZones();
    }

    addColumn(row) {
        const column = $(`
            <div class="report-column">
                <div class="column-controls">
                    <button class="column-control-btn remove-column" title="Kolonu Sil">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="drop-zone">
                    <span class="drop-text">Bileşen eklemek için sürükleyin</span>
                </div>
                <div class="column-resize-handle"></div>
            </div>
        `);

        row.append(column);
        this.initializeColumnControls(column);
        this.initializeDropZones();
    }

    initializeRowControls(row) {
        // Kolon ekleme
        row.find('.add-column').click(() => {
            this.addColumn(row);
        });

        // Row silme
        row.find('.remove-row').click(() => {
            if ($('.report-row').length > 1) {
                row.remove();
            }
        });

        // Row sürükle-bırak
        row.draggable({
            handle: '.row-controls',
            cursor: 'move',
            revert: true,
            zIndex: 1000
        });

        row.droppable({
            accept: '.report-row',
            drop: (event, ui) => {
                const draggedRow = ui.draggable;
                const targetRow = $(event.target).closest('.report-row');
                
                if (draggedRow.index() < targetRow.index()) {
                    targetRow.after(draggedRow);
                } else {
                    targetRow.before(draggedRow);
                }
            }
        });

        // Row boyutlandırma
        const resizeHandle = row.find('.row-resize-handle');
        let startY, startHeight;

        resizeHandle.on('mousedown', (e) => {
            startY = e.clientY;
            startHeight = row.height();
            $(document).on('mousemove', resizeRow);
            $(document).on('mouseup', stopResize);
        });

        const resizeRow = (e) => {
            const newHeight = startHeight + (e.clientY - startY);
            const minHeight = 100; // Minimum yükseklik
            const maxHeight = window.innerHeight - 200; // Maksimum yükseklik
            
            if (newHeight >= minHeight && newHeight <= maxHeight) {
                row.height(newHeight);
                
                // İçindeki komponentleri yeniden boyutlandır
                row.find('.report-card').each((_, card) => {
                    const cardHeight = newHeight - 40; // Padding ve margin'leri çıkar
                    $(card).height(cardHeight);
                });
            }
        };

        const stopResize = () => {
            $(document).off('mousemove', resizeRow);
            $(document).off('mouseup', stopResize);
        };
    }

    initializeColumnControls(column) {
        // Kolon silme
        column.find('.remove-column').click(() => {
            const row = column.closest('.report-row');
            if (row.find('.report-column').length > 1) {
                column.remove();
            } else {
                // Eğer son kolon ise, satırı da sil
                row.remove();
            }
        });

        // Kolon boyutlandırma
        const resizeHandle = column.find('.column-resize-handle');
        let startX, startWidth;

        resizeHandle.on('mousedown', (e) => {
            startX = e.clientX;
            startWidth = column.width();
            $(document).on('mousemove', resizeColumn);
            $(document).on('mouseup', stopResize);
        });

        const resizeColumn = (e) => {
            const newWidth = startWidth + (e.clientX - startX);
            const minWidth = 200; // Minimum genişlik
            const maxWidth = column.closest('.report-row').width() - 100; // Maksimum genişlik
            
            if (newWidth >= minWidth && newWidth <= maxWidth) {
                column.width(newWidth);
                
                // İçindeki komponentleri yeniden boyutlandır
                column.find('.report-card').each((_, card) => {
                    const cardWidth = newWidth - 20; // Padding'leri çıkar
                    $(card).width(cardWidth);
                });
            }
        };

        const stopResize = () => {
            $(document).off('mousemove', resizeColumn);
            $(document).off('mouseup', stopResize);
        };
    }

    bindEvents() {
        // Alt satır ekleme butonu
        $('.add-row-btn').click(() => {
            this.addRow();
        });

        // Grid ayarları butonu
        $('.grid-settings-btn').click(() => {
            this.showGridSettings();
        });

        // Row kontrolleri
        $(document).on('click', '.add-column', (e) => {
            const row = $(e.target).closest('.report-row');
            this.addColumn(row);
        });

        $(document).on('click', '.remove-row', (e) => {
            const row = $(e.target).closest('.report-row');
            if ($('.report-row').length > 1) {
                row.remove();
            }
        });

        // Kolon kontrolleri
        $(document).on('click', '.remove-column', (e) => {
            const column = $(e.target).closest('.report-column');
            const row = column.closest('.report-row');
            if (row.find('.report-column').length > 1) {
                column.remove();
            }
        });
    }

    showGridSettings() {
        const modal = $(`
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Grid Ayarları</h3>
                        <button class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Kolon Sayısı</label>
                            <select class="form-control" id="columnCount">
                                <option value="1">1 Kolon</option>
                                <option value="2">2 Kolon</option>
                                <option value="3">3 Kolon</option>
                                <option value="4">4 Kolon</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Boşluk (px)</label>
                            <input type="number" class="form-control" id="gridGap" value="20">
                        </div>
                        <div class="form-group">
                            <label>Satır Yüksekliği (px)</label>
                            <input type="number" class="form-control" id="rowHeight" value="100">
                        </div>
                        <div class="form-group">
                            <label>Kolon Genişliği (%)</label>
                            <input type="number" class="form-control" id="columnWidth" value="100">
                        </div>
                        <div class="form-group">
                            <label>Satır Ekle</label>
                            <div class="row-add-controls">
                                <button class="button" onclick="window.reportManager.addRow()">
                                    <i class="fas fa-plus"></i> Yeni Satır Ekle
                                </button>
                                <button class="button" onclick="window.reportManager.addRowWithColumns()">
                                    <i class="fas fa-plus"></i> Yeni Satır (2 Kolon)
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="button" onclick="$(this).closest('.modal').remove()">İptal</button>
                        <button class="button button-primary" onclick="window.reportManager.applyGridSettings()">Uygula</button>
                    </div>
                </div>
            </div>
        `);

        $('body').append(modal);
        modal.addClass('active');

        // Modal kapatma butonu
        modal.find('.modal-close').click(() => {
            modal.remove();
        });
    }

    addRowWithColumns() {
        const row = $(`
            <div class="report-row">
                <div class="row-controls">
                    <button class="row-control-btn add-column" title="Kolon Ekle">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="row-control-btn remove-row" title="Satırı Sil">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="report-column">
                    <div class="column-controls">
                        <button class="column-control-btn remove-column" title="Kolonu Sil">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="drop-zone">
                        <span class="drop-text">Bileşen eklemek için sürükleyin</span>
                    </div>
                </div>
                <div class="report-column">
                    <div class="column-controls">
                        <button class="column-control-btn remove-column" title="Kolonu Sil">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="drop-zone">
                        <span class="drop-text">Bileşen eklemek için sürükleyin</span>
                    </div>
                </div>
                <div class="row-resize-handle"></div>
            </div>
        `);

        $('#reportPreview').append(row);
        this.initializeRowControls(row);
        this.initializeDropZones();
    }

    applyGridSettings() {
        const columnCount = $('#columnCount').val();
        const gap = $('#gridGap').val();
        const rowHeight = $('#rowHeight').val();
        const columnWidth = $('#columnWidth').val();

        // Grid ayarlarını uygula
        $('.report-row').css({
            'gap': gap + 'px',
            'min-height': rowHeight + 'px'
        });

        $('.report-column').css({
            'flex': `0 0 ${columnWidth / columnCount}%`
        });

        // Modalı kapat
        $('.modal').remove();

        // Bildirim göster
        this.showNotification('Grid ayarları güncellendi');
    }

    initDatePicker() {
        $('#dateRange').daterangepicker({
            opens: 'left',
            locale: {
                format: 'DD.MM.YYYY',
                separator: ' - ',
                applyLabel: 'Uygula',
                cancelLabel: 'İptal',
                daysOfWeek: ['Pz', 'Pt', 'Sa', 'Ça', 'Pe', 'Cu', 'Ct'],
                monthNames: ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                    'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'],
                firstDay: 1
            },
            startDate: moment().startOf('month'),
            endDate: moment().endOf('month')
        }, (start, end) => {
            tarih = start.format('DD.MM.YYYY') + ' - ' + end.format('DD.MM.YYYY');
            $('#reportDateRange').text(start.format('DD.MM.YYYY') + ' - ' + end.format('DD.MM.YYYY'));
        });
    }

    initDragAndDrop() {
        $('.component-item').draggable({
            helper: 'clone',
            appendTo: 'body',
            zIndex: 1000,
            cursor: 'move'
        });

        this.initializeDropZones();
    }

    initializeDropZones() {
        $('.drop-zone').droppable({
            accept: '.component-item',
            hoverClass: 'drop-hover',
            drop: (event, ui) => {
                const type = $(ui.draggable).data('type');
                const component = this.createComponent(type);
                if (component) {
                    $(event.target).replaceWith(component);
                }
            }
        });
    }

    initTemplates() {
        $('.template-item').click((e) => {
            const templateType = $(e.currentTarget).data('template');
            
            $('.template-item').removeClass('selected');
            $(e.currentTarget).addClass('selected');
            
            this.loadTemplate(templateType);
        });
    }

    loadTemplate(type) {
        let template = '';
        
        switch(type) {
            case 'bos':
                template = `
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-card" data-size="full">
                                <div class="editable-text" contenteditable="true">
                                    <h2>Yeni Rapor</h2>
                                    <p>Rapor içeriğini düzenlemek için tıklayın. Sol menüden bileşenler ekleyebilirsiniz.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'finansal':
                template = `
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-card" data-size="full">
                                <div class="editable-text" contenteditable="true">
                                    <h2>Finansal Durum Raporu</h2>
                                    <p>${$('#reportDateRange').text() || 'Tarih aralığı seçilmedi'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-card" data-size="medium">
                                <div class="editable-text" contenteditable="true">
                                    <h3>Gelir/Gider Özeti</h3>
                                </div>
                                <div class="drop-zone">
                                    <span class="drop-text">Gelir/gider grafiği eklemek için sürükleyin</span>
                                </div>
                            </div>
                        </div>
                        <div class="report-column">
                            <div class="report-card" data-size="medium">
                                <div class="editable-text" contenteditable="true">
                                    <h3>Kasa Durumu</h3>
                                </div>
                                <div class="drop-zone">
                                    <span class="drop-text">Kasa durumu tablosu eklemek için sürükleyin</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-card" data-size="full">
                                <div class="editable-text" contenteditable="true">
                                    <h3>Finansal Tablo</h3>
                                </div>
                                <div class="drop-zone">
                                    <span class="drop-text">Finansal tablo eklemek için sürükleyin</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'proje':
                template = `
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-card" data-size="full">
                                <div class="editable-text" contenteditable="true">
                                    <h2>Proje İlerleme Raporu</h2>
                                    <p>${$('#reportDateRange').text() || 'Tarih aralığı seçilmedi'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-card" data-size="large">
                                <div class="editable-text" contenteditable="true">
                                    <h3>Proje Durumu</h3>
                                </div>
                                <div class="drop-zone">
                                    <span class="drop-text">Proje durum grafiği eklemek için sürükleyin</span>
                                </div>
                            </div>
                        </div>
                        <div class="report-column">
                            <div class="report-card" data-size="small">
                                <div class="editable-text" contenteditable="true">
                                    <h3>Görev Dağılımı</h3>
                                </div>
                                <div class="drop-zone">
                                    <span class="drop-text">Görev grafiği eklemek için sürükleyin</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
        }
        
        $('#reportPreview').html(template);
        this.initializeDropZones();
        this.setupComponentControls();
    }

    updatePdfMargins(margins) {
        this.pdfMargins = margins;
        console.log('PDF kenar boşlukları güncellendi:', this.pdfMargins);
    }

    showPdfPreview() {
        const modal = document.getElementById('pdfPreviewModal');
        const pdfPreviewFrame = document.getElementById('pdfPreviewFrame');
        modal.classList.add('active');

        // Loading göster
        const loadingEl = $('<div class="loading">PDF oluşturuluyor...</div>');
        $(pdfPreviewFrame).parent().append(loadingEl);

        // PDF ayarları
        const opt = {
            margin: this.pdfMargins, // Güncellenmiş kenar boşluklarını kullan
            filename: 'rapor.pdf',
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                allowTaint: true,
                scrollY: 0,
                onclone: function(clonedDoc) {
                    // Hide-in-pdf sınıfına sahip kartları gizle
                    $(clonedDoc).find('.report-card.hide-in-pdf').css('display', 'none');
                    
                    // UI Elementlerini Gizle
                    $(clonedDoc).find('.row-controls, .column-controls, .row-resize-handle, .component-resize, .ui-draggable-handle, .drop-zone, .drop-text, .remove-page-tab, .add-page-tab, .action-btn, .grid-settings, .report-sidebar, .card-resize-handle, .card-visibility-toggle').hide();
                    
                    // Sürükle bırak sınıflarını kaldır
                    $(clonedDoc).find('.ui-draggable, .ui-droppable, .ui-resizable').removeClass('ui-draggable ui-droppable ui-resizable ui-draggable-handle');
                    
                    // Satır ve sütun çizgilerini kaldır
                    $(clonedDoc).find('.report-row').css({
                        'border': 'none',
                        'box-shadow': 'none',
                        'background': 'none',
                        'margin-bottom': '10px'
                    });
                    
                    $(clonedDoc).find('.report-column').css({
                        'border': 'none',
                        'box-shadow': 'none',
                        'background': 'none'
                    });
                    
                    // Bileşen stillerini düzenle
                    $(clonedDoc).find('.component').css({
                        'border': 'none',
                        'box-shadow': 'none',
                        'margin-bottom': '10px'
                    });
                    
                    // Düzenlenebilir metin bileşenlerini düzenle
                    $(clonedDoc).find('.editable-text').css({
                        'font-size': '11px',
                        'line-height': '1.5',
                        'color': '#000',
                        'padding': '0',
                        'background': 'none'
                    }).attr('contenteditable', 'false');
                    
                    
                    // Minimal tablo stillerini uygula
                    $(clonedDoc).find('.minimal-table').css({
                        'width': '100%',
                        'border-collapse': 'collapse',
                        'font-size': '10px',
                        'table-layout': 'fixed'
                    });
                    
                    $(clonedDoc).find('.minimal-table th').css({
                        'background-color': '#f5f5f5',
                        'padding': '5px',
                        'text-align': 'left',
                        'font-weight': 'bold',
                        'border-bottom': '1px solid #ddd',
                        'overflow': 'hidden',
                        'text-overflow': 'ellipsis',
                        'white-space': 'nowrap'
                    });
                    
                    $(clonedDoc).find('.minimal-table td').css({
                        'padding': '4px',
                        'border-bottom': '1px solid #eee',
                        'overflow': 'hidden',
                        'text-overflow': 'ellipsis',
                        'white-space': 'nowrap'
                    });
                    
                    // Card elementlerini düzenle
                    $(clonedDoc).find('.card-actions, .component-controls, .card-header').remove();
                    
                    // Header stillerini düzenle
                    $(clonedDoc).find('.preview-header').css({
                        'display': 'flex',
                        'align-items': 'center',
                        'justify-content': 'space-between',
                        'margin-bottom': '20mm',
                        'padding-bottom': '5mm',
                        'border-bottom': '1px solid #000'
                    });

                    $(clonedDoc).find('.report-logo').css({
                        'flex': '0 0 25%',
                        'text-align': 'left'
                    });

                    $(clonedDoc).find('.report-logo img').css({
                        'max-height': '15mm',
                        'max-width': '100%'
                    });

                    $(clonedDoc).find('.report-info').css({
                        'flex': '0 0 50%',
                        'text-align': 'center'
                    });

                    $(clonedDoc).find('.preview-title').css({
                        'font-size': '11px',
                        'font-weight': 'bold',
                        'color': '#000',
                        'margin-bottom': '0',
                        'text-align': 'center',
                        'width': '100%'
                    });

                    $(clonedDoc).find('.report-date-project').css({
                        'flex': '0 0 25%',
                        'text-align': 'right',
                        'font-size': '9px',
                        'color': '#000',
                        'display': 'flex',
                        'flex-direction': 'column'
                    });
                }
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4',
                orientation: 'portrait'
            }
        };

        // Gereksiz elementleri gizle
        $('.card-actions, .component-controls, .report-topbar, .report-sidebar').hide();

        // PDF oluştur
        html2pdf()
            .from(document.querySelector('.preview-container'))
            .set(opt)
            .outputPdf('datauristring')
            .then(uri => {
                // Gizlenen elementleri geri göster
                $('.card-actions, .component-controls, .report-topbar, .report-sidebar').show();
                
                pdfPreviewFrame.src = uri;
                loadingEl.remove();
            })
            .catch(err => {
                // Hata durumunda da gizlenen elementleri geri göster
                $('.card-actions, .component-controls, .report-topbar, .report-sidebar').show();
                
                console.error('PDF oluşturma hatası:', err);
                loadingEl.text('PDF oluşturulurken bir hata oluştu');
            });
    }

    exportToPDF() {
        const element = document.querySelector('.preview-container');
        const paperSize = $('#paperSize').val() || 'a4';
        const orientation = $('input[name="orientation"]:checked').val() || 'portrait';

        // PDF ayarları
        const opt = {
            margin: this.pdfMargins, // Güncellenmiş kenar boşluklarını kullan
            filename: `${this.currentReport?.name || 'rapor'}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                logging: false,
                onclone: function(clonedDoc) {
                    // Hide-in-pdf sınıfına sahip kartları gizle
                    $(clonedDoc).find('.report-card.hide-in-pdf').css('display', 'none');
                    
                    // UI Elementlerini Gizle
                    $(clonedDoc).find('.row-controls, .column-controls, .row-resize-handle, .component-resize, .ui-draggable-handle, .drop-zone, .drop-text, .remove-page-tab, .add-page-tab, .action-btn, .grid-settings, .report-sidebar, .card-resize-handle, .card-visibility-toggle').hide();
                    
                    // Sürükle bırak sınıflarını kaldır
                    $(clonedDoc).find('.ui-draggable, .ui-droppable, .ui-resizable').removeClass('ui-draggable ui-droppable ui-resizable ui-draggable-handle');
                    
                    // Satır ve sütun çizgilerini kaldır
                    $(clonedDoc).find('.report-row').css({
                        'border': 'none',
                        'box-shadow': 'none',
                        'background': 'none',
                        'margin-bottom': '10px'
                    });
                    
                    $(clonedDoc).find('.report-column').css({
                        'border': 'none',
                        'box-shadow': 'none',
                        'background': 'none'
                    });
                    
                    // Bileşen stillerini düzenle
                    $(clonedDoc).find('.component').css({
                        'border': 'none',
                        'box-shadow': 'none',
                        'margin-bottom': '10px'
                    });
                    
                    // Düzenlenebilir metin bileşenlerini düzenle
                    $(clonedDoc).find('.editable-text').css({
                        'font-size': '11px',
                        'line-height': '1.5',
                        'color': '#000',
                        'padding': '0',
                        'background': 'none'
                    }).attr('contenteditable', 'false');

                    // Minimal tablo stillerini uygula
                    $(clonedDoc).find('.minimal-table').css({
                        'width': '100%',
                        'border-collapse': 'collapse',
                        'font-size': '10px',
                        'table-layout': 'fixed'
                    });
                    
                    $(clonedDoc).find('.minimal-table th').css({
                        'background-color': '#f5f5f5',
                        'padding': '5px',
                        'text-align': 'left',
                        'font-weight': 'bold',
                        'border-bottom': '1px solid #ddd',
                        'overflow': 'hidden',
                        'text-overflow': 'ellipsis',
                        'white-space': 'nowrap'
                    });
                    
                    $(clonedDoc).find('.minimal-table td').css({
                        'padding': '4px',
                        'border-bottom': '1px solid #eee',
                        'overflow': 'hidden',
                        'text-overflow': 'ellipsis',
                        'white-space': 'nowrap'
                    });

                    // Metin bileşenlerini düzenle
                    $(clonedDoc).find('.report-card[data-type="metin"]').each(function() {
                        const cardBody = $(this).find('.card-body');
                        const textContent = cardBody.find('.text-content').html();
                        
                        // Kartı sadece içerik ile değiştir
                        $(this).replaceWith(`<div class="text-content">${textContent}</div>`);
                    });

                    // Tüm kartlardan card-header'ları kaldır
                    $(clonedDoc).find('.card-header, .card-actions, .component-controls').remove();
                    
                    // Header stillerini düzenle
                    $(clonedDoc).find('.preview-header').css({
                        'display': 'flex',
                        'align-items': 'center',
                        'justify-content': 'space-between',
                        'margin-bottom': '20mm',
                        'padding-bottom': '5mm',
                        'border-bottom': '1px solid #000'
                    });

                    $(clonedDoc).find('.report-logo').css({
                        'flex': '0 0 25%',
                        'text-align': 'left'
                    });

                    $(clonedDoc).find('.report-logo img').css({
                        'max-height': '15mm',
                        'max-width': '100%'
                    });

                    $(clonedDoc).find('.report-info').css({
                        'flex': '0 0 50%',
                        'text-align': 'center'
                    });

                    $(clonedDoc).find('.preview-title').css({
                        'font-size': '11px',
                        'font-weight': 'bold',
                        'color': '#000',
                        'margin-bottom': '0',
                        'text-align': 'center',
                        'width': '100%'
                    });

                    $(clonedDoc).find('.report-date-project').css({
                        'flex': '0 0 25%',
                        'text-align': 'right',
                        'font-size': '9px',
                        'color': '#000',
                        'display': 'flex',
                        'flex-direction': 'column'
                    });

                    $(clonedDoc).find('.report-card').css({
                        'page-break-inside': 'avoid',
                        'margin-bottom': '15mm',
                        'border': 'none',
                        'box-shadow': 'none'
                    });
                }
            },
            jsPDF: { 
                unit: 'mm', 
                format: paperSize,
                orientation: orientation
            }
        };

        // Loading göster
        const loadingEl = $('<div class="loading-overlay"><div class="loading">PDF indiriliyor...</div></div>');
        $('body').append(loadingEl);

        // PDF'yi oluştur ve indir
        html2pdf().set(opt).from(element).save().then(() => {
            loadingEl.remove();
            this.showNotification('PDF başarıyla indirildi');
            closePdfPreview();
        }).catch(err => {
            console.error('PDF indirme hatası:', err);
            loadingEl.remove();
            this.showNotification('PDF oluşturulurken bir hata oluştu', 'error');
        });
    }

    bindEvents() {
        // PDF export
        $('#exportPDFBtn').click(() => this.showPdfPreview());
        
        // Proje seçimi
        $('#projectSelect').change(() => {
            const projectName = $('#projectSelect option:selected').text();
            $('#reportProject').text(projectName || 'Tüm Projeler');
        });

        // Yeni event'ler
        $('.action-btn[title="Temizle"]').click(() => this.showClearConfirm());
        $('.action-btn[title="Kaydet"]').click(() => this.showSaveForm());
    }

    showClearConfirm() {
        const modal = $(`
            <div class="modal confirm-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Raporu Temizle</h3>
                        <button class="modal-close" onclick="$(this).closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Raporu temizlemek istediğinize emin misiniz?</p>
                        <p>Bu işlem geri alınamaz.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="button" onclick="$(this).closest('.modal').remove()">İptal</button>
                        <button class="button button-primary" onclick="window.reportManager.clearReport()">Temizle</button>
                    </div>
                </div>
            </div>
        `);

        $('body').append(modal);
        modal.addClass('active');
    }

    clearReport() {
        // Rapor içeriğini temizle
        $('#reportPreview').html(`
            <div class="drop-zone" data-size="full">
                <span class="drop-text">Bileşen eklemek için sürükleyin</span>
            </div>
        `);

        // Drop zone'ları yeniden aktifleştir
        this.initializeDropZones();

        // Modalı kapat
        $('.confirm-modal').remove();

        // Bildirim göster
        this.showNotification('Rapor temizlendi');
    }

    showSaveForm() {
        const modal = $(`
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Raporu Kaydet</h3>
                        <button class="modal-close" onclick="$(this).closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Rapor Adı</label>
                            <input type="text" class="form-control" id="reportNames" >
                        </div>
                        <div class="form-group">
                            <label>Açıklama</label>
                            <textarea class="form-control" id="reportDescriptions"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="button" onclick="$(this).closest('.modal').remove()">İptal</button>
                        <button class="button button-primary" onclick="saveReport()">Kaydet</button>
                    </div>
                </div>
            </div>
        `);

        $('body').append(modal);
        modal.addClass('active');
    }


    showNotification(message) {
        const notification = $(`
            <div class="notification">
                <i class="icon icon-check"></i>
                <span>${message}</span>
            </div>
        `);

        $('body').append(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    createComponent(type) {
        let component;
        
        switch(type) {
            case 'gelir-gider':
                component = $(`
                    <div class="report-card" data-size="medium">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Gelir/Gider Analizi
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn remove" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="gelirGiderChart"></div>
                        </div>
                        <div class="resize-handle resize-handle-e"></div>
                        <div class="resize-handle resize-handle-s"></div>
                        <div class="resize-handle resize-handle-se"></div>
                    </div>
                `);
                    setTimeout(() => {
                    new ApexCharts(component.find('#gelirGiderChart')[0], {
                        series: [{
                            name: 'Gelir',
                            data: {{ozellikleri.gelir | safe }}
                        }, {
                            name: 'Gider',
                            data: {{ozellikleri.gider | safe }}
                        }],
                        chart: {
                            type: 'area',
                            height: 250,
                            toolbar: { show: false }
                        },
                        colors: ['#22D6B5', '#FF4560'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.7,
                                opacityTo: 0.2
                            }
                        },
                        dataLabels: { enabled: false },
                        stroke: { curve: 'smooth', width: 2 },
                        xaxis: {
                            categories: {{ozellikleri.aylar | safe }}
                        }
                    }).render();
                }, 100);

                // Boyutlandırma işlevselliği
                this.initializeResizeHandles(component);
                
                // ... rest of the component code ...
                break;

            case 'kasa-durumu':
                component = $(`
                    <div class="report-card" data-size="small">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-wallet"></i>
                                Kasa Durumu
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn remove" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="kasa-select-wrapper">
                                <select class="kasa-select form-control">
                                    <option value="">Kasa Seçin</option>
                                    {% for i in kasa %}
                                        <option value="{{i.id}}">{{i.kasa_adi}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="kasa-info-box">
                                <div class="info-box-content">
                                    <div class="info-box-title">Bakiye</div>
                                    <div class="info-box-value">$ <span class="bakiye-value">0</span></div>
                                </div>
                                <div class="info-box-footer">
                                    <div class="son-islem">
                                        <small>Son İşlem: <span class="son-islem-text">-</span></small>
                                    </div>
                                    <button class="info-box-btn toggle-movements" title="Hareketleri Göster">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="kasa-hareketleri" style="display: none;">
                                <div class="hareketler-header">
                                    <h5>Son Hareketler</h5>
                                </div>
                                <div class="hareketler-list"></div>
                            </div>
                        </div>

                        <style>
                            .kasa-select-wrapper {
                                margin-bottom: 15px;
                            }
                            .kasa-info-box {
                                background: #fff;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                padding: 15px;
                                transition: all 0.3s ease;
                            }
                            .kasa-info-box:hover {
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            }
                            .info-box-title {
                                color: #666;
                                font-size: 14px;
                                margin-bottom: 5px;
                            }
                            .info-box-value {
                                color: #052941;
                                font-size: 24px;
                                font-weight: 600;
                            }
                            .info-box-footer {
                                margin-top: 10px;
                                padding-top: 10px;
                                border-top: 1px solid #e0e0e0;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .son-islem {
                                color: #666;
                                font-size: 12px;
                            }
                            .info-box-btn {
                                background: none;
                                border: none;
                                color: #666;
                                cursor: pointer;
                                padding: 5px;
                                border-radius: 4px;
                                transition: all 0.2s ease;
                            }
                            .info-box-btn:hover {
                                background: #f0f0f0;
                                color: #052941;
                            }
                            .kasa-hareketleri {
                                margin-top: 15px;
                                padding: 15px;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                            }
                            .hareketler-header {
                                margin-bottom: 10px;
                            }
                            .hareketler-header h5 {
                                color: #052941;
                                font-size: 14px;
                                margin: 0;
                            }
                            .hareket-item {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 8px 0;
                                border-bottom: 1px solid #e0e0e0;
                            }
                            .hareket-item:last-child {
                                border-bottom: none;
                            }
                            .hareket-aciklama {
                                flex: 1;
                                font-size: 13px;
                                color: #333;
                            }
                            .hareket-tutar {
                                font-weight: 500;
                                margin-left: 15px;
                            }
                            .hareket-tutar.gelir {
                                color: #22D6B5;
                            }
                            .hareket-tutar.gider {
                                color: #FF4560;
                            }
                        </style>
                        
                        <div class="component-controls">
                            <div class="resize-handle-e"></div>
                            <div class="resize-handle-s"></div>
                            <div class="resize-handle-se"></div>
                         </div>
                    </div>
                `);

                // Tarih seçici başlat
                component.find('.date-filter').daterangepicker({
                    opens: 'left',
                    locale: {
                        format: 'DD.MM.YYYY',
                        separator: ' - ',
                        applyLabel: 'Uygula',
                        cancelLabel: 'İptal',
                        daysOfWeek: ['Pz', 'Pt', 'Sa', 'Ça', 'Pe', 'Cu', 'Ct'],
                        monthNames: ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                            'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'],
                        firstDay: 1
                    },
                    startDate: moment().startOf('month'),
                    endDate: moment().endOf('month')
                });

                // Kasa seçimi değiştiğinde
                component.find('.kasa-select').change(function() {
                    const kasaId = $(this).val();
                    if (!kasaId) return;

                    // Seçilen kasanın bilgilerini getir
                    $.get(`/tr/accounting/kasa_bilgileri/${kasaId}`, function(data) {
                        component.find('.bakiye-value').text(data.bakiye);
                        component.find('.son-islem-text').text(data.son_islem || '-');

                        // Hareketleri güncelle
                        const hareketlerList = component.find('.hareketler-list');
                        hareketlerList.empty();

                        data.hareketler.slice(0, 5).forEach(hareket => {
                            const hareketItem = $(`
                                <div class="hareket-item">
                                    <div class="hareket-aciklama">${hareket.aciklama}</div>
                                    <div class="hareket-tutar ${hareket.tip === 'gelir' ? 'gelir' : 'gider'}">
                                        ${hareket.tip === 'gelir' ? '+' : '-'} $${hareket.tutar}
                                    </div>
                                </div>
                            `);
                            hareketlerList.append(hareketItem);
                        });
                    }).fail(function() {
                        alert('Kasa bilgileri alınırken bir hata oluştu.');
                    });
                });

                // Hareketleri göster/gizle
                component.find('.toggle-movements').click(function() {
                    const hareketler = component.find('.kasa-hareketleri');
                    const icon = $(this).find('i');
                    
                    if (hareketler.is(':visible')) {
                        hareketler.slideUp();
                        icon.removeClass('fa-eye-slash').addClass('fa-eye');
                        $(this).attr('title', 'Hareketleri Göster');
                    } else {
                        hareketler.slideDown();
                        icon.removeClass('fa-eye').addClass('fa-eye-slash');
                        $(this).attr('title', 'Hareketleri Gizle');
                    }
                });

                break;

            case 'borc-alacak':
                component = $(`
                    <div class="report-card" data-size="medium">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-hand-holding-usd"></i>
                                Borç/Alacak
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn refresh" title="Yenile">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="card-action-btn remove" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="borc-alacak-filters">
                                <div class="filter-row">
                                    <div class="filter-group">
                                        <label>Tarih Aralığı</label>
                                        <input type="text" class="form-control date-filter" />
                                    </div>
                                    <div class="filter-group">
                                        <label>Kayıt Sayısı</label>
                                        <select class="form-control record-count">
                                            <option value="5">5 Kayıt</option>
                                            <option value="10" selected>10 Kayıt</option>
                                            <option value="20">20 Kayıt</option>
                                            <option value="50">50 Kayıt</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="filter-row">
                                    <div class="filter-group">
                                        <label>Tür</label>
                                        <select class="form-control type-filter">
                                            <option value="all">Tümü</option>
                                            <option value="borc">Borçlar</option>
                                            <option value="alacak">Alacaklar</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <button class="apply-filters-btn">Uygula</button>
                                    </div>
                                </div>
                            </div>
                            <div class="borc-alacak-content">
                                <table class="minimal-table">
                                    <thead>
                                        <tr>
                                            
                                            <th>Cari</th>
                                            <th>Açıklama</th>
                                            <th>Bakiye</th>
                                            <th>Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody class="cari-data-tbody">
                                        
                                    </tbody>
                                </table>
                            </div>
                            <div class="borc-alacak-summary">
                                <div class="summary-row">
                                    <div class="summary-label">Toplam Borç:</div>
                                    <div class="summary-value borc" id="total-borc">0 ₺</div>
                                </div>
                                <div class="summary-row">
                                    <div class="summary-label">Toplam Alacak:</div>
                                    <div class="summary-value alacak" id="total-alacak">0 ₺</div>
                                </div>
                                <div class="summary-row total">
                                    <div class="summary-label">Net Durum:</div>
                                    <div class="summary-value" id="net-durum">0 ₺</div>
                                </div>
                            </div>
                        </div>
                        <div class="component-controls">
                            <div class="resize-handle-e"></div>
                            <div class="resize-handle-s"></div>
                            <div class="resize-handle-se"></div>
                        </div>
                    </div>
                `);
                
                // Tarih seçici başlat
                component.find('.date-filter').daterangepicker({
                    opens: 'left',
                    locale: {
                        format: 'DD.MM.YYYY',
                        separator: ' - ',
                        applyLabel: 'Uygula',
                        cancelLabel: 'İptal',
                        daysOfWeek: ['Pz', 'Pt', 'Sa', 'Ça', 'Pe', 'Cu', 'Ct'],
                        monthNames: ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                            'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'],
                        firstDay: 1
                    },
                    startDate: moment().startOf('month'),
                    endDate: moment().endOf('month')
                });
                
                // Filtre uygulama butonu olayı
                component.find('.apply-filters-btn').click(function() {
                    // AJAX ile verileri filtrele
                    const dateRange = component.find('.date-filter').val();
                    const recordCount = component.find('.record-count').val();
                    const type = component.find('.type-filter').val();
                    
                    component.find('.card-title').append('<span class="loading-spinner"></span>');
                    
                    // AJAX isteği
                    $.ajax({
                        url: '/tr/accounting/cari_bilgileri_alma/',
                        type: 'GET',
                        data: {
                            date_range: dateRange,
                            record_count: recordCount,
                            type: type,
                            santiye: santiye
                        },
                        success: function(response) {
                            console.log(response);
                            // Başarılı olursa tabloyu güncelle
                            component.find('.cari-data-tbody').html(response.html);
                            console.log(response.html);
                            // Toplam değerleri güncelle
                            $('#total-borc').text(response.total_borc + ' ₺');
                            $('#total-alacak').text(response.total_alacak + ' ₺');
                            
                            const netDurum = response.net_durum;
                            const netDurumEl = $('#net-durum');
                            
                            netDurumEl.text((netDurum >= 0 ? '+' : '') + netDurum + ' ₺');
                            
                            if (netDurum >= 0) {
                                netDurumEl.removeClass('net-negative').addClass('net-positive');
                            } else {
                                netDurumEl.removeClass('net-positive').addClass('net-negative');
                            }
                            
                            component.find('.loading-spinner').remove();
                        },
                        error: function(error) {
                            console.error('Veri yükleme hatası:', error);
                            component.find('.loading-spinner').remove();
                            alert('Veriler yüklenirken bir hata oluştu');
                        }
                    });
                });
                
                // Yenile butonu olayı
                component.find('.refresh').click(function() {
                    component.find('.apply-filters-btn').click();
                });
                
                // Sayfa yüklendiğinde özet bilgileri hesapla
                setTimeout(function() {
                    let totalBorc = 0;
                    let totalAlacak = 0;
                    
                    component.find('.cari-data-tbody tr').each(function() {
                        const amountText = $(this).find('.amount-col').text();
                        const amount = parseFloat(amountText.replace('₺', '').trim());
                        
                        if ($(this).hasClass('borc-row')) {
                            totalBorc += Math.abs(amount);
                        } else if ($(this).hasClass('alacak-row')) {
                            totalAlacak += amount;
                        }
                    });
                    
                    $('#total-borc').text(totalBorc.toFixed(2) + ' ₺');
                    $('#total-alacak').text(totalAlacak.toFixed(2) + ' ₺');
                    
                    const netDurum = totalAlacak - totalBorc;
                    const netDurumEl = $('#net-durum');
                    
                    netDurumEl.text((netDurum >= 0 ? '+' : '') + netDurum.toFixed(2) + ' ₺');
                    
                    if (netDurum >= 0) {
                        netDurumEl.removeClass('net-negative').addClass('net-positive');
                    } else {
                        netDurumEl.removeClass('net-positive').addClass('net-negative');
                    }
                }, 500);
                
                break;

            case 'proje-ozeti':
    component = $(`
        <div class="report-card" data-size="large" data-type="proje-ozeti">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-clipboard-list"></i>
                    Proje Özeti
                </div>
                <div class="card-actions">
                    <button class="card-action-btn size-down" title="Küçült">
                        <i class="icon icon-minus"></i>
                    </button>
                    <button class="card-action-btn size-up" title="Büyült">
                        <i class="icon icon-plus"></i>
                    </button>
                    <button class="card-action-btn remove" title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
                {% for santiye in bloklar %}
                {% bloglar_daireleri_kalemleri_fiziksel_bilgilerii santiye.id as fiziksel_ilerlemei  %}
                {%  bloglari_rapora_yansitma santiye.proje_santiye_Ait as blog %}
                {% bloglar_daireleri_kalemleri_fiziksel_bilgileri santiye.id blog.k as fiziksel_ilerleme  %}
                {% bloglar_daireleri_kalemleri_finansal_bilgileri santiye.id blog.k as finansal_ilerleme  %}
                {% bloglar_daireleri_kalemleri_fiziksel_bilgileri_toplama_gonderme santiye.id blog.k as tablo  %}
                    {% get_son_bir_hafta_icinde_degisenler santiye.id  as gun_kalem_sayilari  %}
                    {% get_yil_icinde_degisenler santiye.id  as ay_kalem_sayilari  %}
                    {% to_int santiye.kat_sayisi as kat_bilgisi %}
                    <div class="card-body" id="ilerleme_isleri{{santiye.id}}" style="display:none;">
                <div id="ilerleme{{santiye.id}}" class="report-charts" style="display: none;">

                    <div class="report-card">
                        <div class="report-header">
                            <div class="report-title">{% trans 'İlerleme' %}</div>
                            <div class="report-stats-info">
                                <span><i class="icon icon-purple-circle"></i> {% trans 'Fiziksel' %} </span>
                                <span><i class="icon icon-yellow-circle"></i> {% trans 'Finansal' %}</span>
                            </div>
                        </div>

                        <div class="report-body">
                            <div id="ilerleme-chart{{santiye.id}}"></div>

                        </div>
                    </div>
                </div>
              <div id="ay_ilerleme{{santiye.id}}" class="report-card" >
                <div class="report-header">
                    <div class="report-title">{% trans 'İlerleme Tablosu' %}</div>
                    <div class="report-stats-info">
                        <span><i class="icon icon-purple-circle"></i> {% trans 'Fiziksel' %} </span>
                        <span><i class="icon icon-yellow-circle"></i>  {% trans 'Finansal' %}</span>
                    </div>
                </div>
                <div class="report-body">

                    <div id="ilerleme-tablosu-chart{{santiye.id}}"></div>


                </div>
            </div>
            <div id="genel_ilerleme{{santiye.id}}" class="report-card" >
                <div class="report-header">
                    <div class="report-details">
                        <div class="report-title"><i class="icon icon-yellow-circle"></i>  {{santiye.proje_santiye_Ait.proje_tipi.Proje_tipi_adi}}</div>
                        <div class="report-infos">
                            <div class="report-info">{% trans 'Proje Adı:' %}  <b>{{santiye.proje_santiye_Ait.proje_adi}}</b></div>
                            <div class="report-info">{% trans 'Yapı Adı:' %} <b>{{santiye.blog_adi}}</b></div>
                        </div>
                    </div>
                </div>

             <div class="report-building-body">
                <div class="report-bb-preview">
                        <div class="building-container-report">
                            <div class="building-report" id="building-report">
                                <div class="face-report" id="face1"></div>
                                <div class="face-report" id="face2"></div>
                                <div class="face-report" id="face3"></div>
                                <div class="face-report" id="face4"></div>
                            </div>
                        </div>
                </div>
                <div class="report-bb-chart" >

                    


                    <div id="report-bb-chart{{santiye.id}}"></div>

                    <div class="report-bb-stats">
                        <div class="report-bb-stat">
                            <div class="report-bb-stat-title"><i class="icon icon-green-circle"></i>{% trans 'Tamamlanan' %} </div>
                            <div class="report-bb-stat-value" id="fiziksel" >%{{fiziksel_ilerlemei |safe }}</div>
                        </div>
                        <div class="report-bb-stat">
                            <div class="report-bb-stat-title"><i class="icon icon-white-circle"></i>{% trans 'Devam Eden' %} </div>
                            <div class="report-bb-stat-value" id="finansal" >%{% basit_cikarma_duzenli 100 fiziksel_ilerlemei  %} </div>
                        </div>
                        
                        <!-- <div class="report-bb-stat">
                            <div class="report-bb-stat-title"><i class="icon icon-red-circle"></i> Duran</div>
                            <div class="report-bb-stat-value">%1</div>
                        </div>-->
                    </div>
                </div>
            </div>
        </div>
        </hr>
        </div>
                {% endfor %}
            
        </div>
    `);

    setTimeout(() => {
        
        {% for santiye in bloklar %}
                {% bloglar_daireleri_kalemleri_fiziksel_bilgilerii santiye.id as fiziksel_ilerlemei  %}
                {%  bloglari_rapora_yansitma santiye.proje_santiye_Ait as blog %}
                {% bloglar_daireleri_kalemleri_fiziksel_bilgileri santiye.id blog.k as fiziksel_ilerleme  %}
                {% bloglar_daireleri_kalemleri_finansal_bilgileri santiye.id blog.k as finansal_ilerleme  %}
                {% bloglar_daireleri_kalemleri_fiziksel_bilgileri_toplama_gonderme santiye.id blog.k as tablo  %}
                    {% get_son_bir_hafta_icinde_degisenler santiye.id  as gun_kalem_sayilari  %}
                    {% get_yil_icinde_degisenler santiye.id  as ay_kalem_sayilari  %}
                    {% to_int santiye.kat_sayisi as kat_bilgisi %}
                    var deger = "{{santiye.proje_santiye_Ait.id}}";
                   
                    if (santiye == deger || santiye == "0") {
                      
                        
                    
                    var roundedData1 = {{ gun_kalem_sayilari.degerler | safe }}.map(x => parseFloat(x.toFixed(2)));
    var roundedData2 = {{ gun_kalem_sayilari.degerler2 | safe }}.map(x => parseFloat(x.toFixed(2)));
    var roundedCategories = {{ gun_kalem_sayilari.gunler | safe }};
    var options = {
        series: [
            {
                name: "{% trans 'Finansal' %} ",
                data: roundedData2,
            }, 
            {
                name: "{% trans 'Fiziksel' %} ",
                data: roundedData1
            }
        ],
        chart: {
            type: 'bar',
            height: 350,
            stacked: true,
            toolbar: {
                show: false
            },
            zoom: {
                enabled: false
            }
        },
        colors: ['#F9B035', '#6149CD'],
        responsive: [
            {
                breakpoint: 480,
                options: {
                    legend: {
                        position: 'bottom',
                        offsetX: -10,
                        offsetY: 0
                    }
                }
            }
        ],
        plotOptions: {
            bar: {
                horizontal: false,
                borderRadius: 10,
                borderRadiusApplication: 'end', // 'around', 'end'
                borderRadiusWhenStacked: 'last', // 'all', 'last'
                dataLabels: {
                    total: {
                        enabled: true,
                        style: {
                            fontSize: '13px',
                            fontWeight: 900
                        }
                    }
                }
            },
        },
        xaxis: {
            type: 'text',
            categories: roundedCategories,
        },
        legend: {
            show: false
        },
        fill: {
            opacity: 1
        },
        dataLabels: {
            enabled: true,
            formatter: function(val) {
                return val.toFixed(2); // Değerleri 2 basamağa yuvarla
            }
        }
    };

    var charts = new ApexCharts(document.querySelector("#ilerleme-chart{{santiye.id}}"), options);
    charts.render();
    var optionss = {
                            series: [{
                                name: "{% trans 'Finansal' %} ",
                                data: {{ay_kalem_sayilari.degerler2 |safe}}
                            }, {
                                name:"{% trans 'Fiziksel' %} " ,
                                data:  {{ay_kalem_sayilari.degerler |safe}}
                            }],
                            chart: {
                                height: 350,
                                type: 'area',
                                zoom: {
                                    enabled: false
                                }
                            },
                            dataLabels: {
                                enabled: false
                            },
                            stroke: {
                                curve: 'smooth'
                            },
                            xaxis: {
                                type: 'category',
                                categories: {{ay_kalem_sayilari.aylar |safe}}
                            },
                            legend: {
                                show: false
                            },
                            colors: ['#F9B035', '#6149CD'],
                            tooltip: {
                                x: {
                                    format: 'MMM'
                                }
                            }
                        };

                        var charts = new ApexCharts(document.querySelector("#ilerleme-tablosu-chart{{santiye.id}}"), optionss);
                        charts.render();
                        var optionsbb = {
                            series:  [{{fiziksel_ilerlemei |safe }}, {% basit_cikarma_duzenli 100 fiziksel_ilerlemei  %} ],
                            chart: {
                                height: 500,
                                type: 'radialBar',
                            },
                            plotOptions: {
                                radialBar: {
                                    dataLabels: {
                                        name: {
                                            fontSize: '22px',
                                        },
                                        value: {
                                            fontSize: '16px',
                                        },
                                        total: {
                                            show: true,
                                            label: '{% trans 'Toplam' %}',
                                            formatter: function (w) {
                                                return "%100"
                                            }
                                        }
                                    },

                                },
                            },
                            labels: ['{% trans 'Tamamlanan' %}', '{% trans 'Devam Eden' %}'],
                            colors: ['#00A76F', '#DCDCDE']
                        };

                        var chartbb = new ApexCharts(document.querySelector("#report-bb-chart{{santiye.id}}"), optionsbb);
                        chartbb.render();
                   
                    document.getElementById('ilerleme_isleri{{santiye.id}}').style.display = "block";
                }
                {% endfor %}

            }, 100);
            

 

            break;

            case 'ilerleme-grafik':
                component = $(`
                    <div class="report-card" data-size="medium">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                İlerleme Grafiği
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn size-down" title="Küçült">
                                    <i class="icon icon-minus"></i>
                                </button>
                                <button class="card-action-btn size-up" title="Büyült">
                                    <i class="icon icon-plus"></i>
                                </button>
                                <button class="card-action-btn remove" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="minimal-table">
                            <table id="tumu-table">
                                <thead>
                                    <tr>
                                          <th >{% trans 'İş Emri Adı' %}</th>
                                            <th >{% trans 'Açıklama' %}</th>
                                            <th >{% trans 'Blok' %}</th>
                                            <th >{% trans 'Kat' %}</th>
                                            <th >{% trans 'Başlangıç' %}</th>
                                            <th >{% trans 'Hedef Tarih' %}</th>
                                            <th >{% trans 'Durum' %}</th>
                                            
                                    </tr>
                                </thead>
                                <tbody>
                                {% for i in is_planlari %}
                                <tr>
                                        <td>
                                            <div class="task-check">
                                                
                                                {{i.title}}
                                            </div>
                                        </td>
                                        <td >{{ i.aciklama }}</td>
                                        <td >
                                        {% if i.blok %}
                                            {{i.blok.blog_adi}}
                                        {% else %}
                                        {% endif %}
                                        </td>
                                        <td >{% if i.blok %}
                                            {{i.kat}}
                                        {% else %}
                                        {% endif %}</td>

                                        <td>{{i.kayit_tarihi |date:'d.m.Y'}}</td>
                                        <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                        <td>
                                        {% isplani_durumu_kontrol i.id as b %}
                                            
                                            {% if i.status == "Inprogress" %}
                                                <span
                                                class="status-inprogress stats-lg">{{i.status}}</span>
                                            {% elif i.status == "New" %}
                                            <div class="td-info"><span class="status-highlight stats-lg">{% trans 'Yeni' %}</span></div>
                                            {% elif i.status == "Pending" %}
                                            <div class="td-info"><span class="status-pending stats-lg">{% trans 'Beklemede' %}</span></div>
                                             {% elif i.status == "Completed" %}
                                            <div class="td-info"><span class="status-success stats-lg">{% trans 'Tamamlandı' %}</span></div>
                                                {% endif %}
                                            
                                    
                                        </td>
                                       
                                       
                                   
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                            </table>
                        </div>
                    </div>
                `);

                setTimeout(() => {
                    new ApexCharts(component.find('#progressChart')[0], {
                        series: [75],
                        chart: {
                            type: 'radialBar',
                            height: 250
                        },
                        plotOptions: {
                            radialBar: {
                                hollow: { size: '70%' },
                                dataLabels: {
                                    value: { fontSize: '22px' }
                                }
                            }
                        },
                        labels: ['Tamamlanma']
                    }).render();
                }, 100);
                break;

            case 'gorev-tablosu':
                component = $(`
                    <div class="report-card" data-size="medium">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-tasks"></i>
                                Görev Tablosu
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn size-down" title="Küçült">
                                    <i class="icon icon-minus"></i>
                                </button>
                                <button class="card-action-btn size-up" title="Büyült">
                                    <i class="icon icon-plus"></i>
                                </button>
                                <button class="card-action-btn remove" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="minimal-table">
                            <table id="tumu-table">
                                <thead>
                                    <tr>
                                          <th >{% trans 'İş Emri Adı' %}</th>
                                            <th >{% trans 'Açıklama' %}</th>
                                            <th >{% trans 'Blok' %}</th>
                                            <th >{% trans 'Kat' %}</th>
                                      
                                            <th >{% trans 'Başlangıç' %}</th>
                                            <th >{% trans 'Hedef Tarih' %}</th>
                                            <th >{% trans 'Durum' %}</th>
                                            
                                    </tr>
                                </thead>
                                <tbody>
                                {% for i in is_planlarii %}
                                <tr>
                                        <td>
                                            <div class="task-check">
                                                
                                                {{i.title}}
                                            </div>
                                        </td>
                                        <td >{{ i.aciklama }}</td>
                                        <td >
                                        {% if i.blok %}
                                            {{i.blok.blog_adi}}
                                        {% else %}
                                        {% endif %}
                                        </td>
                                        <td >{% if i.blok %}
                                            {{i.kat}}
                                        {% else %}
                                        {% endif %}</td>
                                        
                                        <td>{{i.kayit_tarihi |date:'d.m.Y'}}</td>
                                        <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                        <td>
                                        {% isplani_durumu_kontrol i.id as b %}
                                            
                                            {% if i.status == "Inprogress" %}
                                                <span
                                                class="status-inprogress stats-lg">{{i.status}}</span>
                                            {% elif i.status == "New" %}
                                            <div class="td-info"><span class="status-highlight stats-lg">{% trans 'Yeni' %}</span></div>
                                            {% elif i.status == "Pending" %}
                                            <div class="td-info"><span class="status-pending stats-lg">{% trans 'Beklemede' %}</span></div>
                                             {% elif i.status == "Completed" %}
                                            <div class="td-info"><span class="status-success stats-lg">{% trans 'Tamamlandı' %}</span></div>
                                                {% endif %}
                                            
                                    
                                        </td>
                                        
                                       
                                   
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                            </table>
                        </div>
                    </div>
                `);
                break;

            case 'personel-listesi':
                component = $(`
                    <div class="report-card" data-size="medium">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                Personel Listesi
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn size-down" title="Küçült">
                                    <i class="icon icon-minus"></i>
                                </button>
                                <button class="card-action-btn size-up" title="Büyült">
                                    <i class="icon icon-plus"></i>
                                </button>
                                <button class="card-action-btn remove" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="minimal-table">
                          <table id="tumu-table">
                                <thead>
                                    <tr>
                                          <th >{% trans 'Adı Soyadı' %}</th>
                                            <th >{% trans 'İşe Giriş Tarihi' %}</th>
                                            <th >{% trans 'Pozisyon' %}</th>
                                            <th >{% trans 'Departman' %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for i in personeller_listesi %}
                                <tr>
                                        
                                        <td >{{ i.isim }} {{ i.soyisim }}</td>
                                        <td>
                                        {{ i.kayit_tarihi |date:'d.m.Y'}} 
                                        </td>
                                        <td >{{ i.calisan_pozisyonu.kategori_isimi }}</td>
                                        <td >{{ i.calisan_kategori.kategori_isimi }}</td>               
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                            </table>
                        </div>
                    </div>
                `);
                break;

                case 'puantaj':
    component = $(`
        <div class="report-card" data-size="medium">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-clock"></i>
                    Puantaj
                </div>
                <div class="card-actions">
                    <button class="card-action-btn size-down" title="Küçült">
                        <i class="icon icon-minus"></i>
                    </button>
                    <button class="card-action-btn size-up" title="Büyült">
                        <i class="icon icon-plus"></i>
                    </button>
                    <button class="card-action-btn remove" title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="minimal-table">
                <table id="tumu-table">
                    <thead>
                        <tr>
                            <th>{% trans 'Adı Soyadı' %}</th>
                            <th>{% trans 'İşe Giriş Tarihi' %}</th>
                            <th>{% trans 'Pozisyon' %}</th>
                            <th>{% trans 'Çalışma Süresi' %}</th>
                            <th>{% trans 'Ek Mesai Süresi' %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in personeller_listesi %}
                        <tr>
                            <td>{{ i.isim }} {{ i.soyisim }}</td>
                            <td>{{ i.kayit_tarihi |date:'d.m.Y' }}</td>
                            <td>{{ i.calisan_pozisyonu.kategori_isimi }}</td>
                            <td class="normal_calisma_suresi{{i.id}}">0 saat</td>
                            <td class="mesai_calisma_suresi{{i.id}}">0 saat</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    `);

    setTimeout(() => {
        console.log("Puantaj component initialized");
        alert(tarih);
        const [tarih_baslangic, tarih_bitis] = tarih.split(" - ");

        console.log("Selected Date Range:", tarih);

        {% for i in personeller_listesi %}
        console.log("Fetching data for personel ID:", "{{i.id}}");
        fetch(`/users/calisma/{{i.id}}?baslangic=${tarih_baslangic}&bitis=${tarih_bitis}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Data for personel ID {{i.id}}:", data);
                console.log("Response for personel ID {{i.id}}:", data);
                document.querySelector(`.normal_calisma_suresi{{i.id}}`).textContent = `${data.normal_saat} saat`;
                document.querySelector(`.mesai_calisma_suresi{{i.id}}`).textContent = `${data.mesai_saati} saat`;
            })
            .catch(err => console.error("Error fetching data for personel ID {{i.id}}:", err));
        {% endfor %}
    }, 100);
    break;

        case 'izin-takip':
        component = $(`
        <div class="report-card" data-size="medium">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-calendar-alt"></i>
                    Puantaj
                </div>
                <div class="card-actions">
                    <button class="card-action-btn size-down" title="Küçült">
                        <i class="icon icon-minus"></i>
                    </button>
                    <button class="card-action-btn size-up" title="Büyült">
                        <i class="icon icon-plus"></i>
                    </button>
                    <button class="card-action-btn remove" title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="minimal-table">
                <table id="tumu-table">
                    <thead>
                        <tr>
                            <th>{% trans 'Adı Soyadı' %}</th>
                            <th>{% trans 'Pozisyon' %}</th>
                            <th>{% trans 'Çalışma Süresi' %}</th>
                            <th>{% trans 'Ek Mesai Süresi' %}</th>
                            <th>{% trans 'İzin Gün Süresi' %}</th>
                     
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in personeller_listesi %}
                        <tr>
                            <td>{{ i.isim }} {{ i.soyisim }}</td>
                            <td>{{ i.calisan_pozisyonu.kategori_isimi }}</td>
                            <td class="normal_calisma_suresi{{i.id}}">0 saat</td>
                            <td class="mesai_calisma_suresi{{i.id}}">0 saat</td>
                            <td class="izin_gun_sureleri{{i.id}}">0 Gün</td>
                            
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    `);

    setTimeout(() => {
        console.log("Puantaj component initialized");
        alert(tarih);
        const [tarih_baslangic, tarih_bitis] = tarih.split(" - ");

        console.log("Selected Date Range:", tarih);

        {% for i in personeller_listesi %}
        console.log("Fetching data for personel ID:", "{{i.id}}");
        fetch(`/users/calisma/{{i.id}}?baslangic=${tarih_baslangic}&bitis=${tarih_bitis}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Data for personel ID {{i.id}}:", data);
                console.log("Response for personel ID {{i.id}}:", data);
                document.querySelector(`.izin_gun_sureleri{{i.id}}`).textContent = `${data.izin_gunleri} Gün`;
                document.querySelector(`.normal_calisma_suresi{{i.id}}`).textContent = `${data.normal_saat} saat`;
                document.querySelector(`.mesai_calisma_suresi{{i.id}}`).textContent = `${data.mesai_saati} saat`;
            })
            .catch(err => console.error("Error fetching data for personel ID {{i.id}}:", err));
        {% endfor %}
    }, 100);
    break;

    case 'metin':
        component = $(`
            <div class="report-card" data-size="medium">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-font"></i>
                        Metin
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn edit-text" title="Düzenle">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="card-action-btn remove" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-content">
                        <p>Metninizi buraya yazın...</p>
                    </div>
                </div>
                <div class="resize-handle resize-handle-e"></div>
                <div class="resize-handle resize-handle-s"></div>
                <div class="resize-handle resize-handle-se"></div>
            </div>
        `);

        // Düzenleme modalı
        const editModal = $(`
            <div class="modal text-edit-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Metin Düzenle</h3>
                        <button class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="text-editor">
                            <div class="editor-toolbar">
                                <button class="toolbar-btn" data-command="bold" title="Kalın">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="toolbar-btn" data-command="italic" title="İtalik">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="toolbar-btn" data-command="underline" title="Altı Çizili">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <button class="toolbar-btn" data-command="justifyLeft" title="Sola Hizala">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button class="toolbar-btn" data-command="justifyCenter" title="Ortala">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button class="toolbar-btn" data-command="justifyRight" title="Sağa Hizala">
                                    <i class="fas fa-align-right"></i>
                                </button>
                            </div>
                            <div class="editor-content" contenteditable="true">
                                <p>Metninizi buraya yazın...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="button" onclick="$(this).closest('.modal').remove()">İptal</button>
                        <button class="button button-primary save-text">Kaydet</button>
                    </div>
                </div>
            </div>
        `);

        // Düzenleme butonu tıklandığında
        component.find('.edit-text').click(function() {
            const currentContent = component.find('.text-content').html();
            editModal.find('.editor-content').html(currentContent);
            $('body').append(editModal);
            editModal.addClass('active');
        });

        // Modal kapatma
        editModal.find('.modal-close').click(function() {
            editModal.remove();
        });

        // Metin editörü işlevselliği
        editModal.find('.toolbar-btn').click(function() {
            const command = $(this).data('command');
            document.execCommand(command, false, null);
        });

        // Kaydet butonu
        editModal.find('.save-text').click(function() {
            const newContent = editModal.find('.editor-content').html();
            component.find('.text-content').html(newContent);
            editModal.remove();
        });

        // Boyutlandırma işlevselliği
        this.initializeResizeHandles(component);
        break;
    }
    
    if (component) {
        // Komponent boyutlandırma işlevselliği
        component.find('.size-up, .size-down').click(function() {
            const card = $(this).closest('.report-card');
            const column = card.closest('.report-column');
            const sizes = ['small', 'medium', 'large', 'full'];
            const currentSize = card.attr('data-size') || 'medium';
            const currentIndex = sizes.indexOf(currentSize);
            
            if ($(this).hasClass('size-up') && currentIndex < sizes.length - 1) {
                card.attr('data-size', sizes[currentIndex + 1]);
                // Komponenti kolon genişliğine göre ayarla
                const columnWidth = column.width();
                card.width(columnWidth - 20); // Padding'leri çıkar
            } else if ($(this).hasClass('size-down') && currentIndex > 0) {
                card.attr('data-size', sizes[currentIndex - 1]);
                // Komponenti kolon genişliğine göre ayarla
                const columnWidth = column.width();
                card.width(columnWidth - 20); // Padding'leri çıkar
            }
        });

        // Silme işlevselliği
        component.find('.remove').click(function() {
            const card = $(this).closest('.report-card');
            const column = card.closest('.report-column');
            card.remove();
            
            // Eğer kolon boşsa, drop zone'u geri ekle
            if (column.find('.report-card').length === 0) {
                column.append('<div class="drop-zone"><span class="drop-text">Bileşen eklemek için sürükleyin</span></div>');
                window.reportManager.initializeDropZones();
            }
        });
    }
    
    return component;
}

initializeResizeHandles(component) {
    const card = component;
    let startX, startY, startWidth, startHeight;
    
    // Doğu (sağ) tutamaç
    card.find('.resize-handle-e').on('mousedown', function(e) {
        startX = e.pageX;
        startWidth = card.width();
        
        $(document).on('mousemove', resizeE);
        $(document).on('mouseup', stopResize);
        
        e.preventDefault();
    });
    
    // Güney (alt) tutamaç
    card.find('.resize-handle-s').on('mousedown', function(e) {
        startY = e.pageY;
        startHeight = card.height();
        
        $(document).on('mousemove', resizeS);
        $(document).on('mouseup', stopResize);
        
        e.preventDefault();
    });
    
    // Güneydoğu (sağ alt köşe) tutamaç
    card.find('.resize-handle-se').on('mousedown', function(e) {
        startX = e.pageX;
        startY = e.pageY;
        startWidth = card.width();
        startHeight = card.height();
        
        $(document).on('mousemove', resizeSE);
        $(document).on('mouseup', stopResize);
        
        e.preventDefault();
    });
    
    function resizeE(e) {
        const width = startWidth + (e.pageX - startX);
        if (width > 200) { // Minimum genişlik
            card.width(width);
            card.trigger('resize');
        }
    }
    
    function resizeS(e) {
        const height = startHeight + (e.pageY - startY);
        if (height > 100) { // Minimum yükseklik
            card.height(height);
            card.trigger('resize');
        }
    }
    
    function resizeSE(e) {
        const width = startWidth + (e.pageX - startX);
        const height = startHeight + (e.pageY - startY);
        if (width > 200 && height > 100) {
            card.width(width);
            card.height(height);
            card.trigger('resize');
        }
    }
    
    function stopResize() {
        $(document).off('mousemove', resizeE);
        $(document).off('mousemove', resizeS);
        $(document).off('mousemove', resizeSE);
        $(document).off('mouseup', stopResize);
    }
    
    // Grafik yeniden boyutlandırma
    card.on('resize', function() {
        if (card.find('#gelirGiderChart').length) {
            ApexCharts.exec('gelirGiderChart', 'updateOptions', {
                chart: {
                    width: '100%',
                    height: card.height() - 100 // Header yüksekliğini çıkar
                }
            });
        }
    });
}

initResizeHandles() {
    $(document).on('mousedown', '.component-resize', (e) => {
        e.preventDefault();
        const component = $(e.target).closest('.component');
        const startX = e.pageX;
        const startY = e.pageY;
        const startWidth = component.outerWidth();
        const startHeight = component.outerHeight();
        const direction = $(e.target).data('direction');
        const minWidth = 200;
        const minHeight = 100;

        const handleMouseMove = (e) => {
            e.preventDefault();
            const deltaX = e.pageX - startX;
            const deltaY = e.pageY - startY;
            let newWidth = startWidth;
            let newHeight = startHeight;

            switch(direction) {
                case 'nw':
                    newWidth = Math.max(minWidth, startWidth - deltaX);
                    newHeight = Math.max(minHeight, startHeight - deltaY);
                    component.css({
                        width: newWidth,
                        height: newHeight,
                        left: startX - e.pageX + component.offset().left,
                        top: startY - e.pageY + component.offset().top
                    });
                    break;
                case 'ne':
                    newWidth = Math.max(minWidth, startWidth + deltaX);
                    newHeight = Math.max(minHeight, startHeight - deltaY);
                    component.css({
                        width: newWidth,
                        height: newHeight,
                        top: startY - e.pageY + component.offset().top
                    });
                    break;
                case 'sw':
                    newWidth = Math.max(minWidth, startWidth - deltaX);
                    newHeight = Math.max(minHeight, startHeight + deltaY);
                    component.css({
                        width: newWidth,
                        height: newHeight,
                        left: startX - e.pageX + component.offset().left
                    });
                    break;
                case 'se':
                    newWidth = Math.max(minWidth, startWidth + deltaX);
                    newHeight = Math.max(minHeight, startHeight + deltaY);
                    component.css({
                        width: newWidth,
                        height: newHeight
                    });
                    break;
            }

            const tableContainer = component.find('.table-container');
            if (tableContainer.length) {
                tableContainer.css({
                    width: '100%',
                    maxWidth: '100%'
                });
            }
        };

        const handleMouseUp = () => {
            $(document).off('mousemove', handleMouseMove);
            $(document).off('mouseup', handleMouseUp);
        };

        $(document).on('mousemove', handleMouseMove);
        $(document).on('mouseup', handleMouseUp);
    });
}
}

// Sayfa yüklendiğinde başlat
$(document).ready(() => {
window.reportManager = new ReportManager();
});

// Modal fonksiyonları
function closePdfPreview() {
document.getElementById('pdfPreviewModal').classList.remove('active');
}

function openPageSettings() {
document.getElementById('pageSettingsModal').classList.add('active');
}

function closePageSettings() {
document.getElementById('pageSettingsModal').classList.remove('active');
}

function savePageSettings() {
    // Kenar boşlukları
    const margins = {
        top: $('.margin-control[data-margin="top"]').val(),
        right: $('.margin-control[data-margin="right"]').val(),
        bottom: $('.margin-control[data-margin="bottom"]').val(),
        left: $('.margin-control[data-margin="left"]').val()
    };

    // Kağıt ayarları
    const paperSize = $('#paperSize').val();
    const orientation = $('input[name="orientation"]:checked').val();

    // Ayarları uygula
    Object.entries(margins).forEach(([margin, value]) => {
        $('.preview-container').css(`padding-${margin}`, value + 'mm');
    });

    // Ayrıca PDF oluşturma fonksiyonlarının kenar boşluklarını güncelle
    window.reportManager.updatePdfMargins([
        parseInt(margins.top), 
        parseInt(margins.right), 
        parseInt(margins.bottom), 
        parseInt(margins.left)
    ]);

    closePageSettings();
}


</script>

<script>
function saveReport() {
    const name = $('#reportNames').val();
    const description = $('#reportDescriptions').val();

    if (!name) {
        alert('Lütfen rapor adı giriniz');
        return;
    }

    // PDF oluşturma ayarları
    const pdfOptions = {
        margin: [10, 10, 10, 10],
        filename: `${name}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // PDF oluştur ve değişken olarak kaydet
    html2pdf()
        .from(document.querySelector('#reportPreview'))
        .set(pdfOptions)
        .outputPdf('datauristring')
        .then((pdfDataUri) => {
            const pdfBase64 = pdfDataUri.split(',')[1]; // Base64 formatında PDF verisi

            // Rapor verilerini hazırla
            const reportData = {
                name,
                description,
                dateRange: {
                    start: $('#dateRange').data('daterangepicker').startDate.format('YYYY-MM-DD'),
                    end: $('#dateRange').data('daterangepicker').endDate.format('YYYY-MM-DD')
                },
                content: $('#reportPreview').html(),
                
                project: $('#projectSelect').val(),
                pdf: pdfBase64
            };

            // CSRF token al
            //const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            console.log(reportData);
            // AJAX ile API'ye gönder
            $.ajax({
                url: '/rapor_kaydedici/', // API endpoint
                method: 'POST',
                contentType: 'application/json',
                 headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                data: JSON.stringify(reportData),
                success: function (response) {
                    alert('Rapor başarıyla kaydedildi');
                    console.log('API yanıtı:', response);
                },
                error: function (xhr, status, error) {
                    console.error('Rapor kaydetme hatası:', error);
                    alert('Rapor kaydedilirken bir hata oluştu');
                }
            });
        })
        .catch((error) => {
            console.error('PDF oluşturma hatası:', error);
            alert('PDF oluşturulurken bir hata oluştu');
        });
}

/**
 * Tablo sütunlarının genişliklerini ayarlamak için fonksiyon
 */
function initTableResizing() {
    // Tüm minimal-table sınıfına sahip tablolardaki th elementleri için
    const tables = document.querySelectorAll('table.minimal-table');
    
    tables.forEach(table => {
        const headers = table.querySelectorAll('th');
        
        // Her başlık için resizer elementi ekleyelim
        headers.forEach(header => {
            // Eğer zaten resizer varsa eklemiyoruz
            if (!header.querySelector('.resizer')) {
                const resizer = document.createElement('div');
                resizer.classList.add('resizer');
                header.appendChild(resizer);
                
                let startX, startWidth;
                
                // Resize işlemini başlat
                resizer.addEventListener('mousedown', function(e) {
                    startX = e.pageX;
                    startWidth = header.offsetWidth;
                    resizer.classList.add('resizing');
                    
                    // MouseMove ve MouseUp eventlerini document'a ekle
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                    
                    // Event yayılımını durdur
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                // Resize işlemi
                function resize(e) {
                    const width = startWidth + (e.pageX - startX);
                    if (width > 50) { // Minimum genişlik
                        header.style.width = width + 'px';
                        // Tüm satırlardaki aynı indexteki hücrelere de genişlik ayarla
                        const colIndex = Array.from(header.parentNode.children).indexOf(header);
                        const rows = table.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const cell = row.children[colIndex];
                            if (cell) {
                                cell.style.width = width + 'px';
                            }
                        });
                    }
                }
                
                // Resize işlemini sonlandır
                function stopResize() {
                    resizer.classList.remove('resizing');
                    document.removeEventListener('mousemove', resize);
                    document.removeEventListener('mouseup', stopResize);
                }
            }
        });
    });
}

// Manuel olarak tüm tabloları hazırla
function prepareAllTables() {
    // Tüm mevcut tabloları bul
    const allTables = document.querySelectorAll('table');
    
    allTables.forEach(table => {
        // Eğer minimal-table sınıfına sahip değilse ekle
        if (!table.classList.contains('minimal-table')) {
            table.classList.add('minimal-table');
        }
        
        // Tablo henüz hazır değilse işaretle
        if (!table.hasAttribute('data-resizable')) {
            table.setAttribute('data-resizable', 'true');
        }
    });
    
    // Resizing fonksiyonunu başlat
    initTableResizing();
    
    console.log(`Toplam ${allTables.length} tablo hazırlandı.`);
}

// DOM içindeki tüm tabloları işaretleme ve resizing işlemini çalıştırma
jQuery(document).ready(function($) {
    // Şablon Seçicileri düzeltme
    $('.template-item').off('click').on('click', function(e) {
        e.preventDefault();
        const templateId = $(this).data('template');
        console.log('Şablon seçildi:', templateId);
        
        // Tüm şablonlardan active/selected sınıflarını kaldır
        $('.template-item').removeClass('active').removeClass('selected');
        
        // Seçilen şablona active/selected sınıfı ekle
        $(this).addClass('active').addClass('selected');
        
        // Şablonu yükle
        if (window.reportManager && typeof window.reportManager.loadTemplate === 'function') {
            window.reportManager.loadTemplate(templateId);
        } else if (typeof loadTemplate === 'function') {
            loadTemplate(templateId);
        } else {
            console.error('loadTemplate fonksiyonu bulunamadı');
        }
        
        // Masonry grid düzenini güncelle
        setTimeout(function() {
            if (typeof initializeMasonryLayout === 'function') {
                initializeMasonryLayout();
            }
            organizeReportCards();
        }, 500);
    });
    
    // Sayfa yüklendikten 500ms sonra tabloları hazırla
    setTimeout(function() {
        prepareAllTables();
        
        // Masonry grid düzenini uygula
        if (typeof initializeMasonryLayout === 'function') {
            initializeMasonryLayout();
        }
        organizeReportCards();
        
        // 2 saniye daha sonra bir kez daha kontrol et
        setTimeout(function() {
            prepareAllTables();
            
            // Masonry grid düzenini tekrar uygula
            if (typeof initializeMasonryLayout === 'function') {
                initializeMasonryLayout();
            }
            organizeReportCards();
        }, 2000);
    }, 500);
    
    // MutationObserver ile DOM değişikliklerini takip et
    const observer = new MutationObserver(function(mutations) {
        let shouldPrepare = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                // DOM'a yeni bir element eklendiğinde
                shouldPrepare = true;
            }
        });
        
        if (shouldPrepare) {
            // Değişiklik olduğunda tabloları tekrar hazırla
            setTimeout(prepareAllTables, 200);
        }
    });
    
    // Tüm document'ı gözlemle
    observer.observe(document.body, { childList: true, subtree: true });
});

/**
 * Component Manager'da onclone fonksiyonlarında sütun genişliklerini koru
 */
$(document).ready(function() {
    // PDF oluşturma fonksiyonlarında minimal-table stillerini güncelle
    const originalShowPdfPreview = window.reportManager?.showPdfPreview;
    if (originalShowPdfPreview) {
        window.reportManager.showPdfPreview = function() {
            // Orijinal fonksiyonu çalıştır
            originalShowPdfPreview.call(this);
            
            // Tablo genişliklerini koru
            const tables = document.querySelectorAll('table.minimal-table');
            tables.forEach(table => {
                const headers = table.querySelectorAll('th');
                headers.forEach(header => {
                    const width = header.style.width;
                    if (width) {
                        const colIndex = Array.from(header.parentNode.children).indexOf(header);
                        const rows = table.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const cell = row.children[colIndex];
                            if (cell) {
                                cell.style.width = width;
                            }
                        });
                    }
                });
            });
        };
    }
});
</script>
{% endblock sidebar %}

<!-- Şablon Seçici -->
<div class="sidebar-section template-selector">
    <div class="section-header">
        <h3>Şablon Seçici</h3>
    </div>
    <div id="template-list" class="template-grid">
        <!-- Şablonlar buraya yüklenecek -->
        <div class="template-item" data-template="bos">
            <div class="template-preview">Boş Şablon</div>
            <div class="template-name">Boş Şablon</div>
        </div>
        <div class="template-item" data-template="finansal">
            <div class="template-preview">Finansal Şablon</div>
            <div class="template-name">Finansal Rapor</div>
        </div>
    </div>
</div>

<!-- Şablon Seçici için JavaScript dosyasını ekle -->
<script src="{% static 'src/js/pages/template-selector.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Şablon seçici işlevselliği
    const templateItems = document.querySelectorAll('.template-item');
    console.log('Şablon öğeleri bulundu:', templateItems.length);
    
    templateItems.forEach(item => {
        console.log('Şablon öğesi:', item);
        item.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Şablon tıklandı:', this.getAttribute('data-template'));
            
            // Aktif şablonu işaretle
            document.querySelectorAll('.template-item').forEach(el => {
                el.classList.remove('selected');
                el.classList.remove('active');
            });
            this.classList.add('selected');
            this.classList.add('active');
            
            // Şablonu yükle
            const templateType = this.getAttribute('data-template');
            loadTemplate(templateType);
            
            // Masonry grid düzenini güncelle
            setTimeout(function() {
                if (typeof initializeMasonryLayout === 'function') {
                    initializeMasonryLayout();
                }
                organizeReportCards();
            }, 500);
            
            // Özel olay tetikle
            document.dispatchEvent(new CustomEvent('templateSelected', { 
                detail: { templateId: templateType } 
            }));
        });
    });

    // Report-card'ları düzenle
    organizeReportCards();
    
    // Yeni bir kart eklendiğinde ya da bir kart silindiğinde kartları yeniden düzenle
    // Event delegation kullanarak bu olayları dinle
    document.addEventListener('componentAdded', function() {
        setTimeout(function() {
            organizeReportCards();
            if (typeof initializeMasonryLayout === 'function') {
                initializeMasonryLayout();
            }
        }, 300);
    });
    
    document.addEventListener('componentRemoved', function() {
        setTimeout(function() {
            organizeReportCards();
            if (typeof initializeMasonryLayout === 'function') {
                initializeMasonryLayout();
            }
        }, 300);
    });
});

// ... existing code ...
</script>

<script>
$(document).ready(function() {
    // ControlManager'ı başlat
    window.controlManager = new ControlManager();
    
    // TinyMCE'yi başlat
    if (typeof tinymce !== 'undefined') {
        tinymce.init({
            selector: '.tinymce-editor',
            height: 300,
            menubar: false,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | formatselect | ' +
                'bold italic backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }'
        });
    }
});
</script>

// Tabloları düzenleyin
function prepareMinimalTables() {
    // div.minimal-table içindeki tabloları düzenle
    $('div.minimal-table').each(function() {
        const div = $(this);
        const table = div.find('table');
        
        // Tabloyu minimal-table sınıfı ile işaretle
        if (table.length && !table.hasClass('minimal-table')) {
            table.addClass('minimal-table');
        }
        
        // Tabloyu table-container ile sar
        if (table.length && !table.parent('.table-container').length) {
            table.wrap('<div class="table-container"></div>');
            
            // Table container stillerini ayarla
            div.find('.table-container').css({
                'width': '100%',
                'max-width': '100%',
                'overflow-x': 'auto',
                'border': '1px solid #e9ecef',
                'border-radius': '4px'
            });
        }
    });
    
    // Yeni hazırlanan tablolara resize işlevselliği ekle
    initTableResizing();
}

// Sayfa yüklendiğinde veya DOM güncellendiğinde tabloları hazırla
$(document).ready(function() {
    prepareMinimalTables();
    
    // MutationObserver ile DOM değişikliklerini takip et
    const observer = new MutationObserver(function(mutations) {
        let shouldPrepare = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                mutation.addedNodes.forEach(function(node) {
                    // Eğer eklenen node bir div.minimal-table veya onun içinde bir şey ise
                    if (node.classList && node.classList.contains('minimal-table') || 
                        $(node).find('.minimal-table').length) {
                        shouldPrepare = true;
                    }
                });
            }
        });
        
        if (shouldPrepare) {
            prepareMinimalTables();
        }
    });
    
    // Tüm document'ı gözlemle
    observer.observe(document.body, { childList: true, subtree: true });
});

// PDF oluşturma fonksiyonlarına tablo genişliği kopyalama kodu ekleyin
$(document).ready(function() {
    // Orijinal showPdfPreview fonksiyonunu sakla
    const originalShowPdfPreview = window.reportManager && window.reportManager.showPdfPreview;
    
    if (originalShowPdfPreview) {
        window.reportManager.showPdfPreview = function() {
            // Önce orijinal fonksiyonu çağır
            const result = originalShowPdfPreview.apply(this, arguments);
            
            // PDF oluşturulduktan sonra sütun genişliklerini kopyala
            setTimeout(() => {
                const iframe = document.getElementById('pdfPreviewFrame');
                if (iframe && iframe.contentDocument) {
                    const clonedDoc = iframe.contentDocument;
                    
                    // Orijinal tablodan stil kopyalama
                    const originalTables = document.querySelectorAll('table.minimal-table');
                    originalTables.forEach(originalTable => {
                        const originalId = originalTable.id || '';
                        const clonedTables = clonedDoc.querySelectorAll('table.minimal-table');
                        
                        clonedTables.forEach(clonedTable => {
                            if (clonedTable.id === originalId || !originalId) {
                                // Tüm sütun genişliklerini kopyala
                                const originalHeaders = originalTable.querySelectorAll('th');
                                const clonedHeaders = clonedTable.querySelectorAll('th');
                                
                                for (let i = 0; i < originalHeaders.length && i < clonedHeaders.length; i++) {
                                    const originalWidth = originalHeaders[i].style.width;
                                    if (originalWidth) {
                                        clonedHeaders[i].style.width = originalWidth;
                                        
                                        // Aynı indeksteki tüm hücreleri de güncelle
                                        const clonedRows = clonedTable.querySelectorAll('tbody tr');
                                        clonedRows.forEach(row => {
                                            const cell = row.children[i];
                                            if (cell) {
                                                cell.style.width = originalWidth;
                                            }
                                        });
                                    }
                                }
                            }
                        });
                    });
                }
            }, 1000); // İframe yüklendikten sonra
            
            return result;
        };
    }
    
    // Orijinal exportToPDF fonksiyonunu da güncelle
    const originalExportToPDF = window.reportManager && window.reportManager.exportToPDF;
    
    if (originalExportToPDF) {
        window.reportManager.exportToPDF = function() {
            // Önce tüm tabloların genişlik bilgisini inline stil olarak ekle
            const tables = document.querySelectorAll('table.minimal-table');
            tables.forEach(table => {
                const headers = table.querySelectorAll('th');
                headers.forEach((header, index) => {
                    if (header.style.width) {
                        // Aynı indeksteki tüm hücreleri de güncelle
                        const rows = table.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const cell = row.children[index];
                            if (cell) {
                                cell.style.width = header.style.width;
                            }
                        });
                    }
                });
            });
            
            // Orijinal fonksiyonu çağır
            return originalExportToPDF.apply(this, arguments);
        };
    }
});

/**
 * Şablon yüklemek için fonksiyon 
 */
function loadTemplate(templateId) {
    console.log(`Şablon yükleniyor: ${templateId}`);
    
    // Aktif şablon stilini temizle
    $('.template-item').removeClass('active');
    
    // Seçilen şablonu aktif olarak işaretle
    $(`.template-item[data-template="${templateId}"]`).addClass('active');
    
    // Şablon içeriğini temizle ve yeniden yükle
    const reportContainer = document.querySelector('#report-container');
    
    if (reportContainer) {
        // Şablona göre içeriği temizle veya hazırla
        
        switch(templateId) {
            case 'empty':
                // Boş şablon - sadece bir başlık içerir
                reportContainer.innerHTML = `
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-component">
                                <h1 class="editable" contenteditable="true">Yeni Rapor</h1>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'invoice':
                // Fatura şablonu
                reportContainer.innerHTML = `
                    <div class="report-row">
                        <div class="report-column" style="width: 60%;">
                            <div class="report-component">
                                <h1 class="editable" contenteditable="true">FATURA</h1>
                                <p class="editable" contenteditable="true">Tarih: ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="report-column" style="width: 40%;">
                            <div class="report-component">
                                <div class="logo-container">
                                    <img src="/static/go/images/logo.png" alt="Logo" class="logo-image">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-component">
                                <table class="minimal-table">
                                    <thead>
                                        <tr>
                                            <th>Ürün/Hizmet</th>
                                            <th>Miktar</th>
                                            <th>Birim Fiyat</th>
                                            <th>Toplam</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td contenteditable="true">Ürün Adı</td>
                                            <td contenteditable="true">1</td>
                                            <td contenteditable="true">₺100.00</td>
                                            <td contenteditable="true">₺100.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'report':
                // Standart rapor şablonu
                reportContainer.innerHTML = `
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-component">
                                <h1 class="editable" contenteditable="true">Proje Raporu</h1>
                                <h3 class="editable" contenteditable="true">Özet</h3>
                                <p class="editable" contenteditable="true">Bu rapor, projenin mevcut durumunu ve geleceğe yönelik planları içermektedir.</p>
                            </div>
                        </div>
                    </div>
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-component">
                                <h3 class="editable" contenteditable="true">Proje Detayları</h3>
                                <table class="minimal-table">
                                    <thead>
                                        <tr>
                                            <th>Başlık</th>
                                            <th>Açıklama</th>
                                            <th>Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td contenteditable="true">İş Paketi 1</td>
                                            <td contenteditable="true">Detaylı açıklama</td>
                                            <td contenteditable="true">Tamamlandı</td>
                                        </tr>
                                        <tr>
                                            <td contenteditable="true">İş Paketi 2</td>
                                            <td contenteditable="true">Detaylı açıklama</td>
                                            <td contenteditable="true">Devam Ediyor</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'checklist':
                // Kontrol listesi şablonu
                reportContainer.innerHTML = `
                    <div class="report-row">
                        <div class="report-column">
                            <div class="report-component">
                                <h1 class="editable" contenteditable="true">Kontrol Listesi</h1>
                                <table class="minimal-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">#</th>
                                            <th>Kontrol Maddesi</th>
                                            <th style="width: 100px;">Durum</th>
                                            <th style="width: 150px;">Sorumlu</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td contenteditable="true">1</td>
                                            <td contenteditable="true">Temel güvenlik kontrolü</td>
                                            <td contenteditable="true">Tamamlandı</td>
                                            <td contenteditable="true">Ahmet Yılmaz</td>
                                        </tr>
                                        <tr>
                                            <td contenteditable="true">2</td>
                                            <td contenteditable="true">Elektrik tesisatı kontrolü</td>
                                            <td contenteditable="true">Beklemede</td>
                                            <td contenteditable="true">Mehmet Demir</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            default:
                console.error(`Bilinmeyen şablon: ${templateId}`);
                return;
        }
        
        // Yeni eklenen tabloları hazırla
        setTimeout(prepareAllTables, 100);
    } else {
        console.error('Report container bulunamadı');
    }
}

// Masonry yapısını ölçülendirme için gerekli yardımcı fonksiyonlar
function updateMasonryLayout() {
    console.log('Masonry düzeni güncelleniyor...');
    
    // Tüm report-charts ve card-body konteynerlerini bul
    const gridContainers = document.querySelectorAll('.report-charts, .card-body[data-columns], .preview-grid');
    
    if (gridContainers.length === 0) {
        console.log('Masonry düzeni için konteyner bulunamadı');
        return;
    }
    
    console.log('Masonry düzeni için konteyner sayısı:', gridContainers.length);
    
    gridContainers.forEach(function(grid) {
        const cardElements = grid.querySelectorAll('.report-card');
        
        if (cardElements.length === 0) {
            console.log('Grid içinde card bulunamadı:', grid);
            return;
        }
        
        console.log('Grid içindeki card sayısı:', cardElements.length);
        
        // Masonry düzenini temizle
        cardElements.forEach(function(card) {
            // Grid column ve row değerlerini sakla
            const gridCol = card.style.gridColumn;
            const gridRow = card.style.gridRow;
            
            // Eğer pozisyon absolute ise geri al
            if (card.style.position === 'absolute') {
                card.style.position = 'relative';
            }
            
            // Boyutunu hesapla
            const cardSize = card.getAttribute('data-size') || 'medium';
            
            // Grid sütun değerini ayarla
            if (cardSize === 'small') {
                card.style.gridColumn = 'span 4';
            } else if (cardSize === 'medium') {
                card.style.gridColumn = 'span 4';
            } else if (cardSize === 'large') {
                card.style.gridColumn = 'span 8';
            } else if (cardSize === 'full') {
                card.style.gridColumn = 'span 12';
            } else if (!card.style.gridColumn) {
                card.style.gridColumn = 'span 4'; // Varsayılan değer
            }
        });
        
        // CSS grid'i düzeltme
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(12, 1fr)';
        grid.style.gap = '20px';
    });
    
    console.log('Masonry düzeni güncellendi');
}

// Yeniden boyutlandırma işlevselliği
function enableCardResizing() {
    console.log('Kart boyutlandırma etkinleştiriliyor...');
    
    // Tüm kartları bul
    const cards = document.querySelectorAll('.report-card:not(.resizable-initialized)');
    
    if (cards.length === 0) {
        console.log('Boyutlandırılacak kart bulunamadı');
        return;
    }
    
    console.log('Boyutlandırılacak kart sayısı:', cards.length);
    
    cards.forEach(function(card) {
        // Kartın zaten boyutlandırılabilir olup olmadığını kontrol et
        if (card.classList.contains('resizable-initialized')) {
            return;
        }
        
        // Kenar tutamaçlarını ekle
        const rightHandle = document.createElement('div');
        rightHandle.className = 'card-resize-handle card-resize-right';
        rightHandle.title = 'Genişliği değiştirmek için sürükleyin';
        
        const bottomHandle = document.createElement('div');
        bottomHandle.className = 'card-resize-handle card-resize-bottom';
        bottomHandle.title = 'Yüksekliği değiştirmek için sürükleyin';
        
        const cornerHandle = document.createElement('div');
        cornerHandle.className = 'card-resize-handle card-resize-corner';
        cornerHandle.title = 'Boyutu değiştirmek için sürükleyin';
        
        // Tutamaçları karta ekle
        card.appendChild(rightHandle);
        card.appendChild(bottomHandle);
        card.appendChild(cornerHandle);
        
        // jQuery ile boyutlandırma işlemleri
        
        // Sağ kenar boyutlandırma
        $(rightHandle).on('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const startX = e.pageX;
            const startWidth = $(card).width();
            const parent = $(card).parent();
            const parentWidth = parent.width();
            
            // Grid uyumu için
            const minWidth = Math.floor(parentWidth / 12);
            
            // Taşıma işlemi
            $(document).on('mousemove.resize', function(e) {
                const newWidth = startWidth + (e.pageX - startX);
                
                // Genişliği güncelle
                if (newWidth >= minWidth) {
                    $(card).width(newWidth + 'px');
                    
                    // Span değerini hesapla
                    const span = Math.max(1, Math.min(12, Math.round((newWidth / parentWidth) * 12)));
                    card.style.gridColumn = `span ${span}`;
                    
                    // data-size özniteliğini güncelle
                    if (span <= 3) {
                        card.setAttribute('data-size', 'small');
                    } else if (span <= 6) {
                        card.setAttribute('data-size', 'medium');
                    } else if (span <= 9) {
                        card.setAttribute('data-size', 'large');
                    } else {
                        card.setAttribute('data-size', 'full');
                    }
                }
            });
            
            // Taşıma bitti
            $(document).on('mouseup.resize', function() {
                $(document).off('mousemove.resize mouseup.resize');
                
                // Masonry düzenini güncelle
                setTimeout(function() {
                    updateMasonryLayout();
                    if (typeof initializeMasonryLayout === 'function') {
                        initializeMasonryLayout();
                    }
                    if (typeof organizeReportCards === 'function') {
                        organizeReportCards();
                    }
                }, 100);
            });
            
            $(card).addClass('resizing');
            $('body').css('cursor', 'ew-resize');
        });
        
        // Alt kenar boyutlandırma
        $(bottomHandle).on('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const startY = e.pageY;
            const startHeight = $(card).height();
            
            // Taşıma işlemi
            $(document).on('mousemove.resize', function(e) {
                const newHeight = startHeight + (e.pageY - startY);
                
                // Yüksekliği güncelle
                if (newHeight >= 100) {
                    $(card).height(newHeight + 'px');
                }
            });
            
            // Taşıma bitti
            $(document).on('mouseup.resize', function() {
                $(document).off('mousemove.resize mouseup.resize');
                
                // Masonry düzenini güncelle
                setTimeout(function() {
                    updateMasonryLayout();
                    if (typeof initializeMasonryLayout === 'function') {
                        initializeMasonryLayout();
                    }
                    if (typeof organizeReportCards === 'function') {
                        organizeReportCards();
                    }
                }, 100);
            });
            
            $(card).addClass('resizing');
            $('body').css('cursor', 'ns-resize');
        });
        
        // Köşe boyutlandırma
        $(cornerHandle).on('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const startX = e.pageX;
            const startY = e.pageY;
            const startWidth = $(card).width();
            const startHeight = $(card).height();
            const parent = $(card).parent();
            const parentWidth = parent.width();
            
            // Grid uyumu için
            const minWidth = Math.floor(parentWidth / 12);
            
            // Taşıma işlemi
            $(document).on('mousemove.resize', function(e) {
                const newWidth = startWidth + (e.pageX - startX);
                const newHeight = startHeight + (e.pageY - startY);
                
                // Genişlik ve yüksekliği güncelle
                if (newWidth >= minWidth) {
                    $(card).width(newWidth + 'px');
                    
                    // Span değerini hesapla
                    const span = Math.max(1, Math.min(12, Math.round((newWidth / parentWidth) * 12)));
                    card.style.gridColumn = `span ${span}`;
                    
                    // data-size özniteliğini güncelle
                    if (span <= 3) {
                        card.setAttribute('data-size', 'small');
                    } else if (span <= 6) {
                        card.setAttribute('data-size', 'medium');
                    } else if (span <= 9) {
                        card.setAttribute('data-size', 'large');
                    } else {
                        card.setAttribute('data-size', 'full');
                    }
                }
                
                if (newHeight >= 100) {
                    $(card).height(newHeight + 'px');
                }
            });
            
            // Taşıma bitti
            $(document).on('mouseup.resize', function() {
                $(document).off('mousemove.resize mouseup.resize');
                
                // Masonry düzenini güncelle
                setTimeout(function() {
                    updateMasonryLayout();
                    if (typeof initializeMasonryLayout === 'function') {
                        initializeMasonryLayout();
                    }
                    if (typeof organizeReportCards === 'function') {
                        organizeReportCards();
                    }
                }, 100);
            });
            
            $(card).addClass('resizing');
            $('body').css('cursor', 'nwse-resize');
        });
        
        // Boyutlandırma tamamlandığında resizing sınıfını kaldır
        $(document).on('mouseup', function() {
            $(card).removeClass('resizing');
            $('body').css('cursor', '');
        });
        
        // Kartı başlatıldı olarak işaretle
        card.classList.add('resizable-initialized');
        
        // Konum için relative ekle
        if (getComputedStyle(card).position === 'static') {
            card.style.position = 'relative';
        }
    });
    
    console.log('Kart boyutlandırma etkinleştirildi');
}

document.addEventListener('DOMContentLoaded', function() {
// ... existing code ...

    // Sayfa yüklendikten sonra düzenleri uygula
    setTimeout(function() {
        // Kartları ölçülendirilebilir yap
        enableCardResizing();
        
        // Masonry düzenini uygula
        updateMasonryLayout();
        
        // Global fonksiyonları çağır
        if (typeof initializeMasonryLayout === 'function') {
            initializeMasonryLayout();
        }
        
        if (typeof organizeReportCards === 'function') {
            organizeReportCards();
        }
    }, 1000);
    
    // Pencere boyutu değiştiğinde masonry düzenini güncelle
    window.addEventListener('resize', function() {
        updateMasonryLayout();
        
        if (typeof initializeMasonryLayout === 'function') {
            initializeMasonryLayout();
        }
    });
    
    // Şablon değiştiğinde kartları yeniden düzenle
    document.addEventListener('templateSelected', function(e) {
        console.log('Şablon değişti, kartlar yeniden düzenleniyor:', e.detail.templateId);
        setTimeout(function() {
            // Kartları ölçülendirilebilir yap
            enableCardResizing();
            
            // Masonry düzenini uygula
            updateMasonryLayout();
            
            // Global fonksiyonları çağır
            if (typeof initializeMasonryLayout === 'function') {
                initializeMasonryLayout();
            }
            
            if (typeof organizeReportCards === 'function') {
                organizeReportCards();
            }
        }, 500);
    });
});
// ... existing code ...
</script>


