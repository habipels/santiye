{% extends "homebase.html" %}
{% load i18n %}
{% load custom_tags %}
{% load static %}
{% block head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.3/css/dataTables.dataTables.css">

    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="{% static 'content/style/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.1.0/dist/css/multi-select-tag.css">
    <script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.1.0/dist/js/multi-select-tag.js"></script>
    <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <script src="https://cdn.datatables.net/v/dt/dt-2.1.6/r-3.0.3/datatables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.2/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
{% endblock head %}
{% block sidebar %}
{% if hash_bilgi %}
  <main>
        <!-- Konva.js ve PDF.js Kütüphaneleri -->
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.7/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

        <div class="page-header">
            <div class="page-info">
                <div class="page-title">
                    <a href="#" onclick="history.back(); return false;"><i class="icon icon-arrow-circle-left"></i></a>
                    {% trans 'İş Emri' %}
                </div>
                <ul class="page-breadcrumb">
                    <li><a href="/{{dil}}/">{% trans 'Dashboard' %}</a></li>
                    <li><a href="#">{% trans 'Şantiye Yönetimi' %}</a></li>
                    <li><a href="#">{% trans 'İş Emri' %}</a></li>
                </ul>
            </div>

            <div class="page-actions">
                <button class="page-primary-btn" onclick="openModal('is-emri-olustur')"><i class="icon icon-new"></i>
                   {% trans 'İş Emri Oluştur' %} </button>
            </div>
        </div>

        <div class="large-stats-card table-card table-detail-card">
            <div class="stats-header">
                <div class="stats-title">{% trans 'İş Emri' %}</div>
                <div class="stats-right">
                    <div class="stats-search">
                        <input type="text" name="stats-search" id="stats-search" placeholder="{% trans 'Ara' %}">
                        <button><i class="icon icon-search"></i></button>
                    </div>
                </div>
            </div>


            <div class="tab-navs">
                <button class="tab-navs-btn active" data-tab="Tümü">{% trans 'Tümü' %}</button>
                <button class="tab-navs-btn " data-tab="New">{% trans 'Yeni' %}</button>
                <button class="tab-navs-btn " data-tab="Tamamlandı">{% trans 'Tamamlanan' %}</button>
                <button class="tab-navs-btn " data-tab="Beklemede">{% trans 'Devam Eden' %}</button>
                <!--<button class="tab-navs-btn " data-tab="İptal Edildi">{% trans 'İptal Edilen' %}</button>-->
            </div>

            <div class="tab-contents">

                <div class="tab-content active" id="tumu">
                    <div class="table-wrapper">
                        <table id="tumu-table">
                            <thead>
                                <tr>
                                          <th scope="col">{% trans 'İş Emri Adı' %}</th>
                                            <th scope="col">{% trans 'Açıklama' %}</th>
                                            <th scope="col">{% trans 'Blok' %}</th>
                                            <th scope="col">{% trans 'Kat' %}</th>
                                            <th scope="col">{% trans 'Kullanıcılar' %}</th>
                                            <th scope="col">{% trans 'Başlangıç' %}</th>
                                            <th scope="col">{% trans 'Hedef Tarih' %}</th>
                                            <th scope="col">{% trans 'Durum' %}</th>
                                            <th scope="col">{% trans 'Öncelik' %}</th>
                                            <th scope="col">{% trans 'Aksiyon' %}</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for i in santiyeler %}
                            
                                        {% if request.user.kullanicilar_db %}
                                                {% kulanici_yetkileri_kullandirt request.user request.user.kullanicilar_db as yetki %}
                                                {% if yetki.yapilacaklar_olusturma %}
                                <tr>
                                    <td>
                                        <div class="task-check">
                                            
                                            {{i.title}}
                                        </div>
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{{ i.aciklama }}</td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">
                                    {% if i.blok %}
                                        {{i.blok.blog_adi}}
                                    {% else %}
                                    {% endif %}
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{% if i.blok %}
                                        {{i.kat}}
                                    {% else %}
                                    {% endif %}</td>
                                    <td>
                                        <div class="td-assigned-people">
                                            <div class="td-assigned-people-profiles">
                                                 {% for yazar in i.yapacaklar.all %}
                                                       <a href="javascript: void(0);"
                                                        class="avatar-group-item"
                                                        data-img="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="{{yazar.last_name}}"> <img
                                                            src="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}" alt="" title="{{yazar.last_name}}" title="{{yazar.last_name}}"
                                                            class="rounded-circle avatar-xxs"> </a>
                                                {% endfor %}
                                                <span>+{{i.yapacaklar.all | length}}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{i.kayit_tarihi|date:'d.m.Y'}}</td>
                                    <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                    <td>
                                    {% isplani_durumu_kontrol i.id as b %}
                                                
                                                {% if i.status == "Inprogress" %}
                                                    <span
                                                    class="status-inprogress stats-lg">{{i.status}}</span>
                                                {% elif i.status == "New" %}
                                                <div class="td-info"><span class="status-highlight stats-lg">Yeni</span></div>
                                                {% elif i.status == "Pending" %}
                                                <div class="td-info"><span class="status-pending stats-lg">Beklemede</span></div>
                                                 {% elif i.status == "Completed" %}
                                                <div class="td-info"><span class="status-success stats-lg">Tamamlandı</span></div>
                                                    {% endif %}
                                                
                                        
                                    </td>
                                    <td>
                                         {% if i.oncelik_durumu == "High" %}
                                    <div class="td-info"><span class="status-cancel stats-lg">{{i.oncelik_durumu}}</span></div>
                        
                                            {% elif i.oncelik_durumu == "Medium" %}
                                            <div class="td-info"><span class="status-orange stats-lg">{{i.oncelik_durumu}}</span></div>
                                            {% elif i.oncelik_durumu == "Low" %}
                                            <div class="td-info"><span class="status-dark stats-lg">{{i.oncelik_durumu}}</span></div>
                                            {% endif %}
                                    </td>
                                    <td>
                                        <div class="td-actions">
                                            <a onclick="yapilacak_duzenle('{{i.id}}')" class="status-success"><i class="icon icon-action-edit"></i></a>
                                            <a onclick="openModal('deleteConfirmationModal{{i.id}}')" class="status-cancel"><i
                                                    class="icon icon-action-delete"></i></a>
                                            <div class="biadago-tooltip">
                                                <a><i class="icon icon-three-dots"></i></a>
                                                <div class="biadago-tooltip-content">
                                                    <a onclick="openModal('durumyenile{{i.id}}')">{% trans 'Durum Güncelle' %}</a>
                                                    <a  onclick="openModal('ilerleme{{i.id}}')">{% trans 'Süreç İzleme' %}</a>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                 {% else %}
                                    {% if request.user in i.yapacaklar.all %}
                                      <tr>
                                    <td>
                                        <div class="task-check">
                                            
                                            {{i.title}}
                                        </div>
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{{ i.aciklama }}</td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">
                                    {% if i.blok %}
                                        {{i.blok.blog_adi}}
                                    {% else %}
                                    {% endif %}
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{% if i.blok %}
                                        {{i.kat}}
                                    {% else %}
                                    {% endif %}</td>
                                    <td>

                                        <div class="td-assigned-people">
                                            <div class="td-assigned-people-profiles">
                                                 {% for yazar in i.yapacaklar.all %}
                                                       <a href="javascript: void(0);"
                                                        class="avatar-group-item"
                                                        data-img="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="{{yazar.last_name}}"> <img
                                                            src="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}" alt="" title="{{yazar.last_name}}"
                                                            class="rounded-circle avatar-xxs"> </a>
                                                {% endfor %}
                                                <span>+{{i.yapacaklar.all | length}}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{i.kayit_tarihi|date:'d.m.Y'}}</td>
                                    <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                    <td>
                                    {% isplani_durumu_kontrol i.id as b %}
                                                
                                                {% if i.status == "Inprogress" %}
                                                    <span
                                                    class="status-inprogress stats-lg">{{i.status}}</span>
                                                {% elif i.status == "New" %}
                                                <div class="td-info"><span class="status-highlight stats-lg">{% trans 'Yeni' %}</span></div>
                                                {% elif i.status == "Pending" %}
                                                <div class="td-info"><span class="status-pending stats-lg">{% trans 'Beklemede' %}</span></div>
                                                 {% elif i.status == "Completed" %}
                                                <div class="td-info"><span class="status-success stats-lg">{% trans 'Tamamlandı' %}</span></div>
                                                    {% endif %}
                                                
                                        
                                    </td>
                                    <td>
                                      {% if i.oncelik_durumu == "High" %}
                                    <div class="td-info"><span class="status-cancel stats-lg">{% trans 'Acil' %}</span></div>
                        
                                            {% elif i.oncelik_durumu == "Medium" %}
                                            <div class="td-info"><span class="status-orange stats-lg">{% trans 'Orta' %}</span></div>
                                            {% elif i.oncelik_durumu == "Low" %}
                                            <div class="td-info"><span class="status-dark stats-lg">{% trans 'Düşük' %}</span></div>
                                            {% endif %}
                                     </td>
                                    <td>
                                        <div class="td-actions">
                                            <a onclick="yapilacak_duzenle('{{i.id}}')" class="status-success"><i class="icon icon-action-edit"></i></a>
                                            <a onclick="openModal('deleteConfirmationModal{{i.id}}')" class="status-cancel"><i
                                                    class="icon icon-action-delete"></i></a>
                                            <div class="biadago-tooltip">
                                                <a><i class="icon icon-three-dots"></i></a>
                                                <div class="biadago-tooltip-content">
                                                    <a onclick="openModal('durumyenile{{i.id}}')">{% trans 'Durum Güncelle' %}</a>
                                                    <a  onclick="openModal('ilerleme{{i.id}}')">{% trans 'Süreç İzleme' %}</a>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                   {% endif %}                                                        
                                                
                                {% endif %}
                                        
                                {% else %}
                                  <tr>
                                    <td>
                                        <div class="task-check">
                                           
                                            {{i.title}}
                                        </div>
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{{ i.aciklama }}</td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">
                                    {% if i.blok %}
                                        {{i.blok.blog_adi}}
                                    {% else %}
                                    {% endif %}
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{% if i.blok %}
                                        {{i.kat}}
                                    {% else %}
                                    {% endif %}</td>
                                    <td>
                                        <div class="td-assigned-people">
                                            <div class="td-assigned-people-profiles">
                                                 {% for yazar in i.yapacaklar.all %}
                                                       <a href="javascript: void(0);"
                                                        class="avatar-group-item"
                                                        data-img="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="{{yazar.last_name}}"> <img
                                                            src="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}" alt="" title="{{yazar.last_name}}"
                                                            class="rounded-circle avatar-xxs"> </a>
                                                {% endfor %}
                                                <span>+{{i.yapacaklar.all | length}}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{i.kayit_tarihi|date:'d.m.Y'}}</td>
                                    <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                    <td>
                                    {% isplani_durumu_kontrol i.id as b %}
                                                
                                                {% if i.status == "Inprogress" %}
                                                    <span
                                                    class="status-inprogress stats-lg">{% trans 'Devam Eden' %}</span>
                                                {% elif i.status == "New" %}
                                                <div class="td-info"><span class="status-highlight stats-lg">{% trans 'Yeniler' %}</span></div>
                                                {% elif i.status == "Pending" %}
                                                <div class="td-info"><span class="status-pending stats-lg">{% trans 'Devam Eden' %}</span></div>
                                                 {% elif i.status == "Completed" %}
                                                <div class="td-info"><span class="status-success stats-lg">{% trans 'Tamamlanan' %}</span></div>
                                                    {% endif %}
                                                
                                        
                                    </td>
                                    <td>
                                    {% if i.oncelik_durumu == "High" %}
                                    <div class="td-info"><span class="status-cancel stats-lg">{% trans 'Acil' %}</span></div>
                        
                                            {% elif i.oncelik_durumu == "Medium" %}
                                            <div class="td-info"><span class="status-orange stats-lg">{% trans 'Orta' %}</span></div>
                                            {% elif i.oncelik_durumu == "Low" %}
                                            <div class="td-info"><span class="status-dark stats-lg">{% trans 'Düşük' %}</span></div>
                                            {% endif %}
                                        
                                    </td>
                                    <td>
                                        <div class="td-actions">
                                            <a onclick="yapilacak_duzenle('{{i.id}}')" class="status-success"><i class="icon icon-action-edit"></i></a>
                                            <a onclick="openModal('deleteConfirmationModal{{i.id}}')" class="status-cancel"><i
                                                    class="icon icon-action-delete"></i></a>
                                                    <a onclick="openModal('ilerleme{{i.id}}')" class="status-view"><i
                                                        class="icon icon-view"></i></a>
                                            <div class="biadago-tooltip">
                                                <a><i class="icon icon-three-dots"></i></a>
                                                <div class="biadago-tooltip-content">
                                                    <a onclick="openModal('durumyenile{{i.id}}')">{% trans 'Durum Güncelle' %}</a>
                                                    <a  onclick="openModal('ilerleme{{i.id}}')">{% trans 'Süreç İzleme' %}</a>
                                                </div>
                                            </div>

                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                </tbody>
                        </table>
                        <style>
                            .dt-buttons {
                                opacity: 0;
                                height: 0;
                                position: fixed;
                                top: 10000px;
                                left: 10000px;
                            } 
                            </style>
                            <div class="large-stats-card-footer-actions">
                                <a onclick="$('.buttons-pdf').click()" class="lsc-footer-action"><i class="icon icon-pdf"></i></a>
                                <a onclick="$('.buttons-excel').click()" class="lsc-footer-action"><i class="icon icon-xlsx"></i></a>
                                <a onclick="$('.buttons-print').click()" class="lsc-footer-action"><i class="icon icon-print"></i></a>
                            </div>                        
                    </div>
                </div>
                 


            </div>

        </div>

        <script>
            let table = new DataTable('#tumu-table', {
                paging: true,
                searching: true,
                info: false,
                ordering: true,
                order: [[3, "desc"]],
                columnDefs: [
            {
                targets: 1,  // Tarih sütununun indeksi (örneğin ikinci sütun)
                render: function(data, type, row) {
                    return type === 'sort' ? moment(data, 'DD MMMM YYYY HH:mm').format('YYYYMMDDHHmm') : data;
                }
            }
        ],
            dom: 'Btip', // Butonları etkinleştirir
            buttons: [
                {
                    extend: 'pdfHtml5',
                    className: 'hidden', // DataTables butonunu gizlemek için
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: { columns: ':visible' },
                    customize: function (doc) {
                        doc.content[1].table.widths = Array(doc.content[1].table.body[0].length).fill('18%'); 
                        doc.pageMargins = [15, 20, 15, 20];
                        doc.defaultStyle = { fontSize: 8 };
                        doc.styles.tableHeader = {
                            fillColor: '#f2f2f2',
                            color: '#333',
                            alignment: 'center'
                        };
                    }
                },
                {
                        extend: 'excelHtml5',
                        className: 'hidden',
                        exportOptions: { columns: ':visible' },
                        customize: function (xlsx) {
                            var sheet = xlsx.xl.worksheets['sheet1.xml'];
                            
                            // Para birimlerinin olduğu sütunları belirleyin (örneğin, 5 ve 6. sütunlar)
                            $('row c[r^="E"], row c[r^="F"]', sheet).each(function () {
                                $(this).attr('s', '2'); // 2 numaralı hücre stiline ayarlanarak sayısal veri olarak işlenecek
                            });

                            // Tarihlerin olduğu sütunları belirleyin (örneğin, 4. sütun)
                            $('row c[r^="D"]', sheet).each(function () {
                                $(this).attr('s', '3'); // 3 numaralı hücre stiline ayarlanarak tarih olarak işlenecek
                            });
                        }
                    },
                {
                    extend: 'print',
                    className: 'hidden',
                    exportOptions: { columns: ':visible' },
                    customize: function (win) {
                        $(win.document.body).css('font-size', '10pt').css('width', '95%').css('margin', 'auto');
                        $(win.document.body).find('table')
                            .addClass('compact')
                            .css('font-size', 'inherit')
                            .css('width', '100%')
                            .css('margin', 'auto');
                    }
                }
            ]
                
            });

            $('.tab-navs-btn').on('click', function () {
                $(".tab-navs-btn").removeClass("active");
                $(this).addClass("active");

                // Eğer "Tümü" sekmesi seçiliyse filtreleme yapmadan tüm verileri göster
                if ($(this).attr("data-tab") == "New") {
                    table.column(5).search("{% trans 'Yeniler' %}").draw();  }
                else if ($(this).attr("data-tab") == "Tümü") {
                    table.search('').columns().search('').draw(); // Tüm verileri gösterir
                }  else if ($(this).attr("data-tab") == "Tamamlandı") {
                    table.column(5).search("{% trans 'Tamamlanan' %}").draw();  // Durumu "Onaylandı" olanları gösterir
                } else if ($(this).attr("data-tab") == "Beklemede") {
                    table.column(5).search("{% trans 'Devam Eden' %}").draw();  // Durumu "Reddedildi" olanları gösterir
                }
            });



             $('#stats-search').keyup(function () {
                table.search($(this).val()).draw();
            
        });
        </script>


    </main>

    <div class="modal" id="is-emri-olustur">
        <div class="modal-inner" style="width: 1000px">
            <div class="modal-header">
            {% trans 'İş Emri Oluştur' %}
               
            </div>
            <div class="modal-body">
               <form autocomplete="off" class="tablelist-form" action="/{{dil}}{% url 'main:yapilacalar_ekle_2' hashler %}" method="post" enctype="multipart/form-data" >
                        {% csrf_token %}
                    <div class="modal-form-rows">
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="baslik">{% trans 'Başlık Ekle' %}</label>
                                <input type="text" required name="baslik" id="baslik" style="text-transform: uppercase;" oninput="convertToUpperCase(this)">
                        
                            </div>
                            <div class="form-element">
                                <label for="aciklama">{% trans 'Açıklama' %}</label>
                                <input type="text" required name="aciklama" id="aciklama" style="text-transform: capitalize;" oninput="capitalizeFirstLetter(this)">
                            </div>
                            <div class="form-row">
                                <div class="form-element">
                                    <label for="durum">{% trans 'Durum' %}</label>
                                   <select name="durum" required class="form-control" data-choices data-choices-search-false id="task-status-input">
                                    <option value="">{% trans 'Status' %}</option>
                                    <option value="New" selected>{% trans 'Yeni' %}</option>
                                    <option value="Inprogress">{% trans 'Devam Ediyor' %}</option>
                                    <option value="Pending">{% trans 'Beklemede' %}</option>
                                    <option value="Completed">{% trans 'Tamamlandı' %}</option>
                                </select>
                                </div>
                                <div class="form-element">
                                    <label for="aciliyet">{% trans 'Öncelik' %}</label>
                                    <select required name="aciliyet" class="form-control" data-choices data-choices-search-false id="priority-field">
                                    
                                    <option value="High">{% trans 'Acil' %}</option>
                                    <option value="Medium">{% trans 'Orta' %}</option>
                                    <option value="Low">{% trans 'Düşük' %}</option>
                                </select>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="kisiler">{% trans 'Atama' %}</label>
                                <p class="input-helper-text">{% trans 'Birden fazla kullanıcı ataması için Windows kullanıcıları Ctrl, Mac kullanıcıları Command (⌘) tuşunu kullanabilir.' %}</p>
                                <select required name="blogbilgisi" class="form-control cokluetiketb" data-trigger multiple  id="cokluetiketb" >
                                {% for blog in blog_bilgisi %}
                                <option value="{{ blog.id }}">{{ blog.last_name }}: {{blog.email}}</option>
                                {% endfor %}
                            </select>
                            </div>
                            <div class="form-element">
                                <label for="tarih">{% trans 'Hedef Tarih:' %}</label>
                                <input required type="date" name="teslim_tarihi"  id="tarih">
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="katman">{% trans 'Plan Katmanı' %}</label>
                                 <select name="katman" id="katmanSelect"  data-trigger >
                                 <option value="" >{% trans 'Lütfen plan katmanını seçiniz.' %}</option>
                                {% for blog in katmanlar %}
                                <option data-id="{{blog.proje_santiye_Ait.id}}" data-img="{{blog.katman_dosyasi.url}}" value="{{ blog.id }}">{{ blog.proje_santiye_Ait.proje_adi }}: {{blog.katman_adi}}</option>
                                {% endfor %}
                            </select>
                                
                            </div>
                       
                            <div class="form-element">
                                <label for="yapi_gonder">{% trans 'Yapı' %}</label>
                                 <select name="yapi_gonder" id="yapiSelect"  data-trigger >
                                
                            </select>
                        </div>
                              <div class="form-element">
                                <label for="kat">{% trans 'kat' %}</label>
                                 <select name="kat" id="odaSelect"  data-trigger >
                               
                            </select>  
                            </div>
                            <div class="form-element">
                                <div class="plan-konumu-preview" onclick="openModal('plan-konumu', false)">
                                    <canvas style="display: none; width: 50vh !important; max-height: 50vh !important;" id="alanpdf"  ></canvas>
                                    <input type="text" hidden name="pin_lokasyunux" id="pin_lokasyunux" >
                                    <input type="text" hidden name="pin_lokasyunuy" id="pin_lokasyunuy" >
                                    <img src="#" style="display: none; max-width: 50vh !important;" alt="Plan Konumu" id="alan" class="alan">
                                    <!-- <img src="{% static 'go/content/images/plan-konumu-preview.png' %}" alt="Plan Konumu">-->
                                    <div id="gizle" class="report-title">{% trans 'Henüz bu projede işaretleme yapmadınız. Proje konumu işaretlemek için tıklayınız.' %} </div>
                                    <textarea name="base_64_format" hidden  id="base_64_format"></textarea>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="ekler">{% trans 'Ekler' %}</label>

                                <div class="file-input file-preview-input">
                                    <ul class="fileList">



                                        <label for="ekler">
                                            <button><i class="icon icon-file"></i> {% trans 'Dosya Seç' %}</button>
                                        </label>
                                    </ul>

                                    <input multiple type="file" name="file" id="ekler">
                                </div>


                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="form-action-secondary" type="button" onclick="closeModal()">{% trans 'Vazgeç' %} </button>
                        <button class="form-action-primary" type="submit">{% trans 'İş Emri Oluştur' %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="plan-konumu">
        <div class="modal-inner modal-fullscreen">
            <div class="modal-header">
                <div class="modal-title">{% trans 'Plan Konumu' %}</div>
                <div class="modal-actions">
                   <!-- <a href="#" class="modal-action-primary"><i class="icon icon-pin"></i> Plan Konumunu Değiştir</a>
                    <a href="#" class="modal-action-remove">Plan Konumunu Sil <i class="icon icon-action-delete"></i></a>-->
                                <!-- Araç Çubuğu -->
                    <div id="toolbar">
                        <input type="file" id="file-upload" accept=".pdf,.jpg,.jpeg,.png"/>
                        <button id="save-btn" class="modal-action-primary"><i class="icon icon-pin"></i>{% trans 'Pinleri Kaydet' %}</button>
                        <button id="capture-btn">{% trans 'Alanı Kırp ve Göster' %}</button>
                    </div>
                    <a onclick="closeModal('plan-konumu')" class="modal-close-btn"><i class="icon icon-modal-close"></i></a>
                </div>
            </div>

                <!-- Konva Container -->
                <div id="container"></div>
                <!-- Modal -->
                <div id="capture-modal" class="modal">
                    <div class="modal-content">
                        <span class="close-btn">&times;</span>
                        <h3>{% trans 'Kırpılmış Alan:' %}</h3>
                        <img id="captured-image" src="" alt="Captured Area">
                        <a id="download-link" href="#" download="captured_area.png">{% trans 'İndir' %}</a>
                    </div>
                </div>
        </div>
    </div>
    <div class="modal" id="is-emri-duzenle">
        <div class="modal-inner" style="width: 1000px">
            <div class="modal-header">
            {% trans 'İş Emri Güncelle' %}
               
            </div>
            <div class="modal-body">
               <form autocomplete="off"class="tablelist-form" action="/{{dil}}{% url 'main:yapilacalar_ekle_duzenleme_2' hashler %}" method="post" enctype="multipart/form-data" >
                        {% csrf_token %}
                        <input type="text" hidden name="id" id="veri_gonderme">
                    <div class="modal-form-rows">
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="baslik">{% trans 'Başlık Ekle' %}</label>
                                <input type="text" required name="baslik" id="baslikd" style="text-transform: uppercase;" oninput="convertToUpperCase(this)">
                            </div>
                            <div class="form-element">
                                <label for="aciklama">{% trans 'Açıklama' %}</label>
                                <input type="text" required name="aciklama" id="aciklamad" style="text-transform: capitalize;" oninput="capitalizeFirstLetter(this)">
                            </div>
                            <div class="form-row">
                                <div class="form-element">
                                    <label for="durum">{% trans 'Durum' %}</label>
                                   <select name="durum" required class="form-control" data-choices data-choices-search-false id="task-status-inputd">
                                    <option value="">{% trans 'Status' %}</option>
                                    <option value="New" selected>{% trans 'Yeni' %}</option>
                                    <option value="Inprogress">{% trans 'Devam Ediyor' %}</option>
                                    <option value="Pending">{% trans 'Beklemede' %}</option>
                                    <option value="Completed">{% trans 'Tamamlandı' %}</option>
                                </select>
                                </div>
                                <div class="form-element">
                                    <label for="aciliyet">{% trans 'Öncelik' %}</label>
                                    <select required name="aciliyet" class="form-control" data-choices data-choices-search-false id="oncelik_d">
                                    
                                    <option value="High">{% trans 'Acil' %}</option>
                                    <option value="Medium">{% trans 'Orta' %}</option>
                                    <option value="Low">{% trans 'Düşük' %}</option>
                                </select>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="kisiler">{% trans 'Atama' %}</label>
                                <p class="input-helper-text">{% trans 'Birden fazla kullanıcı ataması için Windows kullanıcıları Ctrl, Mac kullanıcıları Command (⌘) tuşunu kullanabilir.' %}</p>
                                <select required name="blogbilgisi" class="form-control cokluetiketb" data-trigger multiple  id="cokluetiketb" >
                                {% for blog in blog_bilgisi %}
                                <option value="{{ blog.id }}">{{ blog.last_name }}: {{blog.email}}</option>
                                {% endfor %}
                            </select>
                            </div>
                            <div class="form-element">
                                <label for="tarih">{% trans 'Hedef Tarih:' %}</label>
                                <input required type="date" name="teslim_tarihi"  id="tarihd">
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="katman">{% trans 'Plan Katmanı' %}</label>
                                 <select name="katman" id="katmanSelectd"  data-trigger >
                                {% for blog in katmanlar %}
                                <option data-id="{{blog.proje_santiye_Ait.id}}" data-img="{{blog.katman_dosyasi.url}}" value="{{ blog.id }}">{{ blog.proje_santiye_Ait.proje_adi }}: {{blog.katman_adi}}</option>
                                {% endfor %}
                            </select>
                                
                            </div>
                       
                            <div class="form-element">
                                <label for="yapi_gonder">{% trans 'Yapı' %}</label>
                                 <select name="yapi_gonder" id="yapiSelectd"  data-trigger >
                                
                            </select>
                        </div>
                              <div class="form-element">
                                <label for="kat">{% trans 'kat' %}</label>
                                 <select name="kat" id="odaSelectd"  data-trigger >
                               
                            </select>  
                            </div>
                            <div class="form-element">
                                <div class="plan-konumu-preview" onclick="openModal('plan-konumu', false)">
                                    <canvas style="display: none; width: 50vh !important; height: 50vh !important;" id="alanpdfd"></canvas>
                                    <input type="text" hidden name="pin_lokasyunuxd" id="pin_lokasyunuxd" >
                                    <input type="text" hidden name="pin_lokasyunuyd" id="pin_lokasyunuyd" >
                                    <img src="#" style="display: none; max-width: 50vh !important;" alt="Plan Konumu" id="aland" class="alan">
                                    <!-- <img src="{% static 'go/content/images/plan-konumu-preview.png' %}" alt="Plan Konumu">-->
                                    <div id="gizled" class="report-title">{% trans 'Henüz bu projede işaretleme yapmadınız. Proje konumu işaretlemek için tıklayınız.' %} </div>
                                    <textarea name="base_64_format" hidden  id="base_64_formatd"></textarea>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="ekler">{% trans 'Ekler' %}</label>
    
                                <div class="file-input file-preview-input">
                                    <ul class="fileList">
    
    
    
                                        <label for="ekler">
                                            <button><i class="icon icon-file"></i> {% trans 'Dosya Seç' %}</button>
                                        </label>
                                    </ul>
    
                                    <input multiple type="file" name="file" id="ekler">
                                </div>
    
    
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="form-action-secondary" type="button" onclick="closeModal('is-emri-duzenle')">{% trans 'Vazgeç' %} </button>
                        <button class="form-action-primary" type="submit">{% trans 'Güncelle' %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% for i in santiyeler %}





<div class="modal" id="deleteConfirmationModal{{i.id}}">
    <div class="modal-inner" style="width: 500px">
        <div class="modal-header">
        {% trans 'Silme Uyarısı' %}
            
        </div>
        <div class="modal-body">
            <form autocomplete="off"action="/{{dil}}{% url 'main:yapilacalar_sil_2' hashler %}" method="post">
                {% csrf_token %}
<input type="hidden" id="buttonIdInput" name="id_bilgisi" value="{{i.id}}">
             
                <p> {% trans 'Bu öğeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.' %}</p>
                <div class="form-actions">
                    <button class="form-action-secondary" type="button" onclick="closeModal('deleteConfirmationModal{{i.id}}')">{% trans 'Vazgeç' %}</button>
                    <button class="form-action-danger" type="submit"> {% trans 'Sil' %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <div class="modal" id="ilerleme{{i.id}}">
        <div class="modal-inner" style="width: 500px;">
            <div class="modal-header">
                {% trans 'Süreç İzleme' %}
            </div>
            <div class="modal-body">
                <div class="ilerleme-durumlari">
                    <div class="ilerleme-durumu">
                        <span>{{i.kayit_tarihi}}</span>
                        <div class="ilerleme-durumu-content">
                            {% trans 'Başlık ' %}  {{i.title}} <br>
                            {% trans 'Açıklama ' %}<br>
                            {% trans 'Teslim Tarihi ' %} {{i.teslim_tarihi}} <br>
                            {% trans 'Dosyalar ' %} {% dosya_varsa_indirme_isplani i %}
                            {% trans 'Atamalar: ' %} {% for yazar in i.yapacaklar.all %}
                            {{yazar.last_name}},
                     {% endfor %}

                        </div>
                    </div>
                    {% ilerleme_goster i.id as veriler %}
                        {% for k in  veriler %}
                        <div class="ilerleme-durumu">
                        <span>{{k.kayit_tarihi}}</span>
                        <div class="ilerleme-durumu-content">
                           {% trans 'Personel ' %} {{k.yapan_kisi.last_name}} <br>
                           {% trans 'Açıklama ' %}{{k.aciklama}}<br>
                            {% trans 'Durum ' %}{{k.status}} <br>
                            {% trans 'Hedef Tarih ' %}{{k.teslim_tarihi}}<br>
                            
                        </div>
                            <div class="ilerleme-durumu-dosyalar">
                                {% dosya_varsa_indirme_isplani_ilerleme k.id %}
                                
                               
                            </div>
                        </div>
                    
                    
                        
                    
                        {% endfor %}
                    </div>
                
                </div>
            </div>
        </div>
    </div>


    <div class="modal" id="durumyenile{{i.id}}">
        <div class="modal-inner" style="width: 500px">
            <div class="modal-header">
                {% trans 'İş Emri Düzenle' %}
            </div>
            <div class="modal-body">
                <form autocomplete="off"class="tablelist-form" action="/{{dil}}{% url 'main:yapilacak_durumu_yenileme' %}" method="post" enctype="multipart/form-data" >
                    {% csrf_token %}
                    <input type="hidden" id="taskid-input" name="yenilenecekeklemeyapilacak" value="{{i.id}}" class="form-control">
                    <div class="form-element">
                        <label for="durum">{% trans 'Durum' %}</label>
                       <select name="durum" class="form-control" data-choices data-choices-search-false id="task-status-input">
                        <option value="New" selected>{% trans 'Yeni' %}</option>
                        <option value="Inprogress">{% trans 'Devam Ediyor' %}</option>
                        <option value="Pending">{% trans 'Beklemede' %}</option>
                        <option value="Completed">{% trans 'Tamamlandı' %}</option>
                    </select>
                    </div>
                    
                    <div class="form-element">
                        <label for="aciklama">{% trans 'Açıklama' %}</label>
                        <input type="text"  name="aciklama" id="aciklama" oninput="capitalizeFirstLetter(this)">
                    </div>
                    <div class="form-element">
                        <label for="tarih">{% trans 'Hedef Tarih:' %}</label>
                        <input type="date" value="{{i.teslim_tarihi | date:'Y-m-d'}}" name="teslim_tarihi"  id="tarih">
                    </div>
                    <div class="form-element">
                        <label for="belge-yukle">Belge Yükle</label>

                        <div class="file-input">
                            <label for="belge-yukle">
                                <img src="{% static 'go/content/images/illustration-upload.png' %}">

                                <button><i class="icon icon-file"></i>{% trans 'Dosya Seç' %}</button>
                            </label>

                            <input type="file" name="file" id="belge-yukle">
                        </div>

                        <ul class="fileList">
                        </ul>
                    </div>
                    <div class="form-actions">
                        <button class="form-action-secondary" type="button" onclick="closeModal()">Vazgeç</button>
                        <button class="form-action-primary" type="submit">Güncelle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>




{% endfor %}
<script>
    function capitalizeFirstLetter(input) {
        input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1);
    }
     function convertToUpperCase(input) {
        input.value = input.value.toUpperCase();
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('katmanSelect').addEventListener('change', function() {
            const katmanId = this.value;
            const santiyeId = this.options[this.selectedIndex].getAttribute('data-id');
            //loadPDF(file)
            
            
            document.getElementById('gizle').style.display = "none";
            //alanpdf
            // Tüm elementleri gizle

            // Dosya uzantısını al
            const fileExtension = this.options[this.selectedIndex].getAttribute('data-img').split('.').pop().toLowerCase();

            // Dosya türüne göre işlem yap
            if (fileExtension === "jpg" || fileExtension === "jpeg" || fileExtension === "png" || fileExtension === "gif") {
                const imgElement = document.getElementById('alan');
                imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "block";
                document.getElementById('alanpdf').style.display = "none";
                loadImage(this.options[this.selectedIndex].getAttribute('data-img'));
            } else if (fileExtension === "pdf") {
                var url = this.options[this.selectedIndex].getAttribute('data-img');
                const imgElement = document.getElementById('alan');
                loadPDF(this.options[this.selectedIndex].getAttribute('data-img'));
                //imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "none";
                pdfjsLib.getDocument(url).promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    var canvas = document.getElementById('alanpdf');
                    document.getElementById('alanpdf').style.display = "block";
                    var context = canvas.getContext('2d');
                    var viewport = page.getViewport({ scale: 1.5 });

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                    canvasContext: context,
                    viewport: viewport
                    });
                });
                }); // Yükleniyor mesajını gizle
            }

            fetch(`/get_yapi/${santiyeId}/`)
                .then(response => response.json())
                .then(data => {
                    const yapiSelect = document.getElementById('yapiSelect');
                    const odaSelect = document.getElementById('odaSelect');
                    // Hata kontrolü ekleyelim
                    if (!yapiSelect || !odaSelect) {
                        console.error("Yapı veya oda select öğesi bulunamadı.");
                        return; // Hata varsa burada çıkalım
                    }
                    yapiSelect.innerHTML = '';
                    odaSelect.innerHTML = '';

                    // Yapılar yapiSelect içine ekleniyor
                    data.yapilar.forEach(yapi => {
                        const option = document.createElement('option');
                        option.value = yapi.id;
                        option.setAttribute('data-kat-sayisi', yapi.kat_sayisi);
                        option.textContent = yapi.blog_adi;
                        yapiSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Fetch hatası:", error));
        });

        // Yapı seçildiğinde kat numaralarını odaSelect alanına ekleme
        document.getElementById('yapiSelect').addEventListener('change', function() {
            const selectedYapi = this.options[this.selectedIndex];
            const katSayisi = selectedYapi.getAttribute('data-kat-sayisi');
            const odaSelect = document.getElementById('odaSelect');
            odaSelect.innerHTML = '';

            // Kat numaralarını ekliyoruz
            for (let i = 1; i <= katSayisi; i++) {
                const odaOption = document.createElement('option');
                odaOption.value = i;
                odaOption.textContent = `Kat ${i}`;
                odaSelect.appendChild(odaOption);
            }
        });
        
        document.getElementById('katmanSelectd').addEventListener('change', function() {
            const katmanId = this.value;
            const santiyeId = this.options[this.selectedIndex].getAttribute('data-id');
            //loadPDF(file)
            
            
            document.getElementById('gizled').style.display = "none";
            //alanpdf
            // Tüm elementleri gizle
            // Dosya uzantısını al
            const fileExtension = this.options[this.selectedIndex].getAttribute('data-img').split('.').pop().toLowerCase();

            // Dosya türüne göre işlem yap
            if (fileExtension === "jpg" || fileExtension === "jpeg" || fileExtension === "png" || fileExtension === "gif") {
                const imgElement = document.getElementById('aland');
                imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "block";
                document.getElementById('alanpdfd').style.display = "none";
                loadImage(this.options[this.selectedIndex].getAttribute('data-img'));
            } else if (fileExtension === "pdf") {
                var url = this.options[this.selectedIndex].getAttribute('data-img');
                const imgElement = document.getElementById('aland');
                loadPDF(this.options[this.selectedIndex].getAttribute('data-img'));
                //imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "none";
                pdfjsLib.getDocument(url).promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    var canvas = document.getElementById('alanpdfd');
                    document.getElementById('alanpdfd').style.display = "block";
                    var context = canvas.getContext('2d');
                    var viewport = page.getViewport({ scale: 1.5 });

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                    canvasContext: context,
                    viewport: viewport
                    });
                });
                }); // Yükleniyor mesajını gizle
            }

            fetch(`/get_yapi/${santiyeId}/`)
                .then(response => response.json())
                .then(data => {
                    const yapiSelectd = document.getElementById('yapiSelectd');
                    const odaSelectd = document.getElementById('odaSelectd');
                    // Hata kontrolü ekleyelim
                    if (!yapiSelectd || !odaSelectd) {
                        console.error("Yapı veya oda select öğesi bulunamadı.");
                        return; // Hata varsa burada çıkalım
                    }
                    yapiSelectd.innerHTML = '';
                    odaSelectd.innerHTML = '';

                    // Yapılar yapiSelect içine ekleniyor
                    data.yapilar.forEach(yapi => {
                        const option = document.createElement('option');
                        option.value = yapi.id;
                        option.setAttribute('data-kat-sayisi', yapi.kat_sayisi);
                        option.textContent = yapi.blog_adi;
                        yapiSelectd.appendChild(option);
                    });
                })
                .catch(error => console.error("Fetch hatası:", error));
        });

    });
</script>
<script>
    document.getElementById('yapiSelectd').addEventListener('change', function() {
            const selectedYapi = this.options[this.selectedIndex];
            const katSayisi = selectedYapi.getAttribute('data-kat-sayisi');
            const odaSelect = document.getElementById('odaSelectd');
            odaSelect.innerHTML = '';

            // Kat numaralarını ekliyoruz
            for (let i = 1; i <= katSayisi; i++) {
                const odaOption = document.createElement('option');
                odaOption.value = i;
                odaOption.textContent = `Kat ${i}`;
                odaSelect.appendChild(odaOption);
            }
        });
</script>
<script>
    
        function yapilacak_duzenle(santiyeId) {
        
    
    fetch(`/yapilacak/${santiyeId}/`)
            .then(response => response.json())
            .then(data => {
                
                document.getElementById("baslikd").value = data.title;
                document.getElementById("aciklamad").value = data.aciklama;
                document.getElementById("tarihd").value = data.teslim_tarihi;
                document.getElementById("veri_gonderme").value = data.id;
                a = document.getElementById("task-status-inputd");
                const option = document.createElement('option');
                option.value = data.status;
                option.selected = true;
                option.textContent = data.status;
                a.appendChild(option);

                b = document.getElementById("oncelik_d");
                const d = document.createElement('option');
                d.value = data.oncelik_durumu;
                d.selected = true;
                d.textContent = data.oncelik_durumu;
                b.appendChild(d);  // Burada d eklenmeli, option değil!
                const c = document.getElementById("katmanSelectd");
                addPin(data.locasyonx, data.locasyony)
const z = document.createElement('option');

if (data.katman_id) {
    z.setAttribute('data-id', data.katman_id);  // data-id özelliğini doğru şekilde ayarlıyoruz
} else {
    console.warn("katman_id bulunamadı!");
}

if (data.katman_dosyasi) {
    z.setAttribute('data-img', data.katman_dosyasi);  // data-img özelliğini doğru şekilde ayarlıyoruz
    const fileExtension = data.katman_dosyasi.split('.').pop().toLowerCase();
    
    // Dosya türüne göre işlem yap
    if (fileExtension === "jpg" || fileExtension === "jpeg" || fileExtension === "png" || fileExtension === "gif") {
        loadImage(data.katman_dosyasi);
    } else if (fileExtension === "pdf") {
        loadPDF(data.katman_dosyasi);
    } else {
        console.warn("Desteklenmeyen dosya türü: " + fileExtension);
    }
} else {
    console.warn("katman_dosyasi bulunamadı!");
}

if (data.katman) {
    z.textContent = data.katman;  // Görüntülenecek metin
    z.selected = true;  // Seçili yapmak için doğru kullanım
    c.appendChild(z);  // Seçenek ekleniyor
} else {
    console.warn("katman bulunamadı!");
}

// Yapi seçimi
const yapi_select = document.getElementById("yapiSelectd");
if (data.blok_id && data.blok) {
    const yapi_veri = document.createElement('option');
    yapi_veri.value = data.blok_id;
    yapi_veri.selected = true;
    yapi_veri.textContent = data.blok;
    yapi_select.appendChild(yapi_veri);  // Burada d eklenmeli, option değil!
} else {
    console.warn("blok_id veya blok bulunamadı!");
}

// Oda seçimi
const kat = document.getElementById("odaSelectd");
if (data.kat) {
    const kat_veri = document.createElement('option');
    kat_veri.value = data.kat;
    kat_veri.selected = true;
    kat_veri.textContent = data.kat;
    kat.appendChild(kat_veri);
} else {
    console.warn("kat bulunamadı!");
}

// Görüntüyü ayarlama
if (data.isaretli) {
    document.getElementById("aland").src = data.isaretli;
    document.getElementById("aland").style.display = "block";
} else {
    console.warn("isaretli bulunamadı!");
}

// Modal açma
openModal("is-emri-duzenle");

            })
            .catch(error => console.error("Fetch hatası:", error));
        }   
      
</script>

<script>
        // Konva Stage ve Layer'ları oluşturma
        const stage = new Konva.Stage({
            container: 'container',
            width: window.innerWidth,
            height: window.innerHeight,
            draggable: true  // Panning
        });

        const gridLayer = new Konva.Layer();      // Izgara katmanı
        const imageLayer = new Konva.Layer();     // PDF veya Resim katmanı
        const pinLayer = new Konva.Layer();       // Pinler katmanı

        // Katmanları doğru sırayla ekleyerek pinLayer'ın en üstte olmasını sağla
        stage.add(gridLayer);
        stage.add(imageLayer);
        stage.add(pinLayer);

        // Izgara çizme fonksiyonu
        function drawGrid(layer, gridSize = 100) {
            layer.destroyChildren(); // Önceki çizimleri temizle
            const lines = [];

            // Izgara alanını çok geniş tutarak "sonsuz" gibi görünmesini sağlıyoruz
            const gridLimit = 10000; // Gridin genişliği ve yüksekliği

            // Dikey çizgiler
            for (let i = -gridLimit; i <= gridLimit; i += gridSize) {
                lines.push(new Konva.Line({
                    points: [i, -gridLimit, i, gridLimit],
                    stroke: '#ddd', // Izgara çizgi rengi
                    strokeWidth: 1
                }));
            }

            // Yatay çizgiler
            for (let j = -gridLimit; j <= gridLimit; j += gridSize) {
                lines.push(new Konva.Line({
                    points: [-gridLimit, j, gridLimit, j],
                    stroke: '#ddd', // Izgara çizgi rengi
                    strokeWidth: 1
                }));
            }

            layer.add(...lines);
            layer.batchDraw();
        }

        drawGrid(gridLayer, 100); // Izgara katmanını çiz

        // Pin simgesi için SVG veri URI
        const pinSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path fill="red" d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5 14.5 7.6 14.5 9 13.4 11.5 12 11.5z"/>
            </svg>
        `;
        const pinImageSrc = 'data:image/svg+xml;base64,' + btoa(pinSVG);

        // Tek pin için referans
        let currentPin = null;

        // Pin ekleme fonksiyonu
        function addPin(x, y) {
            // Önceki pin varsa sil
            if (currentPin) {
                currentPin.destroy();
                currentPin = null;
            }

            const pin = new Konva.Image({
                x: x - 12,  // Centering (pin genişliği yarısı)
                y: y - 24,  // Adjust to show tip (pin yüksekliği)
                width: 24,
                height: 24,
                image: new Image(),
                draggable: false  // Pin sürüklenemez
            });

            const img = new Image();
            img.onload = () => {
                pin.image(img);
                pinLayer.add(pin);
                pinLayer.batchDraw();
                currentPin = pin; // Yeni pin referansını güncelle
            };
            img.src = pinImageSrc;

            // Sağ tıklama ile pin silme (masaüstü)
            pin.on('contextmenu', function(e) {
                e.evt.preventDefault();
                pin.destroy();
                pinLayer.batchDraw();
                currentPin = null;
            });

            // Uzun basma ile pin silme (mobil)
            pin.on('touchstart', function(e) {
                if (e.evt.touches && e.evt.touches.length > 1) return; // Çoklu dokunuşları yoksay
                // Uzun basma algılama
                const duration = 500; // 500ms uzun basma
                let timer;

                const touchMoveHandler = () => {
                    clearTimeout(timer);
                };

                const touchEndHandler = () => {
                    clearTimeout(timer);
                    window.removeEventListener('touchmove', touchMoveHandler);
                    window.removeEventListener('touchend', touchEndHandler);
                };

                window.addEventListener('touchmove', touchMoveHandler);
                window.addEventListener('touchend', touchEndHandler);

                timer = setTimeout(() => {
                    pin.destroy();
                    pinLayer.batchDraw();
                    currentPin = null;
                    window.removeEventListener('touchmove', touchMoveHandler);
                    window.removeEventListener('touchend', touchEndHandler);
                }, duration);
            });
        }

        // Stage'in scale ve position bilgilerine göre içerik koordinatlarını hesaplama
        function getTransformedPointerPosition() {
            const pointer = stage.getPointerPosition();
            if (!pointer) return null;
            const transform = stage.getAbsoluteTransform().copy().invert();
            return transform.point(pointer);
        }

        // Pin ekleme fonksiyonu - Sahneye tıklama veya dokunma
        stage.on('click tap', function(e) {
            // Dragging olmadığında pin ekle
            if (!stage.isDragging()) {
                const pos = getTransformedPointerPosition();
                if (pos) {
                    addPin(pos.x, pos.y);
                }
            }
        });

        // Zoom işlevi - Konva.js örneğinden uyarlanmıştır
        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const oldScale = stage.scaleX();
            const pointer = stage.getPointerPosition();

            const scaleBy = 1.1;
            let newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            newScale = Math.max(0.1, Math.min(newScale, 10)); // Zoom sınırları

            stage.scale({ x: newScale, y: newScale });

            // Zoom odak noktası
            const mousePointTo = {
                x: (pointer.x - stage.x()) / oldScale,
                y: (pointer.y - stage.y()) / oldScale,
            };

            const newPos = {
                x: pointer.x - mousePointTo.x * newScale,
                y: pointer.y - mousePointTo.y * newScale,
            };
            stage.position(newPos);
            stage.batchDraw();

            // Pinlerin ölçeğini sabit tutmak için her zoom işleminde pinleri ters orantılı ölçeklendir
            if (currentPin) {
                currentPin.scale({ x: 1 / newScale, y: 1 / newScale });
                pinLayer.batchDraw();
            }
        });

        // PDF yükleme fonksiyonu
        async function loadPDF(fileUrl) {
    try {
        // PDF URL'den alınarak Blob'a dönüştürülüyor
        const response = await fetch(fileUrl);
        if (!response.ok) throw new Error("PDF yüklenemedi.");
        const fileBlob = await response.blob();
        
        const fileReader = new FileReader();
        fileReader.onload = async function(event) {
            const typedArray = new Uint8Array(event.target.result);
            const pdf = await pdfjsLib.getDocument(typedArray).promise;
            console.log("PDF Yüklendi:", pdf);

            const page = await pdf.getPage(1);  // İlk sayfayı yükle
            const scale = 1.5;  // Performans için ölçek
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;
            console.log("PDF Render Edildi.");

            // PDF'in canvas'ını Konva sahnesine ekle
            const pdfImage = new Konva.Image({
                x: 0,
                y: 0,
                image: canvas,
                width: viewport.width,
                height: viewport.height,
                draggable: false,
            });

            imageLayer.destroyChildren(); // Önceki görüntüyü sil
            imageLayer.add(pdfImage);
            imageLayer.batchDraw();
        };
        fileReader.readAsArrayBuffer(fileBlob);
    } catch (error) {
        console.error("PDF Yükleme Hatası:", error);
        alert("PDF dosyası yüklenemedi. Lütfen geçerli bir PDF dosyası yükleyin.");
    }
}


        function loadImage(filePath) {
    const img = new Image();
    img.onload = function() {
        const konvaImage = new Konva.Image({
            x: 0,
            y: 0,
            image: img,
            width: img.width,
            height: img.height,
            draggable: false,
        });

        imageLayer.destroyChildren(); // Önceki görüntüyü sil
        imageLayer.add(konvaImage);   // Yeni görüntüyü ekle
        imageLayer.batchDraw();       // Katmanı yeniden çiz
    };
    
    img.src = filePath; // Buraya tam URL'yi ekleyin
}

// Dosyayı sunucudan yüklemek için tam URL ile çağırın:


        // Dosya yükleme işlemi
        document.getElementById('file-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type === 'application/pdf') {
                    loadPDF(file);
                } else if (file.type.startsWith('image/')) {
                    loadImage(file);
                } else {
                    alert("Lütfen geçerli bir PDF veya resim dosyası yükleyin!");
                }
            }
        });

        // Kaydet butonu - pin koordinatlarını kaydetme
        document.getElementById('save-btn').addEventListener('click', function() {
            if (currentPin) {
                const pinData = {
                    x: currentPin.x(),
                    y: currentPin.y(),
                };
                document.getElementById("pin_lokasyunux").value = currentPin.x();
                document.getElementById("pin_lokasyunuy").value = currentPin.y();
                document.getElementById("pin_lokasyunuxd").value = currentPin.x();
                document.getElementById("pin_lokasyunuyd").value = currentPin.y();
                closeModal('plan-konumu', false)
                if (!currentPin) {
                alert("Lütfen bir pin ekleyin.");
                return;
            }

            // Pin'in sahnedeki tam konumunu al
            const pinStagePos = currentPin.getAbsolutePosition();
            if (!pinStagePos) {
                alert("Pin pozisyonu alınamadı.");
                return;
            }
            const pinStageX = pinStagePos.x;
            const pinStageY = pinStagePos.y;

            console.log(`Pin'in stage koordinatları: (${pinStageX}, ${pinStageY})`);

            // 700x250 px'lik alanın sol üst köşesini hesapla (pin merkezde olacak)
            const captureWidth = 700;
            const captureHeight = 250;
            let captureX = pinStageX - (captureWidth / 2);
            let captureY = pinStageY - (captureHeight / 2);

            console.log(`Kırpılacak alanın sol üst köşesi: (${captureX}, ${captureY})`);

            // Kırpılacak alanın stage sınırları içinde kalmasını sağla
            captureX = Math.max(0, Math.min(captureX, stage.width() - captureWidth));
            captureY = Math.max(0, Math.min(captureY, stage.height() - captureHeight));

            console.log(`Sınırlandırılmış kırpma koordinatları: (${captureX}, ${captureY})`);

            // stage.toDataURL ile tüm katmanları dahil ederek kırp
            stage.toDataURL({
                x: captureX,
                y: captureY,
                width: captureWidth,
                height: captureHeight,
                pixelRatio: 1,
                callback: function(dataURL) {
                    // PNG oluştur ve göster
                    const capturedImage = document.getElementById('captured-image');
                    capturedImage.src = dataURL;
                    const isImage = dataURL.startsWith("data:image/");
                    const isPDF = dataURL.startsWith("data:application/pdf");
                    // İndirme linkini güncelle
                    if (isImage) {
                        const downloadLink = document.getElementById('download-link');
                    downloadLink.href = dataURL;
                    document.getElementById('alan').src = dataURL;
                    document.getElementById('alan').style.display = "block";
                    document.getElementById('alanpdf').style.display = "none";
                    document.getElementById('base_64_format').textContent = dataURL;
                    document.getElementById('aland').src = dataURL;
                    document.getElementById('aland').style.display = "block";
                    document.getElementById('alanpdfd').style.display = "none";
                    document.getElementById('base_64_formatd').textContent = dataURL;
                    closeModal("plan-konumu");
                    }
                    else if(isPDF){
                        alert("pdf")
                    }
                    
                   
                }
            });
                
                console.log('Pin Bilgileri:', JSON.stringify(pinData));
                alert("{% trans 'Pin başarıyla kaydedildi!' %}");
            }
            else{
                alert("{% trans 'Henüz pin eklenmedi.' %}");
            }
        });

        // Pencere yeniden boyutlandırıldığında sahneyi yeniden ayarlama
        window.addEventListener('resize', function() {
            stage.width(window.innerWidth);
            stage.height(window.innerHeight);
            drawGrid(gridLayer, 100); // Izgara katmanını yeniden çiz
            imageLayer.batchDraw();
            pinLayer.batchDraw();
        });

        // Modal kontrolü
        const modal = document.getElementById('capture-modal');
        const closeBtn = document.querySelector('.close-btn');

        // Modalı kapatma fonksiyonu
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        // Modal dışında tıklayınca kapatma
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Area Capture (700x250 px) fonksiyonu
        document.getElementById('capture-btn').addEventListener('click', function() {
            if (!currentPin) {
                alert("Lütfen bir pin ekleyin.");
                return;
            }

            // Pin'in sahnedeki tam konumunu al
            const pinStagePos = currentPin.getAbsolutePosition();
            if (!pinStagePos) {
                alert("Pin pozisyonu alınamadı.");
                return;
            }
            const pinStageX = pinStagePos.x;
            const pinStageY = pinStagePos.y;

            console.log(`Pin'in stage koordinatları: (${pinStageX}, ${pinStageY})`);

            // 700x250 px'lik alanın sol üst köşesini hesapla (pin merkezde olacak)
            const captureWidth = 700;
            const captureHeight = 250;
            let captureX = pinStageX - (captureWidth / 2);
            let captureY = pinStageY - (captureHeight / 2);

            console.log(`Kırpılacak alanın sol üst köşesi: (${captureX}, ${captureY})`);

            // Kırpılacak alanın stage sınırları içinde kalmasını sağla
            captureX = Math.max(0, Math.min(captureX, stage.width() - captureWidth));
            captureY = Math.max(0, Math.min(captureY, stage.height() - captureHeight));

            console.log(`Sınırlandırılmış kırpma koordinatları: (${captureX}, ${captureY})`);

            // stage.toDataURL ile tüm katmanları dahil ederek kırp
            stage.toDataURL({
                x: captureX,
                y: captureY,
                width: captureWidth,
                height: captureHeight,
                pixelRatio: 1,
                callback: function(dataURL) {
                    // PNG oluştur ve göster
                    const capturedImage = document.getElementById('captured-image');
                    capturedImage.src = dataURL;

                    // İndirme linkini güncelle
                    const downloadLink = document.getElementById('download-link');
                    downloadLink.href = dataURL;
                    downloadLink.download = 'captured_area.png';

                    // Modalı göster
                    modal.style.display = "block";
                }
            });
        });
    </script>
    <script>
        function openModal(modalID, close = true) {
            if (close) {
                closeModal();
            }
            if (modalID === "plan-konumu") {
                $("#" + modalID).css({
                    "display": "flex",
                    "z-index": 100000
                }).hide().fadeIn();
            } else {
                $("#" + modalID).css("display", "flex").hide().fadeIn();
            }
        }

        function closeModal(modalID = "") {
            console.log(modalID.length);
            if (modalID.length === 0) {
                $(".modal").fadeOut();
            } else {
                $("#" + modalID).fadeOut();
            }
        }

        $(".modal").on("click", function (e) {
            if ($(e.target).closest('.modal-inner').length === 0 && $(e.target).closest('.modal').length) {
                closeModal();
            }
        });

        $(document).ready(function () {
            $('input[type="file"]').on('change', function () {
                var files = $(this).prop('files');
                var formElement = $(this).closest('.form-element');
                var fileList = formElement.find('.fileList');
                fileList.find('li:not(label)').remove();

                var selectedFiles = Array.from(files);

                for (var i = 0; i < selectedFiles.length; i++) {
                    (function (file) {
                        var listItem = $('<li></li>');

                        if (file.type.startsWith('image/') && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/webp')) {
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                listItem.append(`
                                    <div class="file-input-uploaded">
                                        <div class="file-input-uploaded-head">
                                            <div class="file-input-uploaded-title" title="${file.name}">${file.name}</div>
                                            <button type="button" class="file-input-uploaded-remove"><i class="icon icon-trash"></i></button>
                                        </div>
                                        <div class="file-input-uploaded-preview">
                                            <img src="${e.target.result}">
                                        </div>
                                    </div>
                                `);
                                fileList.append(listItem);

                                listItem.find('.file-input-uploaded-remove').on('click', function () {
                                    $(this).closest('li').remove();
                                    selectedFiles = selectedFiles.filter(f => f.name !== file.name);
                                    updateInput(selectedFiles);
                                });
                            };
                            reader.readAsDataURL(file);
                        } else {
                            listItem.append(`
                                <div class="file-input-uploaded">
                                    <div class="file-input-uploaded-head">
                                        <div class="file-input-uploaded-title" title="${file.name}">${file.name}</div>
                                        <button type="button" class="file-input-uploaded-remove"><i class="icon icon-trash"></i></button>
                                    </div>
                                    <div class="file-input-uploaded-no-preview">
                                        <img src="{% static 'go/content/images/illustration-upload.png' %}">
                                    </div>
                                </div>
                            `);
                            fileList.append(listItem);

                            listItem.find('.file-input-uploaded-remove').on('click', function () {
                                $(this).closest('li').remove();
                                selectedFiles = selectedFiles.filter(f => f.name !== file.name);
                                updateInput(selectedFiles);
                            });
                        }
                    })(selectedFiles[i]);
                }
            });
        });

        function updateInput(selectedFiles) {
            var dataTransfer = new DataTransfer();
            selectedFiles.forEach(function (file) {
                dataTransfer.items.add(file);
            });
            $('input[type="file"]').prop('files', dataTransfer.files);
        }


    </script>

{% else %}
  <main>
        <!-- Konva.js ve PDF.js Kütüphaneleri -->
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.7/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

        <div class="page-header">
            <div class="page-info">
                <div class="page-title">
                    <a href="#" onclick="history.back(); return false;"><i class="icon icon-arrow-circle-left"></i></a>
                    {% trans 'İş Emri' %}
                </div>
                <ul class="page-breadcrumb">
                    <li><a href="/{{dil}}/">{% trans 'Dashboard' %}</a></li>
                    <li><a href="#">{% trans 'Şantiye Yönetimi' %}</a></li>
                    <li><a href="#">{% trans 'İş Emri' %}</a></li>
                </ul>
            </div>

            <div class="page-actions">
                <button class="page-primary-btn" onclick="openModal('is-emri-olustur')"><i class="icon icon-new"></i>
                   {% trans 'İş Emri Oluştur' %} </button>
            </div>
        </div>

        <div class="large-stats-card table-card table-detail-card">
            <div class="stats-header">
                <div class="stats-title">{% trans 'İş Emri' %}</div>
                <div class="stats-right">
                    <div class="stats-search">
                        <input type="text" name="stats-search" id="stats-search" placeholder="{% trans 'Ara' %}">
                        <button><i class="icon icon-search"></i></button>
                    </div>
                </div>
            </div>


            <div class="tab-navs">
                <button class="tab-navs-btn active" data-tab="Tümü">{% trans 'Tümü' %}</button>
                <button class="tab-navs-btn " data-tab="New">{% trans 'Yeni' %}</button>
                <button class="tab-navs-btn " data-tab="Tamamlandı">{% trans 'Tamamlanan' %}</button>
                <button class="tab-navs-btn " data-tab="Beklemede">{% trans 'Devam Eden' %}</button>
                <!--<button class="tab-navs-btn " data-tab="İptal Edildi">{% trans 'İptal Edilen' %}</button>-->
            </div>

            <div class="tab-contents">

                <div class="tab-content active" id="tumu">
                    <div class="table-wrapper">
                        <table id="tumu-table">
                            <thead>
                                <tr>
                                          <th scope="col">{% trans 'İş Emri Adı' %}</th>
                                            <th scope="col">{% trans 'Açıklama' %}</th>
                                            <th scope="col">{% trans 'Blok' %}</th>
                                            <th scope="col">{% trans 'Kat' %}</th>
                                      
                                            <th scope="col">{% trans 'Kullanıcılar' %}</th>
                                            <th scope="col">{% trans 'Başlangıç' %}</th>
                                            <th scope="col">{% trans 'Hedef Tarih' %}</th>
                                            <th scope="col">{% trans 'Durum' %}</th>
                                            <th scope="col">{% trans 'Öncelik' %}</th>
                                            <th scope="col">{% trans 'Aksiyon' %}</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for i in santiyeler %}
                            
                                        {% if request.user.kullanicilar_db %}
                                                {% kulanici_yetkileri_kullandirt request.user request.user.kullanicilar_db as yetki %}
                                                {% if yetki.yapilacaklar_olusturma %}
                                <tr>
                                    <td>
                                        <div class="task-check">
                                            
                                            {{i.title}}
                                        </div>
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{{ i.aciklama }}</td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">
                                    {% if i.blok %}
                                        {{i.blok.blog_adi}}
                                    {% else %}
                                    {% endif %}
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{% if i.blok %}
                                        {{i.kat}}
                                    {% else %}
                                    {% endif %}</td>
                                    <td>
                                        <div class="td-assigned-people">
                                            <div class="td-assigned-people-profiles">
                                                 {% for yazar in i.yapacaklar.all %}
                                                       <a href="javascript: void(0);"
                                                        class="avatar-group-item"
                                                        data-img="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="{{yazar.last_name}}"> <img
                                                            src="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}" alt="" title="{{yazar.last_name}}"
                                                            class="rounded-circle avatar-xxs"> </a>
                                                {% endfor %}
                                                <span>+{{i.yapacaklar.all | length}}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{i.kayit_tarihi |date:'d.m.Y'}}</td>
                                    <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                    <td>
                                    {% isplani_durumu_kontrol i.id as b %}
                                                
                                                {% if i.status == "Inprogress" %}
                                                    <span
                                                    class="status-inprogress stats-lg">{{i.status}}</span>
                                                {% elif i.status == "New" %}
                                                <div class="td-info"><span class="status-highlight stats-lg">{% trans 'Yeni' %}</span></div>
                                                {% elif i.status == "Pending" %}
                                                <div class="td-info"><span class="status-pending stats-lg">{% trans 'Beklemede' %}</span></div>
                                                 {% elif i.status == "Completed" %}
                                                <div class="td-info"><span class="status-success stats-lg">{% trans 'Tamamlandı' %}</span></div>
                                                    {% endif %}
                                                
                                        
                                    </td>
                                    <td>
                                         {% if i.oncelik_durumu == "High" %}
                                    <div class="td-info"><span class="status-cancel stats-lg">{{i.oncelik_durumu}}</span></div>
                        
                                            {% elif i.oncelik_durumu == "Medium" %}
                                            <div class="td-info"><span class="status-orange stats-lg">{{i.oncelik_durumu}}</span></div>
                                            {% elif i.oncelik_durumu == "Low" %}
                                            <div class="td-info"><span class="status-dark stats-lg">{{i.oncelik_durumu}}</span></div>
                                            {% endif %}
                                    </td>
                                    <td>
                                        <div class="td-actions">
                                            <a onclick="yapilacak_duzenle('{{i.id}}')" class="status-success"><i class="icon icon-action-edit"></i></a>
                                            <a onclick="openModal('deleteConfirmationModal{{i.id}}')" class="status-cancel"><i
                                                    class="icon icon-action-delete"></i></a>
                                            <div class="biadago-tooltip">
                                                <a><i class="icon icon-three-dots"></i></a>
                                                <div class="biadago-tooltip-content">
                                                    <a onclick="openModal('durumyenile{{i.id}}')">{% trans 'Durum Güncelle' %}</a>
                                                    <a  onclick="openModal('ilerleme{{i.id}}')">{% trans 'Süreç İzleme' %}</a>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                 {% else %}
                                    {% if request.user in i.yapacaklar.all %}
                                      <tr>
                                    <td>
                                        <div class="task-check">
                                            
                                            {{i.title}}
                                        </div>
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{{ i.aciklama }}</td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">
                                    {% if i.blok %}
                                        {{i.blok.blog_adi}}
                                    {% else %}
                                    {% endif %}
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{% if i.blok %}
                                        {{i.kat}}
                                    {% else %}
                                    {% endif %}</td>
                                    <td>
                                        <div class="td-assigned-people">
                                            <div class="td-assigned-people-profiles">
                                                 {% for yazar in i.yapacaklar.all %}
                                                       <a href="javascript: void(0);"
                                                        class="avatar-group-item"
                                                        data-img="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="{{yazar.last_name}}"> <img
                                                            src="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}" alt="" title="{{yazar.last_name}}"
                                                            class="rounded-circle avatar-xxs"> </a>
                                                {% endfor %}
                                                <span>+{{i.yapacaklar.all | length}}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{i.kayit_tarihi|date:'d.m.Y'}}</td>
                                    <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                    <td>
                                    {% isplani_durumu_kontrol i.id as b %}
                                                
                                                {% if i.status == "Inprogress" %}
                                                    <span
                                                    class="status-inprogress stats-lg">{{i.status}}</span>
                                                {% elif i.status == "New" %}
                                                <div class="td-info"><span class="status-highlight stats-lg">{% trans 'Yeni' %}</span></div>
                                                {% elif i.status == "Pending" %}
                                                <div class="td-info"><span class="status-pending stats-lg">{% trans 'Beklemede' %}</span></div>
                                                 {% elif i.status == "Completed" %}
                                                <div class="td-info"><span class="status-success stats-lg">{% trans 'Tamamlandı' %}</span></div>
                                                    {% endif %}
                                                
                                        
                                    </td>
                                    <td>
                                      {% if i.oncelik_durumu == "High" %}
                                    <div class="td-info"><span class="status-cancel stats-lg">{% trans 'Acil' %}</span></div>
                        
                                            {% elif i.oncelik_durumu == "Medium" %}
                                            <div class="td-info"><span class="status-orange stats-lg">{% trans 'Orta' %}</span></div>
                                            {% elif i.oncelik_durumu == "Low" %}
                                            <div class="td-info"><span class="status-dark stats-lg">{% trans 'Düşük' %}</span></div>
                                            {% endif %}
                                     </td>
                                    <td>
                                        <div class="td-actions">
                                            <a onclick="yapilacak_duzenle('{{i.id}}')" class="status-success"><i class="icon icon-action-edit"></i></a>
                                            <a onclick="openModal('deleteConfirmationModal{{i.id}}')" class="status-cancel"><i
                                                    class="icon icon-action-delete"></i></a>
                                            <div class="biadago-tooltip">
                                                <a><i class="icon icon-three-dots"></i></a>
                                                <div class="biadago-tooltip-content">
                                                    <a onclick="openModal('durumyenile{{i.id}}')">{% trans 'Durum Güncelle' %}</a>
                                                    <a  onclick="openModal('ilerleme{{i.id}}')">{% trans 'Süreç İzleme' %}</a>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                   {% endif %}                                                        
                                                
                                {% endif %}
                                        
                                {% else %}
                                  <tr>
                                    <td>
                                        <div class="task-check">
                                           
                                            {{i.title}}
                                        </div>
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{{ i.aciklama }}</td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">
                                    {% if i.blok %}
                                        {{i.blok.blog_adi}}
                                    {% else %}
                                    {% endif %}
                                    </td>
                                    <td style="text-transform: capitalize; text-align: left; padding-left: 10px;">{% if i.blok %}
                                        {{i.kat}}
                                    {% else %}
                                    {% endif %}</td>
                                    <td>
                                        <div class="td-assigned-people">
                                            <div class="td-assigned-people-profiles">
                                                 {% for yazar in i.yapacaklar.all %}
                                                       <a href="javascript: void(0);"
                                                        class="avatar-group-item"
                                                        data-img="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="{{yazar.last_name}}"> <img
                                                            src="{% if yazar.image %}{{yazar.image.url}}{% else %}{% static 'assets/images/users/avatar-1.jpg' %}{% endif %}" alt="" title="{{yazar.last_name}}"
                                                            class="rounded-circle avatar-xxs"> </a>
                                                {% endfor %}
                                                <span>+{{i.yapacaklar.all | length}}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{i.kayit_tarihi|date:'d.m.Y'}}</td>
                                    <td>{{i.teslim_tarihi|date:'d.m.Y'}}</td>
                                    <td>
                                    {% isplani_durumu_kontrol i.id as b %}
                                                
                                                {% if i.status == "Inprogress" %}
                                                    <span
                                                    class="status-inprogress stats-lg">{% trans 'Devam Eden' %}</span>
                                                {% elif i.status == "New" %}
                                                <div class="td-info"><span class="status-highlight stats-lg">{% trans 'Yeniler' %}</span></div>
                                                {% elif i.status == "Pending" %}
                                                <div class="td-info"><span class="status-pending stats-lg">{% trans 'Devam Eden' %}</span></div>
                                                 {% elif i.status == "Completed" %}
                                                <div class="td-info"><span class="status-success stats-lg">{% trans 'Tamamlanan' %}</span></div>
                                                    {% endif %}
                                                
                                        
                                    </td>
                                    <td>
                                    {% if i.oncelik_durumu == "High" %}
                                    <div class="td-info"><span class="status-cancel stats-lg">{% trans 'Acil' %}</span></div>
                        
                                            {% elif i.oncelik_durumu == "Medium" %}
                                            <div class="td-info"><span class="status-orange stats-lg">{% trans 'Orta' %}</span></div>
                                            {% elif i.oncelik_durumu == "Low" %}
                                            <div class="td-info"><span class="status-dark stats-lg">{% trans 'Düşük' %}</span></div>
                                            {% endif %}
                                        
                                    </td>
                                    <td>
                                        <div class="td-actions">
                                            <a onclick="yapilacak_duzenle('{{i.id}}')" class="status-success"><i class="icon icon-action-edit"></i></a>
                                            <a onclick="openModal('deleteConfirmationModal{{i.id}}')" class="status-cancel"><i
                                                    class="icon icon-action-delete"></i></a>
                                                    <a onclick="openModal('ilerleme{{i.id}}')" class="status-view"><i
                                                        class="icon icon-view"></i></a>
                                            <div class="biadago-tooltip">
                                                <a><i class="icon icon-three-dots"></i></a>
                                                <div class="biadago-tooltip-content">
                                                    <a onclick="openModal('durumyenile{{i.id}}')">{% trans 'Durum Güncelle' %}</a>
                                                    <a  onclick="openModal('ilerleme{{i.id}}')">{% trans 'Süreç İzleme' %}</a>
                                                </div>
                                            </div>

                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                </tbody>
                        </table>
                        <style>
                            .dt-buttons {
                                opacity: 0;
                                height: 0;
                                position: fixed;
                                top: 10000px;
                                left: 10000px;
                            } 
                            </style>
                            <div class="large-stats-card-footer-actions">
                                <a onclick="$('.buttons-pdf').click()" class="lsc-footer-action"><i class="icon icon-pdf"></i></a>
                                <a onclick="$('.buttons-excel').click()" class="lsc-footer-action"><i class="icon icon-xlsx"></i></a>
                                <a onclick="$('.buttons-print').click()" class="lsc-footer-action"><i class="icon icon-print"></i></a>
                            </div>
                    </div>
                </div>
                 


            </div>

        </div>

        <script>
            let table = new DataTable('#tumu-table', {
                paging: true,
                searching: true,
                info: false,
                ordering: true,
                order: [[3, "desc"]],
                columnDefs: [
            {
                targets: 1,  // Tarih sütununun indeksi (örneğin ikinci sütun)
                render: function(data, type, row) {
                    return type === 'sort' ? moment(data, 'DD MMMM YYYY HH:mm').format('YYYYMMDDHHmm') : data;
                }
            }
        ],
            dom: 'Btip', // Butonları etkinleştirir
            buttons: [
                {
                    extend: 'pdfHtml5',
                    className: 'hidden', // DataTables butonunu gizlemek için
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: { columns: ':visible' },
                    customize: function (doc) {
                        doc.content[1].table.widths = Array(doc.content[1].table.body[0].length).fill('18%'); 
                        doc.pageMargins = [15, 20, 15, 20];
                        doc.defaultStyle = { fontSize: 8 };
                        doc.styles.tableHeader = {
                            fillColor: '#f2f2f2',
                            color: '#333',
                            alignment: 'center'
                        };
                    }
                },
                {
                        extend: 'excelHtml5',
                        className: 'hidden',
                        exportOptions: { columns: ':visible' },
                        customize: function (xlsx) {
                            var sheet = xlsx.xl.worksheets['sheet1.xml'];
                            
                            // Para birimlerinin olduğu sütunları belirleyin (örneğin, 5 ve 6. sütunlar)
                            $('row c[r^="E"], row c[r^="F"]', sheet).each(function () {
                                $(this).attr('s', '2'); // 2 numaralı hücre stiline ayarlanarak sayısal veri olarak işlenecek
                            });

                            // Tarihlerin olduğu sütunları belirleyin (örneğin, 4. sütun)
                            $('row c[r^="D"]', sheet).each(function () {
                                $(this).attr('s', '3'); // 3 numaralı hücre stiline ayarlanarak tarih olarak işlenecek
                            });
                        }
                    },
                {
                    extend: 'print',
                    className: 'hidden',
                    exportOptions: { columns: ':visible' },
                    customize: function (win) {
                        $(win.document.body).css('font-size', '10pt').css('width', '95%').css('margin', 'auto');
                        $(win.document.body).find('table')
                            .addClass('compact')
                            .css('font-size', 'inherit')
                            .css('width', '100%')
                            .css('margin', 'auto');
                    }
                }
            ]
                
            });

            $('#stats-search').keyup(function () {
                table.search($(this).val()).draw();
           
            });

            $('.tab-navs-btn').on('click', function () {
                $(".tab-navs-btn").removeClass("active");
                $(this).addClass("active");

                // Eğer "Tümü" sekmesi seçiliyse filtreleme yapmadan tüm verileri göster
                if ($(this).attr("data-tab") == "New") {
                    table.column(7).search("{% trans 'Yeniler' %}").draw();  }
                else if ($(this).attr("data-tab") == "Tümü") {
                    table.search('').columns().search('').draw(); // Tüm verileri gösterir
                }  else if ($(this).attr("data-tab") == "Tamamlandı") {
                    table.column(7).search("{% trans 'Tamamlanan' %}").draw();  // Durumu "Onaylandı" olanları gösterir
                } else if ($(this).attr("data-tab") == "Beklemede") {
                    table.column(7).search("{% trans 'Devam Eden' %}").draw();  // Durumu "Reddedildi" olanları gösterir
                }
            });



            $('#stats-search').keyup(function () {
                table.search($(this).val()).draw();
            })
        </script>


    </main>

    <div class="modal" id="is-emri-olustur">
        <div class="modal-inner" style="width: 1000px">
            <div class="modal-header">
            {% trans 'İş Emri Oluştur' %}
               
            </div>
            <div class="modal-body">
               <form autocomplete="off" class="tablelist-form" action="/{{dil}}{% url 'main:yapilacalar_ekle' %}" method="post" enctype="multipart/form-data" >
                        {% csrf_token %}
                    <div class="modal-form-rows">
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="baslik">{% trans 'Başlık Ekle' %}</label>
                                <input type="text" required name="baslik" id="baslik" style="text-transform: uppercase;" oninput="convertToUpperCase(this)">
                            </div>
                            <div class="form-element">
                                <label for="aciklama">{% trans 'Açıklama' %}</label>
                                <input type="text" required name="aciklama" id="aciklama" style="text-transform: capitalize;" oninput="capitalizeFirstLetter(this)">
                            </div>
                            <div class="form-row">
                                <div class="form-element">
                                    <label for="durum">{% trans 'Durum' %}</label>
                                   <select name="durum" required class="form-control" data-choices data-choices-search-false id="task-status-input">
                                    <option value="New" selected>{% trans 'Yeni' %}</option>
                                    <option value="Inprogress">{% trans 'Devam Ediyor' %}</option>
                                    <option value="Pending">{% trans 'Beklemede' %}</option>
                                    <option value="Completed">{% trans 'Tamamlandı' %}</option>
                                </select>
                                </div>
                                <div class="form-element">
                                    <label for="aciliyet">{% trans 'Öncelik' %}</label>
                                    <select required name="aciliyet" class="form-control" data-choices data-choices-search-false id="priority-field">
                                    
                                    <option value="High">{% trans 'Acil' %}</option>
                                    <option value="Medium">{% trans 'Orta' %}</option>
                                    <option value="Low">{% trans 'Düşük' %}</option>
                                </select>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="kisiler">{% trans 'Atama' %}</label>
                                <p class="input-helper-text">{% trans 'Birden fazla kullanıcı ataması için Windows kullanıcıları Ctrl, Mac kullanıcıları Command (⌘) tuşunu kullanabilir.' %}</p>
                                <select required name="blogbilgisi" class="form-control cokluetiketb" data-trigger multiple  id="cokluetiketb" >
                                {% for blog in blog_bilgisi %}
                                <option value="{{ blog.id }}">{{ blog.last_name }}: {{blog.email}}</option>
                                {% endfor %}
                            </select>
                            </div>
                            <div class="form-element">
                                <label for="tarih">{% trans 'Hedef Tarih:' %}</label>
                                <input required type="date" name="teslim_tarihi"  id="tarih">
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="katman">{% trans 'Plan Katmanı' %}</label>
                                 <select name="katman" id="katmanSelect"  data-trigger >
                                 <option value="" >{% trans 'Lütfen plan katmanını seçiniz.' %}</option>
                                {% for blog in katmanlar %}
                                <option data-id="{{blog.proje_santiye_Ait.id}}" data-img="{{blog.katman_dosyasi.url}}" value="{{ blog.id }}">{{ blog.proje_santiye_Ait.proje_adi }}: {{blog.katman_adi}}</option>
                                {% endfor %}
                            </select>
                                
                            </div>
                       
                            <div class="form-element">
                                <label for="yapi_gonder">{% trans 'Yapı' %}</label>
                                 <select name="yapi_gonder" id="yapiSelect"  data-trigger >
                                
                            </select>
                        </div>
                              <div class="form-element">
                                <label for="kat">{% trans 'Kat' %}</label>
                                 <select name="kat" id="odaSelect"  data-trigger >
                               
                            </select>  
                            </div>
                            <div class="form-element">
                                <div class="plan-konumu-preview" onclick="openModal('plan-konumu', false)">
                                    <canvas style="display: none; width: 50vh !important; max-height: 50vh !important;" id="alanpdf"  ></canvas>
                                    <input type="text" hidden name="pin_lokasyunux" id="pin_lokasyunux" >
                                    <input type="text" hidden name="pin_lokasyunuy" id="pin_lokasyunuy" >
                                    <img src="#" style="display: none; max-width: 50vh !important;" alt="Plan Konumu" id="alan" class="alan">
                                    <!-- <img src="{% static 'go/content/images/plan-konumu-preview.png' %}" alt="Plan Konumu">-->
                                    <div id="gizle" class="report-title">{% trans 'Henüz bu projede işaretleme yapmadınız. Proje konumu işaretlemek için tıklayınız.' %} </div>
                                    <textarea name="base_64_format" hidden  id="base_64_format"></textarea>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="ekler">{% trans 'Ekler' %}</label>

                                <div class="file-input file-preview-input">
                                    <ul class="fileList">



                                        <label for="ekler">
                                            <button><i class="icon icon-file"></i> {% trans 'Dosya Seç' %}</button>
                                        </label>
                                    </ul>

                                    <input multiple type="file" name="file" id="ekler">
                                </div>


                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="form-action-secondary" type="button" onclick="closeModal()">{% trans 'Vazgeç' %} </button>
                        <button class="form-action-primary" type="submit">{% trans 'İş Emri Oluştur' %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="plan-konumu">
        <div class="modal-inner modal-fullscreen">
            <div class="modal-header">
                <div class="modal-title">{% trans 'Plan Konumu' %}</div>
                <div class="modal-actions">
                   <!-- <a href="#" class="modal-action-primary"><i class="icon icon-pin"></i> Plan Konumunu Değiştir</a>
                    <a href="#" class="modal-action-remove">Plan Konumunu Sil <i class="icon icon-action-delete"></i></a>-->
                                <!-- Araç Çubuğu -->
                    <div id="toolbar">
                        <input type="file" id="file-upload" accept=".pdf,.jpg,.jpeg,.png"/>
                        <button id="save-btn" class="modal-action-primary"><i class="icon icon-pin"></i>{% trans 'Pinleri Kaydet' %}</button>
                        <button id="capture-btn">{% trans 'Alanı Kırp ve Göster' %}</button>
                    </div>
                    <a onclick="closeModal('plan-konumu')" class="modal-close-btn"><i class="icon icon-modal-close"></i></a>
                </div>
            </div>

                <!-- Konva Container -->
                <div id="container"></div>
                <!-- Modal -->
                <div id="capture-modal" class="modal">
                    <div class="modal-content">
                        <span class="close-btn">&times;</span>
                        <h3>{% trans 'Kırpılmış Alan:' %}</h3>
                        <img id="captured-image" src="" alt="Captured Area">
                        <a id="download-link" href="#" download="captured_area.png">{% trans 'İndir' %}</a>
                    </div>
                </div>
        </div>
    </div>
    <div class="modal" id="is-emri-duzenle">
        <div class="modal-inner" style="width: 1000px">
            <div class="modal-header">
            {% trans 'İş Emri Düzenle' %}
               
            </div>
            <div class="modal-body">
               <form autocomplete="off"class="tablelist-form" action="/{{dil}}{% url 'main:yapilacalar_ekle_duzenleme' %}" method="post" enctype="multipart/form-data" >
                        {% csrf_token %}
                        <input type="text" hidden name="id" id="veri_gonderme">
                    <div class="modal-form-rows">
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="baslik">{% trans 'Başlık Ekle' %}</label>
                                <input type="text" required name="baslik" id="baslikd" style="text-transform: uppercase;" oninput="convertToUpperCase(this)">
                            </div>
                            <div class="form-element">
                                <label for="aciklama">{% trans 'Açıklama' %}</label>
                                <input type="text" required name="aciklama" id="aciklamad" style="text-transform: capitalize;" oninput="capitalizeFirstLetter(this)">
                            </div>
                            <div class="form-row">
                                <div class="form-element">
                                    <label for="durum">{% trans 'Durum' %}</label>
                                   <select name="durum" required class="form-control" data-choices data-choices-search-false id="task-status-inputd">
                                    <option value="">{% trans 'Status' %}</option>
                                    <option value="New" selected>{% trans 'Yeni' %}</option>
                                    <option value="Inprogress">{% trans 'Devam Ediyor' %}</option>
                                    <option value="Pending">{% trans 'Beklemede' %}</option>
                                    <option value="Completed">{% trans 'Tamamlandı' %}</option>
                                </select>
                                </div>
                                <div class="form-element">
                                    <label for="aciliyet">{% trans 'Öncelik' %}</label>
                                    <select required name="aciliyet" class="form-control" data-choices data-choices-search-false id="oncelik_d">
                                    
                                    <option value="High">{% trans 'Acil' %}</option>
                                    <option value="Medium">{% trans 'Orta' %}</option>
                                    <option value="Low">{% trans 'Düşük' %}</option>
                                </select>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="kisiler">{% trans 'Atama' %}</label>
                                <p class="input-helper-text">{% trans 'Birden fazla kullanıcı ataması için Windows kullanıcıları Ctrl, Mac kullanıcıları Command (⌘) tuşunu kullanabilir.' %}</p>
                                <select required name="blogbilgisi" class="form-control cokluetiketb" data-trigger multiple  id="cokluetiketb" >
                                {% for blog in blog_bilgisi %}
                                <option value="{{ blog.id }}">{{ blog.last_name }}: {{blog.email}}</option>
                                {% endfor %}
                            </select>
                            </div>
                            <div class="form-element">
                                <label for="tarih">{% trans 'Hedef Tarih:' %}</label>
                                <input required type="date" name="teslim_tarihi"  id="tarihd">
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div class="form-element">
                                <label for="katman">{% trans 'Plan Katmanı' %}</label>
                                 <select name="katman" id="katmanSelectd"  data-trigger >
                                {% for blog in katmanlar %}
                                <option data-id="{{blog.proje_santiye_Ait.id}}" data-img="{{blog.katman_dosyasi.url}}" value="{{ blog.id }}">{{ blog.proje_santiye_Ait.proje_adi }}: {{blog.katman_adi}}</option>
                                {% endfor %}
                            </select>
                                
                            </div>
                       
                            <div class="form-element">
                                <label for="yapi_gonder">{% trans 'Yapı' %}</label>
                                 <select name="yapi_gonder" id="yapiSelectd"  data-trigger >
                                
                            </select>
                        </div>
                              <div class="form-element">
                                <label for="kat">{% trans 'kat' %}</label>
                                 <select name="kat" id="odaSelectd"  data-trigger >
                               
                            </select>  
                            </div>
                            <div class="form-element">
                                <div class="plan-konumu-preview" onclick="openModal('plan-konumu', false)">
                                    <canvas style="display: none; width: 50vh !important; height: 50vh !important;" id="alanpdfd"></canvas>
                                    <input type="text" hidden name="pin_lokasyunuxd" id="pin_lokasyunuxd" >
                                    <input type="text" hidden name="pin_lokasyunuyd" id="pin_lokasyunuyd" >
                                    <img src="#" style="display: none; max-width: 50vh !important;" alt="Plan Konumu" id="aland" class="alan">
                                    <!-- <img src="{% static 'go/content/images/plan-konumu-preview.png' %}" alt="Plan Konumu">-->
                                    <div id="gizled" class="report-title">{% trans 'Henüz bu projede işaretleme yapmadınız. Proje konumu işaretlemek için tıklayınız.' %} </div>
                                    <textarea name="base_64_format" hidden  id="base_64_formatd"></textarea>
                                </div>
                            </div>
                            <div class="form-element">
                                <label for="ekler">{% trans 'Ekler' %}</label>
    
                                <div class="file-input file-preview-input">
                                    <ul class="fileList">
    
    
    
                                        <label for="ekler">
                                            <button><i class="icon icon-file"></i> {% trans 'Dosya Seç' %}</button>
                                        </label>
                                    </ul>
    
                                    <input multiple type="file" name="file" id="ekler">
                                </div>
    
    
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="form-action-secondary" type="button" onclick="closeModal('is-emri-duzenle')">{% trans 'Vazgeç' %} </button>
                        <button class="form-action-primary" type="submit">{% trans 'Güncelle' %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% for i in santiyeler %}





<div class="modal" id="deleteConfirmationModal{{i.id}}">
    <div class="modal-inner" style="width: 500px">
        <div class="modal-header">
        {% trans 'Silme Uyarısı' %}
            
        </div>
        <div class="modal-body">
            <form autocomplete="off"action="/{{dil}}{% url 'main:yapilacalar_sil' %}" method="post">
                {% csrf_token %}
<input type="hidden" id="buttonIdInput" name="id_bilgisi" value="{{i.id}}">
             
                <p> {% trans 'Bu öğeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.' %}</p>
                <div class="form-actions">
                    <button class="form-action-secondary" type="button" onclick="closeModal('deleteConfirmationModal{{i.id}}')">{% trans 'Vazgeç' %}</button>
                    <button class="form-action-danger" type="submit"> {% trans 'Sil' %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

   <div class="modal" id="ilerleme{{ i.id }}" >
<div class="modal-inner" style="width: 500px; margin: auto; max-width: 100%;">
        <div class="modal-header">
            <span style="text-transform: capitalize;">{{ i.title }}</span>
        </div>
        <div class="modal-body" >
            <div class="ilerleme-durumlari">
                <!-- İlk Durum -->
                <div class="ilerleme-durumu" id="durum-{{ i.id }}">
                    <span style="font-weight: bold;">{{ i.kayit_tarihi }}</span>
                    <div class="ilerleme-durumu-content" style="margin-top: 10px;">
                        <p><strong>{% trans 'Başlık:' %}</strong> {{ i.title }}</p>
                        <p><strong>{% trans 'Açıklama:' %}</strong> <span style="text-transform: capitalize;">{{ i.aciklama }}</span></p>
                        <p><strong>{% trans 'Teslim Tarihi:' %}</strong> {{ i.teslim_tarihi }}</p>
                        {% if i.katman %}
                            <p><strong>{% trans 'Yapı Bilgisi:' %}</strong> {{ i.blok.blog_adi }}</p>
                            <p><strong>{% trans 'Kat Bilgisi:' %}</strong> {{ i.kat }}</p>
                            <button style="background-color: #24d6b5; color: #fff; border: none; padding: 10px; border-radius: 4px; cursor: pointer;" 
                                    onclick="katman_goster('{{ i.katman.katman_dosyasi.url }}', '{{ i.locasyonx }}', '{{ i.locasyony }}')">
                                {% trans "Katmanı Göster" %}
                            </button>
                        {% endif %}
                        <p><strong>{% trans 'Dosyalar:' %}</strong> {% dosya_varsa_indirme_isplani i %}</p>
                        <p><strong>{% trans 'Atamalar:' %}</strong>
                            {% for yazar in i.yapacaklar.all %}
                                {{ yazar.last_name }},
                            {% endfor %}
                        </p>
                    </div>
                </div>

                <!-- İlerleme Durumları -->
                {% ilerleme_goster i.id as veriler %}
                {% if veriler|length > 0 %}
                    {% for k in veriler %}
                        <div class="ilerleme-durumu">
                            <span style="font-weight: bold;">{{ k.kayit_tarihi }}</span>
                            <div class="ilerleme-durumu-content" style="margin-top: 10px;">
                                <p><strong>{% trans 'İşlemi Yapan:' %}</strong> {{ k.yapan_kisi.last_name }}</p>
                                <p><strong>{% trans 'Açıklama:' %}</strong> {{ k.aciklama }}</p>
                                <p><strong>{% trans 'Durum:' %}</strong> {{ k.status }}</p>
                                <p><strong>{% trans 'Teslim Tarihi:' %}</strong> {{ k.teslim_tarihi }}</p>
                            </div>
                            <div class="ilerleme-durumu-dosyalar" style="margin-top: 10px;">
                                {% dosya_varsa_indirme_isplani_ilerleme k.id %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #999; text-align: center;">{% trans 'Daha fazla ilerleme kaydı bulunmamaktadır.' %}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    


    <div class="modal" id="durumyenile{{i.id}}">
        <div class="modal-inner" style="width: 500px">
            <div class="modal-header">
                {% trans 'İş Emri Düzenle' %}
            </div>
            <div class="modal-body">
                <form autocomplete="off"class="tablelist-form" action="/{{dil}}{% url 'main:yapilacak_durumu_yenileme' %}" method="post" enctype="multipart/form-data" >
                    {% csrf_token %}
                    <input type="hidden" id="taskid-input" name="yenilenecekeklemeyapilacak" value="{{i.id}}" class="form-control">
                    <div class="form-element">
                        <label for="durum">{% trans 'Durum' %}</label>
                       <select name="durum" class="form-control" data-choices data-choices-search-false id="task-status-input">
                        <option value="New" selected>{% trans 'Yeni' %}</option>
                        <option value="Inprogress">{% trans 'Devam Ediyor' %}</option>
                        <option value="Pending">{% trans 'Beklemede' %}</option>
                        <option value="Completed">{% trans 'Tamamlandı' %}</option>
                    </select>
                    </div>
                    
                    <div class="form-element">
                        <label for="aciklama">{% trans 'Açıklama' %}</label>
                        <input type="text"  name="aciklama" id="aciklama" oninput="capitalizeFirstLetter(this)">
                    </div>
                    <div class="form-element">
                        <label for="tarih">{% trans 'Hedef Tarih:' %}</label>
                        <input type="date" value="{{i.teslim_tarihi | date:'Y-m-d'}}" name="teslim_tarihi"  id="tarih">
                    </div>
                    <div class="form-element">
                        <label for="belge-yukle">Belge Yükle</label>

                        <div class="file-input">
                            <label for="belge-yukle">
                                <img src="{% static 'go/content/images/illustration-upload.png' %}">

                                <button><i class="icon icon-file"></i>{% trans 'Dosya Seç' %}</button>
                            </label>

                            <input type="file" name="file" multiple id="belge-yukle">
                        </div>

                        <ul class="fileList">
                        </ul>
                    </div>
                    <div class="form-actions">
                        <button class="form-action-secondary" type="button" onclick="closeModal()">Vazgeç</button>
                        <button class="form-action-primary" type="submit">Devam Et</button>
                    </div>
                </form>
            </div>
        </div>
    </div>




{% endfor %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        document.getElementById('katmanSelect').addEventListener('change', function() {
            const katmanId = this.value;
            const santiyeId = this.options[this.selectedIndex].getAttribute('data-id');
            //loadPDF(file)
            
            
            document.getElementById('gizle').style.display = "none";
            //alanpdf
            // Tüm elementleri gizle

            // Dosya uzantısını al
            const fileExtension = this.options[this.selectedIndex].getAttribute('data-img').split('.').pop().toLowerCase();

            // Dosya türüne göre işlem yap
            if (fileExtension === "jpg" || fileExtension === "jpeg" || fileExtension === "png" || fileExtension === "gif") {
                const imgElement = document.getElementById('alan');
                imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "block";
                document.getElementById('alanpdf').style.display = "none";
                loadImage(this.options[this.selectedIndex].getAttribute('data-img'));
            } else if (fileExtension === "pdf") {
                var url = this.options[this.selectedIndex].getAttribute('data-img');
                const imgElement = document.getElementById('alan');
                loadPDF(this.options[this.selectedIndex].getAttribute('data-img'));
                //imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "none";
                pdfjsLib.getDocument(url).promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    var canvas = document.getElementById('alanpdf');
                    document.getElementById('alanpdf').style.display = "block";
                    var context = canvas.getContext('2d');
                    var viewport = page.getViewport({ scale: 1.5 });

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                    canvasContext: context,
                    viewport: viewport
                    });
                });
                }); // Yükleniyor mesajını gizle
            }

            fetch(`/get_yapi/${santiyeId}/`)
                .then(response => response.json())
                .then(data => {
                    const yapiSelect = document.getElementById('yapiSelect');
                    const odaSelect = document.getElementById('odaSelect');
                    // Hata kontrolü ekleyelim
                    if (!yapiSelect || !odaSelect) {
                        console.error("Yapı veya oda select öğesi bulunamadı.");
                        return; // Hata varsa burada çıkalım
                    }
                    yapiSelect.innerHTML = '';
                    odaSelect.innerHTML = '';

                    // Yapılar yapiSelect içine ekleniyor
                    data.yapilar.forEach(yapi => {
                        const option = document.createElement('option');
                        option.value = yapi.id;
                        option.setAttribute('data-kat-sayisi', yapi.kat_sayisi);
                        option.textContent = yapi.blog_adi;
                        yapiSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Fetch hatası:", error));
        });

        // Yapı seçildiğinde kat numaralarını odaSelect alanına ekleme
        document.getElementById('yapiSelect').addEventListener('change', function() {
            const selectedYapi = this.options[this.selectedIndex];
            const katSayisi = selectedYapi.getAttribute('data-kat-sayisi');
            const odaSelect = document.getElementById('odaSelect');
            odaSelect.innerHTML = '';

            // Kat numaralarını ekliyoruz
            for (let i = 1; i <= katSayisi; i++) {
                const odaOption = document.createElement('option');
                odaOption.value = i;
                odaOption.textContent = `Kat ${i}`;
                odaSelect.appendChild(odaOption);
            }
        });
        
        document.getElementById('katmanSelectd').addEventListener('change', function() {
            const katmanId = this.value;
            const santiyeId = this.options[this.selectedIndex].getAttribute('data-id');
            //loadPDF(file)
            
            
            document.getElementById('gizled').style.display = "none";
            //alanpdf
            // Tüm elementleri gizle
            // Dosya uzantısını al
            const fileExtension = this.options[this.selectedIndex].getAttribute('data-img').split('.').pop().toLowerCase();

            // Dosya türüne göre işlem yap
            if (fileExtension === "jpg" || fileExtension === "jpeg" || fileExtension === "png" || fileExtension === "gif") {
                const imgElement = document.getElementById('aland');
                imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "block";
                document.getElementById('alanpdfd').style.display = "none";
                loadImage(this.options[this.selectedIndex].getAttribute('data-img'));
            } else if (fileExtension === "pdf") {
                var url = this.options[this.selectedIndex].getAttribute('data-img');
                const imgElement = document.getElementById('aland');
                loadPDF(this.options[this.selectedIndex].getAttribute('data-img'));
                //imgElement.src = this.options[this.selectedIndex].getAttribute('data-img');
                imgElement.style.display = "none";
                pdfjsLib.getDocument(url).promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    var canvas = document.getElementById('alanpdfd');
                    document.getElementById('alanpdfd').style.display = "block";
                    var context = canvas.getContext('2d');
                    var viewport = page.getViewport({ scale: 1.5 });

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                    canvasContext: context,
                    viewport: viewport
                    });
                });
                }); // Yükleniyor mesajını gizle
            }

            fetch(`/get_yapi/${santiyeId}/`)
                .then(response => response.json())
                .then(data => {
                    const yapiSelectd = document.getElementById('yapiSelectd');
                    const odaSelectd = document.getElementById('odaSelectd');
                    // Hata kontrolü ekleyelim
                    if (!yapiSelectd || !odaSelectd) {
                        console.error("Yapı veya oda select öğesi bulunamadı.");
                        return; // Hata varsa burada çıkalım
                    }
                    yapiSelectd.innerHTML = '';
                    odaSelectd.innerHTML = '';

                    // Yapılar yapiSelect içine ekleniyor
                    data.yapilar.forEach(yapi => {
                        const option = document.createElement('option');
                        option.value = yapi.id;
                        option.setAttribute('data-kat-sayisi', yapi.kat_sayisi);
                        option.textContent = yapi.blog_adi;
                        yapiSelectd.appendChild(option);
                    });
                })
                .catch(error => console.error("Fetch hatası:", error));
        });
       

    });
    function katman_goster(veri,locasyonx, locasyony) {
        const fileExtension = veri.split('.').pop().toLowerCase();
            if (fileExtension === "jpg" || fileExtension === "jpeg" || fileExtension === "png" || fileExtension === "gif") {
               
                loadImage(veri);
            }else if (fileExtension === "pdf") {
                var url =veri;
              
                loadPDF(veri);
                pdfjsLib.getDocument(url).promise.then(function(pdf) {
                    pdf.getPage(1).then(function(page) {
                    var canvas = document.getElementById('alanpdfd');
                    document.getElementById('alanpdfd').style.display = "block";
                    var context = canvas.getContext('2d');
                    var viewport = page.getViewport({ scale: 1.5 });

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                    canvasContext: context,
                    viewport: viewport
                    });
                });
                });
               
           
            }
            addPin(locasyonx, locasyony)
            openModal('plan-konumu', false)
        }
        
</script>
<script>
    document.getElementById('yapiSelectd').addEventListener('change', function() {
            const selectedYapi = this.options[this.selectedIndex];
            const katSayisi = selectedYapi.getAttribute('data-kat-sayisi');
            const odaSelect = document.getElementById('odaSelectd');
            odaSelect.innerHTML = '';

            // Kat numaralarını ekliyoruz
            for (let i = 1; i <= katSayisi; i++) {
                const odaOption = document.createElement('option');
                odaOption.value = i;
                odaOption.textContent = `Kat ${i}`;
                odaSelect.appendChild(odaOption);
            }
        });
</script>
<script>
    
        function yapilacak_duzenle(santiyeId) {
        
    
    fetch(`/yapilacak/${santiyeId}/`)
            .then(response => response.json())
            .then(data => {
                
                document.getElementById("baslikd").value = data.title;
                document.getElementById("aciklamad").value = data.aciklama;
                document.getElementById("tarihd").value = data.teslim_tarihi;
                document.getElementById("veri_gonderme").value = data.id;
                a = document.getElementById("task-status-inputd");
                const option = document.createElement('option');
                option.value = data.status;
                option.selected = true;
                option.textContent = data.status;
                a.appendChild(option);

                b = document.getElementById("oncelik_d");
                const d = document.createElement('option');
                d.value = data.oncelik_durumu;
                d.selected = true;
                d.textContent = data.oncelik_durumu;
                b.appendChild(d);  // Burada d eklenmeli, option değil!
                const c = document.getElementById("katmanSelectd");
                addPin(data.locasyonx, data.locasyony)
const z = document.createElement('option');

if (data.katman_id) {
    z.setAttribute('data-id', data.katman_id);  // data-id özelliğini doğru şekilde ayarlıyoruz
} else {
    console.warn("katman_id bulunamadı!");
}

if (data.katman_dosyasi) {
    z.setAttribute('data-img', data.katman_dosyasi);  // data-img özelliğini doğru şekilde ayarlıyoruz
    const fileExtension = data.katman_dosyasi.split('.').pop().toLowerCase();
    
    // Dosya türüne göre işlem yap
    if (fileExtension === "jpg" || fileExtension === "jpeg" || fileExtension === "png" || fileExtension === "gif") {
        loadImage(data.katman_dosyasi);
    } else if (fileExtension === "pdf") {
        loadPDF(data.katman_dosyasi);
    } else {
        console.warn("Desteklenmeyen dosya türü: " + fileExtension);
    }
} else {
    console.warn("katman_dosyasi bulunamadı!");
}

if (data.katman) {
    z.textContent = data.katman;  // Görüntülenecek metin
    z.selected = true;  // Seçili yapmak için doğru kullanım
    c.appendChild(z);  // Seçenek ekleniyor
} else {
    console.warn("katman bulunamadı!");
}

// Yapi seçimi
const yapi_select = document.getElementById("yapiSelectd");
if (data.blok_id && data.blok) {
    const yapi_veri = document.createElement('option');
    yapi_veri.value = data.blok_id;
    yapi_veri.selected = true;
    yapi_veri.textContent = data.blok;
    yapi_select.appendChild(yapi_veri);  // Burada d eklenmeli, option değil!
} else {
    console.warn("blok_id veya blok bulunamadı!");
}

// Oda seçimi
const kat = document.getElementById("odaSelectd");
if (data.kat) {
    const kat_veri = document.createElement('option');
    kat_veri.value = data.kat;
    kat_veri.selected = true;
    kat_veri.textContent = data.kat;
    kat.appendChild(kat_veri);
} else {
    console.warn("kat bulunamadı!");
}

// Görüntüyü ayarlama
if (data.isaretli) {
    document.getElementById("aland").src = data.isaretli;
    document.getElementById("aland").style.display = "block";
} else {
    console.warn("isaretli bulunamadı!");
}

// Modal açma
openModal("is-emri-duzenle");

            })
            .catch(error => console.error("Fetch hatası:", error));
        }   
      
</script>

<script>
        // Konva Stage ve Layer'ları oluşturma
        const stage = new Konva.Stage({
            container: 'container',
            width: window.innerWidth,
            height: window.innerHeight,
            draggable: true  // Panning
        });

        const gridLayer = new Konva.Layer();      // Izgara katmanı
        const imageLayer = new Konva.Layer();     // PDF veya Resim katmanı
        const pinLayer = new Konva.Layer();       // Pinler katmanı

        // Katmanları doğru sırayla ekleyerek pinLayer'ın en üstte olmasını sağla
        stage.add(gridLayer);
        stage.add(imageLayer);
        stage.add(pinLayer);

        // Izgara çizme fonksiyonu
        function drawGrid(layer, gridSize = 100) {
            layer.destroyChildren(); // Önceki çizimleri temizle
            const lines = [];

            // Izgara alanını çok geniş tutarak "sonsuz" gibi görünmesini sağlıyoruz
            const gridLimit = 10000; // Gridin genişliği ve yüksekliği

            // Dikey çizgiler
            for (let i = -gridLimit; i <= gridLimit; i += gridSize) {
                lines.push(new Konva.Line({
                    points: [i, -gridLimit, i, gridLimit],
                    stroke: '#ddd', // Izgara çizgi rengi
                    strokeWidth: 1
                }));
            }

            // Yatay çizgiler
            for (let j = -gridLimit; j <= gridLimit; j += gridSize) {
                lines.push(new Konva.Line({
                    points: [-gridLimit, j, gridLimit, j],
                    stroke: '#ddd', // Izgara çizgi rengi
                    strokeWidth: 1
                }));
            }

            layer.add(...lines);
            layer.batchDraw();
        }

        drawGrid(gridLayer, 100); // Izgara katmanını çiz

        // Pin simgesi için SVG veri URI
        const pinSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path fill="red" d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5 14.5 7.6 14.5 9 13.4 11.5 12 11.5z"/>
            </svg>
        `;
        const pinImageSrc = 'data:image/svg+xml;base64,' + btoa(pinSVG);

        // Tek pin için referans
        let currentPin = null;

        // Pin ekleme fonksiyonu
        function addPin(x, y) {
            // Önceki pin varsa sil
            if (currentPin) {
                currentPin.destroy();
                currentPin = null;
            }

            const pin = new Konva.Image({
                x: x - 12,  // Centering (pin genişliği yarısı)
                y: y - 24,  // Adjust to show tip (pin yüksekliği)
                width: 24,
                height: 24,
                image: new Image(),
                draggable: false  // Pin sürüklenemez
            });

            const img = new Image();
            img.onload = () => {
                pin.image(img);
                pinLayer.add(pin);
                pinLayer.batchDraw();
                currentPin = pin; // Yeni pin referansını güncelle
            };
            img.src = pinImageSrc;

            // Sağ tıklama ile pin silme (masaüstü)
            pin.on('contextmenu', function(e) {
                e.evt.preventDefault();
                pin.destroy();
                pinLayer.batchDraw();
                currentPin = null;
            });

            // Uzun basma ile pin silme (mobil)
            pin.on('touchstart', function(e) {
                if (e.evt.touches && e.evt.touches.length > 1) return; // Çoklu dokunuşları yoksay
                // Uzun basma algılama
                const duration = 500; // 500ms uzun basma
                let timer;

                const touchMoveHandler = () => {
                    clearTimeout(timer);
                };

                const touchEndHandler = () => {
                    clearTimeout(timer);
                    window.removeEventListener('touchmove', touchMoveHandler);
                    window.removeEventListener('touchend', touchEndHandler);
                };

                window.addEventListener('touchmove', touchMoveHandler);
                window.addEventListener('touchend', touchEndHandler);

                timer = setTimeout(() => {
                    pin.destroy();
                    pinLayer.batchDraw();
                    currentPin = null;
                    window.removeEventListener('touchmove', touchMoveHandler);
                    window.removeEventListener('touchend', touchEndHandler);
                }, duration);
            });
        }

        // Stage'in scale ve position bilgilerine göre içerik koordinatlarını hesaplama
        function getTransformedPointerPosition() {
            const pointer = stage.getPointerPosition();
            if (!pointer) return null;
            const transform = stage.getAbsoluteTransform().copy().invert();
            return transform.point(pointer);
        }

        // Pin ekleme fonksiyonu - Sahneye tıklama veya dokunma
        stage.on('click tap', function(e) {
            // Dragging olmadığında pin ekle
            if (!stage.isDragging()) {
                const pos = getTransformedPointerPosition();
                if (pos) {
                    addPin(pos.x, pos.y);
                }
            }
        });

        // Zoom işlevi - Konva.js örneğinden uyarlanmıştır
        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const oldScale = stage.scaleX();
            const pointer = stage.getPointerPosition();

            const scaleBy = 1.1;
            let newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            newScale = Math.max(0.1, Math.min(newScale, 10)); // Zoom sınırları

            stage.scale({ x: newScale, y: newScale });

            // Zoom odak noktası
            const mousePointTo = {
                x: (pointer.x - stage.x()) / oldScale,
                y: (pointer.y - stage.y()) / oldScale,
            };

            const newPos = {
                x: pointer.x - mousePointTo.x * newScale,
                y: pointer.y - mousePointTo.y * newScale,
            };
            stage.position(newPos);
            stage.batchDraw();

            // Pinlerin ölçeğini sabit tutmak için her zoom işleminde pinleri ters orantılı ölçeklendir
            if (currentPin) {
                currentPin.scale({ x: 1 / newScale, y: 1 / newScale });
                pinLayer.batchDraw();
            }
        });

        // PDF yükleme fonksiyonu
        async function loadPDF(fileUrl) {
    try {
        // PDF URL'den alınarak Blob'a dönüştürülüyor
        const response = await fetch(fileUrl);
        if (!response.ok) throw new Error("PDF yüklenemedi.");
        const fileBlob = await response.blob();
        
        const fileReader = new FileReader();
        fileReader.onload = async function(event) {
            const typedArray = new Uint8Array(event.target.result);
            const pdf = await pdfjsLib.getDocument(typedArray).promise;
            console.log("PDF Yüklendi:", pdf);

            const page = await pdf.getPage(1);  // İlk sayfayı yükle
            const scale = 1.5;  // Performans için ölçek
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;
            console.log("PDF Render Edildi.");

            // PDF'in canvas'ını Konva sahnesine ekle
            const pdfImage = new Konva.Image({
                x: 0,
                y: 0,
                image: canvas,
                width: viewport.width,
                height: viewport.height,
                draggable: false,
            });

            imageLayer.destroyChildren(); // Önceki görüntüyü sil
            imageLayer.add(pdfImage);
            imageLayer.batchDraw();
        };
        fileReader.readAsArrayBuffer(fileBlob);
    } catch (error) {
        console.error("PDF Yükleme Hatası:", error);
        alert("PDF dosyası yüklenemedi. Lütfen geçerli bir PDF dosyası yükleyin.");
    }
}


        function loadImage(filePath) {
    const img = new Image();
    img.onload = function() {
        const konvaImage = new Konva.Image({
            x: 0,
            y: 0,
            image: img,
            width: img.width,
            height: img.height,
            draggable: false,
        });

        imageLayer.destroyChildren(); // Önceki görüntüyü sil
        imageLayer.add(konvaImage);   // Yeni görüntüyü ekle
        imageLayer.batchDraw();       // Katmanı yeniden çiz
    };
    
    img.src = filePath; // Buraya tam URL'yi ekleyin
}

// Dosyayı sunucudan yüklemek için tam URL ile çağırın:


        // Dosya yükleme işlemi
        document.getElementById('file-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type === 'application/pdf') {
                    loadPDF(file);
                } else if (file.type.startsWith('image/')) {
                    loadImage(file);
                } else {
                    alert("Lütfen geçerli bir PDF veya resim dosyası yükleyin!");
                }
            }
        });

        // Kaydet butonu - pin koordinatlarını kaydetme
        document.getElementById('save-btn').addEventListener('click', function() {
            if (currentPin) {
                const pinData = {
                    x: currentPin.x(),
                    y: currentPin.y(),
                };
                document.getElementById("pin_lokasyunux").value = currentPin.x();
                document.getElementById("pin_lokasyunuy").value = currentPin.y();
                document.getElementById("pin_lokasyunuxd").value = currentPin.x();
                document.getElementById("pin_lokasyunuyd").value = currentPin.y();
                closeModal('plan-konumu', false)
                if (!currentPin) {
                alert("Lütfen bir pin ekleyin.");
                return;
            }

            // Pin'in sahnedeki tam konumunu al
            const pinStagePos = currentPin.getAbsolutePosition();
            if (!pinStagePos) {
                alert("Pin pozisyonu alınamadı.");
                return;
            }
            const pinStageX = pinStagePos.x;
            const pinStageY = pinStagePos.y;

            console.log(`Pin'in stage koordinatları: (${pinStageX}, ${pinStageY})`);

            // 700x250 px'lik alanın sol üst köşesini hesapla (pin merkezde olacak)
            const captureWidth = 700;
            const captureHeight = 250;
            let captureX = pinStageX - (captureWidth / 2);
            let captureY = pinStageY - (captureHeight / 2);

            console.log(`Kırpılacak alanın sol üst köşesi: (${captureX}, ${captureY})`);

            // Kırpılacak alanın stage sınırları içinde kalmasını sağla
            captureX = Math.max(0, Math.min(captureX, stage.width() - captureWidth));
            captureY = Math.max(0, Math.min(captureY, stage.height() - captureHeight));

            console.log(`Sınırlandırılmış kırpma koordinatları: (${captureX}, ${captureY})`);

            // stage.toDataURL ile tüm katmanları dahil ederek kırp
            stage.toDataURL({
                x: captureX,
                y: captureY,
                width: captureWidth,
                height: captureHeight,
                pixelRatio: 1,
                callback: function(dataURL) {
                    // PNG oluştur ve göster
                    const capturedImage = document.getElementById('captured-image');
                    capturedImage.src = dataURL;
                    const isImage = dataURL.startsWith("data:image/");
                    const isPDF = dataURL.startsWith("data:application/pdf");
                    // İndirme linkini güncelle
                    if (isImage) {
                        const downloadLink = document.getElementById('download-link');
                    downloadLink.href = dataURL;
                    document.getElementById('alan').src = dataURL;
                    document.getElementById('alan').style.display = "block";
                    document.getElementById('alanpdf').style.display = "none";
                    document.getElementById('base_64_format').textContent = dataURL;
                    document.getElementById('aland').src = dataURL;
                    document.getElementById('aland').style.display = "block";
                    document.getElementById('alanpdfd').style.display = "none";
                    document.getElementById('base_64_formatd').textContent = dataURL;
                    closeModal("plan-konumu");
                    }
                    else if(isPDF){
                        alert("pdf")
                    }
                    
                   
                }
            });
                
                console.log('Pin Bilgileri:', JSON.stringify(pinData));
                alert("{% trans 'Pin başarıyla kaydedildi!' %}");
            }
            else{
                alert("{% trans 'Henüz pin eklenmedi.' %}");
            }
        });

        // Pencere yeniden boyutlandırıldığında sahneyi yeniden ayarlama
        window.addEventListener('resize', function() {
            stage.width(window.innerWidth);
            stage.height(window.innerHeight);
            drawGrid(gridLayer, 100); // Izgara katmanını yeniden çiz
            imageLayer.batchDraw();
            pinLayer.batchDraw();
        });

        // Modal kontrolü
        const modal = document.getElementById('capture-modal');
        const closeBtn = document.querySelector('.close-btn');

        // Modalı kapatma fonksiyonu
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        // Modal dışında tıklayınca kapatma
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Area Capture (700x250 px) fonksiyonu
        document.getElementById('capture-btn').addEventListener('click', function() {
            if (!currentPin) {
                alert("Lütfen bir pin ekleyin.");
                return;
            }

            // Pin'in sahnedeki tam konumunu al
            const pinStagePos = currentPin.getAbsolutePosition();
            if (!pinStagePos) {
                alert("Pin pozisyonu alınamadı.");
                return;
            }
            const pinStageX = pinStagePos.x;
            const pinStageY = pinStagePos.y;

            console.log(`Pin'in stage koordinatları: (${pinStageX}, ${pinStageY})`);

            // 700x250 px'lik alanın sol üst köşesini hesapla (pin merkezde olacak)
            const captureWidth = 700;
            const captureHeight = 250;
            let captureX = pinStageX - (captureWidth / 2);
            let captureY = pinStageY - (captureHeight / 2);

            console.log(`Kırpılacak alanın sol üst köşesi: (${captureX}, ${captureY})`);

            // Kırpılacak alanın stage sınırları içinde kalmasını sağla
            captureX = Math.max(0, Math.min(captureX, stage.width() - captureWidth));
            captureY = Math.max(0, Math.min(captureY, stage.height() - captureHeight));

            console.log(`Sınırlandırılmış kırpma koordinatları: (${captureX}, ${captureY})`);

            // stage.toDataURL ile tüm katmanları dahil ederek kırp
            stage.toDataURL({
                x: captureX,
                y: captureY,
                width: captureWidth,
                height: captureHeight,
                pixelRatio: 1,
                callback: function(dataURL) {
                    // PNG oluştur ve göster
                    const capturedImage = document.getElementById('captured-image');
                    capturedImage.src = dataURL;

                    // İndirme linkini güncelle
                    const downloadLink = document.getElementById('download-link');
                    downloadLink.href = dataURL;
                    downloadLink.download = 'captured_area.png';

                    // Modalı göster
                    modal.style.display = "block";
                }
            });
        });
    </script>
    <script>
        function openModal(modalID, close = true) {
            if (close) {
                closeModal();
            }
            if (modalID === "plan-konumu") {
                $("#" + modalID).css({
                    "display": "flex",
                    "z-index": 100000
                }).hide().fadeIn();
            } else {
                $("#" + modalID).css("display", "flex").hide().fadeIn();
            }
        }

        function closeModal(modalID = "") {
            console.log(modalID.length);
            if (modalID.length === 0) {
                $(".modal").fadeOut();
            } else {
                $("#" + modalID).fadeOut();
            }
        }

        $(".modal").on("click", function (e) {
            if ($(e.target).closest('.modal-inner').length === 0 && $(e.target).closest('.modal').length) {
                closeModal();
            }
        });

        $(document).ready(function () {
            $('input[type="file"]').on('change', function () {
                var files = $(this).prop('files');
                var formElement = $(this).closest('.form-element');
                var fileList = formElement.find('.fileList');
                fileList.find('li:not(label)').remove();

                var selectedFiles = Array.from(files);

                for (var i = 0; i < selectedFiles.length; i++) {
                    (function (file) {
                        var listItem = $('<li></li>');

                        if (file.type.startsWith('image/') && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/webp')) {
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                listItem.append(`
                                    <div class="file-input-uploaded">
                                        <div class="file-input-uploaded-head">
                                            <div class="file-input-uploaded-title" title="${file.name}">${file.name}</div>
                                            <button type="button" class="file-input-uploaded-remove"><i class="icon icon-trash"></i></button>
                                        </div>
                                        <div class="file-input-uploaded-preview">
                                            <img src="${e.target.result}">
                                        </div>
                                    </div>
                                `);
                                fileList.append(listItem);

                                listItem.find('.file-input-uploaded-remove').on('click', function () {
                                    $(this).closest('li').remove();
                                    selectedFiles = selectedFiles.filter(f => f.name !== file.name);
                                    updateInput(selectedFiles);
                                });
                            };
                            reader.readAsDataURL(file);
                        } else {
                            listItem.append(`
                                <div class="file-input-uploaded">
                                    <div class="file-input-uploaded-head">
                                        <div class="file-input-uploaded-title" title="${file.name}">${file.name}</div>
                                        <button type="button" class="file-input-uploaded-remove"><i class="icon icon-trash"></i></button>
                                    </div>
                                    <div class="file-input-uploaded-no-preview">
                                        <img src="{% static 'go/content/images/illustration-upload.png' %}">
                                    </div>
                                </div>
                            `);
                            fileList.append(listItem);

                            listItem.find('.file-input-uploaded-remove').on('click', function () {
                                $(this).closest('li').remove();
                                selectedFiles = selectedFiles.filter(f => f.name !== file.name);
                                updateInput(selectedFiles);
                            });
                        }
                    })(selectedFiles[i]);
                }
            });
        });

        function updateInput(selectedFiles) {
            var dataTransfer = new DataTransfer();
            selectedFiles.forEach(function (file) {
                dataTransfer.items.add(file);
            });
            $('input[type="file"]').prop('files', dataTransfer.files);
        }


    </script>

{% endif %}
  
{% endblock sidebar %}
