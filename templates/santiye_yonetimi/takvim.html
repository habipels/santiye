{% extends "homebase.html" %}
{% load i18n %}
{% load custom_tags %}
{% load static %}
{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">

<!-- CSS Dosyaları -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.1.3/css/dataTables.dataTables.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.1.0/dist/css/multi-select-tag.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
<link rel="stylesheet" href="{% static 'go/gant/platform.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'go/gant/libs/jquery/dateField/jquery.dateField.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'go/gant/gantt.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'go/gant/ganttPrint.css' %}" type="text/css" media="print">
<link rel="stylesheet" href="{% static 'go/gant/libs/jquery/valueSlider/mb.slider.css' %}" type="text/css" media="print">

<!-- JavaScript Dosyaları -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://momentjs.com/downloads/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.1.0/dist/js/multi-select-tag.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://cdn.datatables.net/v/dt/dt-2.1.6/r-3.0.3/datatables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/dataTables.buttons.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

<!-- Gantt ve jQuery Bağımlılıkları -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="{% static 'go/gant/libs/jquery/jquery.livequery.1.1.1.min.js' %}"></script>
<script src="{% static 'go/gant/libs/jquery/jquery.timers.js' %}"></script>
<script src="{% static 'go/gant/libs/utilities.js' %}"></script>
<script src="{% static 'go/gant/libs/forms.js' %}"></script>
<script src="{% static 'go/gant/libs/date.js' %}"></script>
<script src="{% static 'go/gant/libs/dialogs.js' %}"></script>
<script src="{% static 'go/gant/libs/layout.js' %}"></script>
<script src="{% static 'go/gant/libs/i18nJs.js' %}"></script>
<script src="{% static 'go/gant/libs/jquery/dateField/jquery.dateField.js' %}"></script>
<script src="{% static 'go/gant/libs/jquery/JST/jquery.JST.js' %}"></script>
<script src="{% static 'go/gant/libs/jquery/valueSlider/jquery.mb.slider.js' %}"></script>
<script src="{% static 'go/gant/libs/jquery/svg/jquery.svg.min.js' %}"></script>
<script src="{% static 'go/gant/libs/jquery/svg/jquery.svgdom.1.8.js' %}"></script>
<script src="{% static 'go/gant/ganttUtilities.js' %}"></script>
<script src="{% static 'go/gant/ganttTask.js' %}"></script>
<script src="{% static 'go/gant/ganttDrawerSVG.js' %}"></script>
<script src="{% static 'go/gant/ganttZoom.js' %}"></script>
<script src="{% static 'go/gant/ganttGridEditor.js' %}"></script>
<script src="{% static 'go/gant/ganttMaster.js' %}"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

<script>
$(function() {
    $('input[name="start"], input[name="end"]').daterangepicker({
        singleDatePicker: true,
        showDropdowns: true,
        autoUpdateInput: false,
        locale: {
            format: 'YYYY-MM-DD'
        },
        isInvalidDate: function(date) {
            return false; // Allow all dates including weekends
        }
    });

    $('input[name="start"], input[name="end"]').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('YYYY-MM-DD'));
    });
});
</script>

{% endblock head %}

{% block sidebar %}
<style>
.hidden {
    display: none !important;
}
.dark-mode .teamworkIcon {
    color: #797979;
     }
      @media print {
     .ganttButtonBar .no-print {

            display: none !important;
}
}
.table-detail-card {
    margin-top: 0px; 
}
/* Tab Stilleri */
.gantt-tabs-container {
    width: 100%;
}

.gantt-tabs {
    display: flex;
    flex-wrap: wrap;
    padding: 0;
    margin: 0 0 -1px 0;
    list-style: none;
    position: relative;
}

.gantt-tab-item {
    margin-right: 5px;
    border: 1px solid #ddd;
    border-radius: 5px 5px 0 0;
    padding: 10px 15px;
    cursor: pointer;
    background-color: #f5f5f5;
    position: relative;
    transition: all 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
}

.gantt-tab-item.active {
    background-color: #fff;
    border-bottom-color: #fff;
    font-weight: bold;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
}

.dark-mode .gantt-tab-item {
    background-color: #333;
    border-color: #444;
    color: #eee;
}

.dark-mode .gantt-tab-item.active {
    background-color: #202020;
    border-bottom-color: #202020;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
}

.gantt-tabs-sortable-ghost {
    opacity: 0.5;
    background-color: #c8e6ff !important;
}

.dark-mode .gantt-tabs-sortable-ghost {
    background-color: #4a6c8f !important;
}

.gantt-tab-content {
    display: none;
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 0 0 5px 5px;
}

.dark-mode .gantt-tab-content {
    border-color: #444;
    background-color: #202020;
}

.gantt-tab-content.active {
    display: block;
}

.gantt-tab-add {
    margin-top: 10px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}

.gantt-tab-add input {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
    margin-right: 10px;
}

.gantt-tab-add button {
    padding: 8px 15px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.dark-mode .gantt-tab-add input {
    background-color: #333;
    border-color: #444;
    color: #eee;
}

.dark-mode .gantt-tab-add button {
    background-color: #0056b3;
}

.gantt-edit-tab {
    margin-left: 10px;
    font-size: 12px;
    color: #777;
    cursor: pointer;
}

.dark-mode .gantt-edit-tab {
    color: #aaa;
}

.gantt-tab-action {
    display: inline-block;
    margin-left: 8px;
    font-size: 14px;
    cursor: pointer;
}

.gantt-tab-action.edit {
    color: #007bff;
}

.gantt-tab-action.delete {
    color: #dc3545;
}

.dark-mode .gantt-tab-action.edit {
    color: #4a9eff;
}

.dark-mode .gantt-tab-action.delete {
    color: #ff6b6b;
}

.gantt-tab-rename-form {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #fff;
    z-index: 5;
    border-radius: 5px 5px 0 0;
}

.dark-mode .gantt-tab-rename-form {
    background-color: #333;
}

.gantt-tab-rename-form input {
    width: calc(100% - 70px);
    height: 100%;
    border: none;
    padding: 0 10px;
    background-color: transparent;
}

.gantt-tab-rename-form button {
    width: 30px;
    height: 100%;
    border: none;
    background-color: transparent;
    cursor: pointer;
    color: #28a745;
}

.gantt-tab-rename-form button.cancel {
    color: #dc3545;
}

@media (max-width: 768px) {
    .gantt-tabs-container > div {
        flex-direction: column;
    }
    
    .gantt-tab-add {
        margin-top: 10px;
        width: 100%;
    }
    
    .gantt-tab-item {
        margin-bottom: 5px;
        width: 100%;
        max-width: none;
        border-radius: 5px;
    }
}
</style>

<script>
function exportGanttToPDF() {
    const { jsPDF } = window.jspdf;

    // PDF export işlem uyarısını göster
    document.getElementById("loadingMessage").style.display = "block";

    const pdf = new jsPDF({
        orientation: "landscape",
        unit: "px",
        format: "a4",
    });

    const margin = 10; // Sayfa kenarında bırakmak istediğimiz boşluk

    // Export öncesi tüm "no-print" sınıfındaki elemanları gizle
    document.querySelectorAll(".no-print").forEach((el) => el.style.display = "none");

    // #workSpace içeriğini canvas'a dönüştür
    html2canvas(document.querySelector("#workSpace")).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const pdfWidth = pdf.internal.pageSize.getWidth() - 2 * margin;
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        // Görüntüyü PDF'e ekle
        pdf.addImage(imgData, "PNG", margin, margin, pdfWidth, pdfHeight);

        // Footer'ı sabitle
        pdf.setFontSize(10);
        const footerText = "{% trans 'BiadaGO Construction ERP Software - www.biadago.com' %}";
        pdf.text(footerText, pdf.internal.pageSize.getWidth() / 2, pdf.internal.pageSize.getHeight() - 10, {
            align: "center",
        });

        // PDF'i kaydet
        pdf.save("Gantt-Chart.pdf");

        // Yükleme mesajını gizle
        document.getElementById("loadingMessage").style.display = "none";

        // Export sonrası "no-print" elemanlarını geri göster
        document.querySelectorAll(".no-print").forEach((el) => el.style.display = "");
    });
}

</script>


<main>
    <div class="page-header">
        <div class="page-info">
            <div class="page-title">
                <a href="#" onclick="history.back(); return false;"><i class="icon icon-arrow-circle-left"></i></a>
                {% trans 'Stratejik İş Planı' %}
            </div>
            <ul class="page-breadcrumb">
                <li><a href="/{{dil}}/">{% trans 'Dashboard' %}</a></li>
                <li><a href="#">{% trans 'Şantiye Yönetimi' %}</a></li>
                <li><a href="#">{% trans 'Stratejik İş Planı' %}</a></li>
            </ul>
        </div>
        
        <!-- Tabları buraya taşıyoruz -->
        <div class="gantt-tabs-container" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0px;">
                <ul class="gantt-tabs" id="ganttTabs" style="margin-bottom: 0;">
                    <li class="gantt-tab-item active" data-tab="tab1">{% trans 'Genel Gantt' %} <span class="gantt-tab-action edit" onclick="renameTab(event, 'tab1')"><i class="icon icon-action-edit"></i></span><span class="gantt-tab-action delete" onclick="deleteTab(event, 'tab1')"><i class="icon icon-action-delete"></i></span></li>
                </ul>
                
                <div class="gantt-tab-add" style="margin: 0; display: inline-flex;">
                    <input type="text" id="newTabName" placeholder="{% trans 'Yeni tab adı...' %}" style="height: 32px; width: 150px; margin-right: 5px;">
                    <button onclick="addNewTab()" style="height: 32px; padding: 0 10px;">{% trans 'Ekle' %}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="large-stats-card table-card table-detail-card">

<div id="loadingMessage" style="display: none; z-index: 10000;position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.75); color: #fff; padding: 20px; border-radius: 8px;">
  {% trans 'PDF oluşturuluyor, lütfen bekleyin...' %}
</div>

<div class="gantt-tab-content active" id="tab1-content">
    <div id="workSpace"></div>
</div>

<style>
    .dt-buttons {
        opacity: 0;
        height: 0;
        position: fixed;
        top: 10000px;
        left: 10000px;
    } 
</style>

<div class="large-stats-card-footer-actions">
    <div class="lsc-footer-info">
        <i class="icon icon-info"></i> <span style="margin-top: 6px; display: inline-block;">{% trans 'Stratejik İş Planı, projelerin görev ve süre yönetimini optimize ederek başarıya ulaşmanıza yardımcı olur.' %}</span>

    </div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const resizeButtons = document.querySelectorAll(".button.textual.icon");
  
  // Sayfa yüklendiğinde tüm butonların "aktif" sınıfını temizle
  resizeButtons.forEach(button => button.classList.remove("active"));

  // Her butona tıklama olayını ekle
  resizeButtons.forEach(button => {
    button.addEventListener("click", function () {
      resizeButtons.forEach(btn => btn.classList.remove("active")); // Diğer butonların "aktif" durumunu kaldır
      this.classList.add("active"); // Sadece tıklanan butonu aktif yap
    });
  });
});


</script>

<script>
        function openModal(modalID, close = true) {
            if (close) {
                closeModal();
            }
            $("#" + modalID).css("display", "flex").hide().fadeIn()
        }

        function closeModal(modalID = "") {
            console.log(modalID.length);
            if (modalID.length === 0) {
                $(".modal").fadeOut();
            } else {
                $("#" + modalID).fadeOut();
            }
        }

        $(".modal").on("click", function (e) {
            if ($(e.target).closest('.modal-inner').length === 0 && $(e.target).closest('.modal').length) {
                closeModal($(e.target).attr("id"));
            }
        });

        $('input[type="file"]').on('change', function () {
            var files = $(this).prop('files');
            var formElement = $(this).closest('.form-element');
            var fileList = formElement.find('.fileList');
            fileList.empty();

            for (var i = 0; i < files.length; i++) {
                fileList.append('<li>' + files[i].name + '</li>');
            }
        });

    </script>
    <script type="text/javascript">


var ge;
$(function() {
  var canWrite=true; //this is the default for test purposes

  // here starts gantt initialization
  ge = new GanttMaster();
  ge.set100OnClose=true;

  ge.shrinkParent=true;

  ge.init($("#workSpace"));
  loadI18n(); //overwrite with localized ones

  //in order to force compute the best-fitting zoom level
  delete ge.gantt.zoom;

  var project=loadFromLocalStorage();

  if (!project.canWrite)
    $(".ganttButtonBar button.requireWrite").attr("disabled","true");

  ge.loadProject(project);
  ge.checkpoint(); //empty the undo stack

  initializeHistoryManagement(ge.tasks[0].id);
});



function getDemoProject() {
  // Bugünün tarihi
  const today = new Date();
  const todayMs = today.getTime();
  
  // Proje verisini yükle
  var ret = {% if gant %}
    {{gant.gantt_verisi|safe}}
  {% else %}
    {
      "tasks": [
        {
          "id": -1,
          "name": "Gantt editor",
          "progress": 0,
          "progressByWorklog": false,
          "relevance": 0,
          "type": "",
          "typeId": "",
          "description": "",
          "code": "",
          "level": 0,
          "status": "STATUS_ACTIVE",
          "depends": "",
          "start": todayMs, // Bugünün tarihi
          "duration": 20,
          "end": todayMs + (20 * 24 * 60 * 60 * 1000), // 20 gün sonrası
          "startIsMilestone": false,
          "endIsMilestone": false,
          "collapsed": false,
          "assigs": [],
          "hasChild": true
        }
      ],
      "selectedRow": 2,
      "deletedTaskIds": [],
      "resources": [
        {"id": "tmp_1", "name": "Resource 1"}
      ],
      "roles": [
        {"id": "tmp_1", "name": "Project Manager"}
      ],
      "canWrite": true,
      "canDelete": true,
      "canWriteOnParent": true,
      "canAdd": true
    }
  {% endif %};

  // Tüm görevlere canWrite: true ekle
  ret.tasks.forEach(function(task) {
    task.canWrite = true;
  });
  
  return ret;
}


function loadGanttFromServer(taskId, callback) {

  //this is a simulation: load data from the local storage if you have already played with the demo or a textarea with starting demo data
  var ret=loadFromLocalStorage();

  //this is the real implementation
  /*
  //var taskId = $("#taskSelector").val();
  var prof = new Profiler("loadServerSide");
  prof.reset();

  $.getJSON("ganttAjaxController.jsp", {CM:"LOADPROJECT",taskId:taskId}, function(response) {
    //console.debug(response);
    if (response.ok) {
      prof.stop();

      ge.loadProject(response.project);
      ge.checkpoint(); //empty the undo stack

      if (typeof(callback)=="function") {
        callback(response);
      }
    } else {
      jsonErrorHandling(response);
    }
  });
  */

  return ret;
}

function upload(uploadedFile) {
  var fileread = new FileReader();
  
  fileread.onload = function(e) {
    var content = e.target.result;
    var intern = JSON.parse(content); // Array of Objects.
    //console.log(intern); // You can index every object
    
    ge.loadProject(intern);
    ge.checkpoint(); //empty the undo stack

  };

  fileread.readAsText(uploadedFile);
}

function saveGanttOnServer() {
    var prj = ge.saveProject(); // Proje verisini alıyoruz

    $.ajax({
        url: "/gantt-kaydet/",  // Django view'inize uygun URL
        type: "POST",
        data: {
            'gant_verisi': JSON.stringify(prj)  // Veriyi JSON olarak gönderiyoruz
        },
        dataType: "json",
        headers: {
            "X-CSRFToken": getCookie("csrftoken")  // CSRF token'ı ekliyoruz
        },
        success: function(response) {
            if (response.ok) {
                alert("{% trans 'Veri başarıyla kaydedildi!' %}");
                // İsterseniz proje verisini yeniden yükleyebilirsiniz
                ge.loadProject(response.project);
            } else {
                alert("{% trans 'Kaydetme sırasında hata oluştu.' %}");
            }
        },
        error: function(xhr, errmsg, err) {
            console.error("AJAX hatası: " + errmsg);
        }
    });
}

// CSRF token almak için yardımcı fonksiyon
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to download data to a file
function download(data, filename, type) {
  var file = new Blob([data], {type: type});
  if (window.navigator.msSaveOrOpenBlob) // IE10+
    window.navigator.msSaveOrOpenBlob(file, filename);
  else { // Others
    var a = document.createElement("a"),
      url = URL.createObjectURL(file);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(function() {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);  
    }, 0); 
  }
}

function newProject(){
  clearGantt();
}


function clearGantt() {
  ge.reset();
}

//-------------------------------------------  Get project file as JSON (used for migrate project from gantt to Teamwork) ------------------------------------------------------
function getFile() {
  $("#gimBaPrj").val(JSON.stringify(ge.saveProject()));
  $("#gimmeBack").submit();
  $("#gimBaPrj").val("");

  /*  var uriContent = "data:text/html;charset=utf-8," + encodeURIComponent(JSON.stringify(prj));
   neww=window.open(uriContent,"dl");*/
}


function loadFromLocalStorage(tabId = 'tab1') {
  var ret;
  
  if (localStorage) {
    // Önce tab'a özgü veriyi dene
    if (localStorage.getObject(`teamworkGantDemo_${tabId}`)) {
      ret = localStorage.getObject(`teamworkGantDemo_${tabId}`);
    } 
    // Yoksa global veriyi dene (uyumluluk için)
    else if (localStorage.getObject("teamworkGantDemo")) {
      ret = localStorage.getObject("teamworkGantDemo");
    }
  }
  
  // Bulunamadıysa yeni örnek oluştur
  if (!ret || !ret.tasks || ret.tasks.length == 0) {
    ret = getDemoProject();
  }
  
  return ret;
}


function saveInLocalStorage() {
  // Aktif tabı bul
  const activeTab = document.querySelector('.gantt-tab-item.active');
  const tabId = activeTab ? activeTab.getAttribute('data-tab') : 'tab1';
  
  // İlgili Gantt örneğini bul
  const ge = gantInstances[tabId];
  if (!ge) {
    console.error(`Gantt instance for tab ${tabId} not found!`);
    return;
  }
  
  // Projeyi kaydet
  const prj = ge.saveProject();
  
  if (localStorage) {
    // Her tab için ayrı storage key kullan
    localStorage.setObject(`teamworkGantDemo_${tabId}`, prj);
    
    // Eski global çalışmalar için uyumluluk
    if (tabId === 'tab1') {
      localStorage.setObject("teamworkGantDemo", prj);
    }
  }
}



function editResources() {
    // Kaynak düzenleme modalını oluştur
    var resourceEditor = $.JST.createFromTemplate({}, "RESOURCE_EDITOR");
    var resTbl = resourceEditor.find("#resourcesTable");

    // Mevcut kaynakları tabloya ekle
    ge.resources.forEach(function (res) {
        resTbl.append($.JST.createFromTemplate(res, "RESOURCE_ROW"));
    });

    // Yeni kaynak ekleme butonuna tıklama olayı
    resourceEditor.find("#addResource").click(function () {
        resTbl.append($.JST.createFromTemplate({ id: "new", name: "" }, "RESOURCE_ROW"));
    });

    // Kaydet butonuna tıklama olayı
    resourceEditor.find("#resSaveButton").click(function () {
        var newResources = [];

        // Mevcut kaynakları güncelle
        resTbl.find("tr").each(function () {
            var row = $(this);
            var id = row.attr("resId");
            var name = row.find("input[name='name']").val();

            if (name.trim() !== "") {
                newResources.push({ id: id, name: name });
            }
        });

        // Kaynakları güncelle ve Gantt grafiğini yeniden çiz
        ge.resources = newResources;
        closeBlackPopup(); // Modalı kapat
        ge.redraw(); // Gantt grafiğini yeniden çiz
    });

    // Modalı aç
    createModalPopup(400, 500).append(resourceEditor);
}

function initializeHistoryManagement(taskId){

  //retrieve from server the list of history points in millisecond that represent the instant when the data has been recorded
  //response: {ok:true, historyPoints: [1498168800000, 1498600800000, 1498687200000, 1501538400000, …]}
  $.getJSON(contextPath+"/applications/teamwork/task/taskAjaxController.jsp", {CM: "GETGANTTHISTPOINTS", OBJID:taskId}, function (response) {

    //if there are history points
    if (response.ok == true && response.historyPoints && response.historyPoints.length>0) {

      //add show slider button on button bar
      var histBtn = $("<button>").addClass("button textual icon lreq30 lreqLabel").attr("title", "SHOW_HISTORY").append("<span class=\"teamworkIcon\">&#x60;</span>");

      //clicking it
      histBtn .click(function () {
        var el = $(this);
        var ganttButtons = $(".ganttButtonBar .buttons");

        //is it already on?
        if (!ge.element.is(".historyOn")) {
          ge.element.addClass("historyOn");
          ganttButtons.find(".requireCanWrite").hide();

          //load the history points from server again
          showSavingMessage();
          $.getJSON(contextPath + "/applications/teamwork/task/taskAjaxController.jsp", {CM: "GETGANTTHISTPOINTS", OBJID: ge.tasks[0].id}, function (response) {
            jsonResponseHandling(response);
            hideSavingMessage();
            if (response.ok == true) {
              var dh = response.historyPoints;
              if (dh && dh.length > 0) {
                //si crea il div per lo slider
                var sliderDiv = $("<div>").prop("id", "slider").addClass("lreq30 lreqHide").css({"display":"inline-block","width":"500px"});
                ganttButtons.append(sliderDiv);

                var minVal = 0;
                var maxVal = dh.length-1 ;

                $("#slider").show().mbSlider({
                  rangeColor : '#2f97c6',
                  minVal     : minVal,
                  maxVal     : maxVal,
                  startAt    : maxVal,
                  showVal    : false,
                  grid       :1,
                  formatValue: function (val) {
                    return new Date(dh[val]).format();
                  },
                  onSlideLoad: function (obj) {
                    this.onStop(obj);

                  },
                  onStart    : function (obj) {},
                  onStop     : function (obj) {
                    var val = $(obj).mbgetVal();
                    showSavingMessage();
                    /**
                     * load the data history for that milliseconf from server
                     * response in this format {ok: true, baselines: {...}}
                     *
                     * baselines: {61707: {duration:1,endDate:1550271599998,id:61707,progress:40,startDate:1550185200000,status:"STATUS_WAITING",taskId:"3055"},
                     *            {taskId:{duration:in days,endDate:in millis,id:history record id,progress:in percent,startDate:in millis,status:task status,taskId:"3055"}....}}                     */

                    $.getJSON(contextPath + "/applications/teamwork/task/taskAjaxController.jsp", {CM: "GETGANTTHISTORYAT", OBJID: ge.tasks[0].id, millis:dh[val]}, function (response) {
                      jsonResponseHandling(response);
                      hideSavingMessage();
                      if (response.ok ) {
                        ge.baselines=response.baselines;
                        ge.showBaselines=true;
                        ge.baselineMillis=dh[val];
                        ge.redraw();
                      }
                    })

                  },
                  onSlide    : function (obj) {
                    clearTimeout(obj.renderHistory);
                    var self = this;
                    obj.renderHistory = setTimeout(function(){
                      self.onStop(obj);
                    }, 200)

                  }
                });
              }
            }
          });


          // closing the history
        } else {
          //remove the slider
          $("#slider").remove();
          ge.element.removeClass("historyOn");
          if (ge.permissions.canWrite)
            ganttButtons.find(".requireCanWrite").show();

          ge.showBaselines=false;
          ge.baselineMillis=undefined;
          ge.redraw();
        }

      });
      $("#saveGanttButton").before(histBtn);
    }
  })
}

function showBaselineInfo (event,element){
  //alert(element.attr("data-label"));
  $(element).showBalloon(event, $(element).attr("data-label"));
  ge.splitter.secondBox.one("scroll",function(){
    $(element).hideBalloon();
  })
}

</script>

<div id="gantEditorTemplates" style="display:none;">
<div class="__template__" type="GANTBUTTONS">

  <!--
  <div class="ganttButtonBar no-print">
    <div class="buttons">
    {% if request.user.kullanicilar_db %}
{% kulanici_yetkileri_kullandirt request.user request.user.kullanicilar_db as yetki %}
  {% if yetki.gant_duzenleme %}
    <button onclick="saveGanttOnServer();" class="button first big requireWrite" title="{% trans 'Kaydet' %}">{% trans 'Kaydet' %}</button>
  {% else %}
  {% endif %}
{% else %}
<button onclick="saveGanttOnServer();" class="button first big requireWrite" title="{% trans 'Kaydet' %}">{% trans 'Kaydet' %}</button>
{% endif %}
      
      <button onclick="$('#workSpace').trigger('undo.gantt');return false;" class="button textual icon requireCanWrite" title="undo"><span class="teamworkIcon">&#39;</span></button>
      <button onclick="$('#workSpace').trigger('redo.gantt');return false;" class="button textual icon requireCanWrite" title="redo"><span class="teamworkIcon">&middot;</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanAdd"></span>
      <button onclick="$('#workSpace').trigger('addAboveCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanAdd" title="insert above"><span class="teamworkIcon">l</span></button>
      <button onclick="$('#workSpace').trigger('addBelowCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanAdd" title="insert below"><span class="teamworkIcon">X</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanInOutdent"></span>
      <button onclick="$('#workSpace').trigger('outdentCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanInOutdent" title="un-indent task"><span class="teamworkIcon">.</span></button>
      <button onclick="$('#workSpace').trigger('indentCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanInOutdent" title="indent task"><span class="teamworkIcon">:</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanMoveUpDown"></span>
      <button onclick="$('#workSpace').trigger('moveUpCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanMoveUpDown" title="move up"><span class="teamworkIcon">k</span></button>
      <button onclick="$('#workSpace').trigger('moveDownCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanMoveUpDown" title="move down"><span class="teamworkIcon">j</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanDelete"></span>
      <button onclick="$('#workSpace').trigger('deleteFocused.gantt');return false;" class="button textual icon delete requireCanWrite" title="Elimina"><span class="teamworkIcon">&cent;</span></button>
      <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('expandAll.gantt');return false;" class="button textual icon " title="EXPAND_ALL"><span class="teamworkIcon">6</span></button>
      <button onclick="$('#workSpace').trigger('collapseAll.gantt'); return false;" class="button textual icon " title="COLLAPSE_ALL"><span class="teamworkIcon">5</span></button>

    <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('zoomMinus.gantt'); return false;" class="button textual icon " title="zoom out"><span class="teamworkIcon">)</span></button>
      <button onclick="$('#workSpace').trigger('zoomPlus.gantt');return false;" class="button textual icon " title="zoom in"><span class="teamworkIcon">(</span></button>
    <span class="ganttButtonSeparator"></span>
      <button onclick="exportGanttToPDF()" class="button textual icon" title="Export to PDF"><span class="teamworkIcon">p</span></button>
    <span class="ganttButtonSeparator"></span>
      <button onclick="ge.gantt.showCriticalPath=!ge.gantt.showCriticalPath; ge.redraw();return false;" class="button textual icon requireCanSeeCriticalPath" title="CRITICAL_PATH"><span class="teamworkIcon">&pound;</span></button>
    <span class="ganttButtonSeparator requireCanSeeCriticalPath"></span>
      <button onclick="ge.splitter.resize(.1);return false;" class="button textual icon" ><span class="teamworkIcon">F</span></button>
      <button onclick="ge.splitter.resize(50);return false;" class="button textual icon" ><span class="teamworkIcon">O</span></button>
      <button onclick="ge.splitter.resize(100);return false;" class="button textual icon"><span class="teamworkIcon">R</span></button>
      <span class="ganttButtonSeparator"></span>
    <button onclick="toggleFullScreen()" class="button textual icon" title="FULLSCREEN" id="fullscrbtn"><span class="teamworkIcon">@</span></button>
      <button onclick="ge.element.toggleClass('colorByStatus' );return false;" class="button textual icon"><span class="teamworkIcon">&sect;</span></button>

    <button onclick="editResources();" class="button textual requireWrite" title="edit resources"><span class="teamworkIcon">M</span></button>
      &nbsp; &nbsp; &nbsp; &nbsp;
    </div>

    <div>
      <button class="button login" title="login/enroll" onclick="loginEnroll($(this));" style="display:none;">login/enroll</button>
      <button class="button opt collab" title="Start with Twproject" onclick="collaborate($(this));" style="display:none;"><em>collaborate</em></button>
    </div>
  </div>
  -->
</div>

<div class="__template__" type="TASKSEDITHEAD"><!--
  <table class="gdfTable" cellspacing="0" cellpadding="0">
    <thead>
    <tr style="height:40px">
      <th class="gdfColHeader" style="width:35px; border-right: none"></th>
      <th class="gdfColHeader" style="width:25px;"></th>
      <th class="gdfColHeader gdfResizable" style="width:100px;">{% trans 'Kısa Ad' %}</th>
      <th class="gdfColHeader gdfResizable" style="width:300px;">{% trans 'İmalat' %}</th>
      <th class="gdfColHeader"  align="center" style="width:17px;" title="{% trans 'Başlangıç tarihi bir dönüm noktasıdır.' %}"><span class="teamworkIcon" style="font-size: 8px;">^</span></th>
      <th class="gdfColHeader gdfResizable" style="width:80px;">{% trans 'Başlangıç' %}</th>
      <th class="gdfColHeader"  align="center" style="width:17px;" title="{% trans 'Bitiş tarihi bir dönüm noktasıdır.' %}"><span class="teamworkIcon" style="font-size: 8px;">^</span></th>
      <th class="gdfColHeader gdfResizable" style="width:80px;">{% trans 'Bitiş' %}</th>
      <th class="gdfColHeader gdfResizable" style="width:50px;">{% trans 'Süre' %}</th>
      <th class="gdfColHeader gdfResizable" style="width:20px;">%</th>
      <th class="gdfColHeader gdfResizable requireCanSeeDep" style="width:50px;">{% trans 'Bağlı İml.' %}</th>
      <th class="gdfColHeader gdfResizable" style="width:1000px; display: none; text-align: left; padding-left: 10px;">{% trans 'assignees' %}</th>
    </tr>
    </thead>
  </table>
  --></div>

<div class="__template__" type="TASKROW"><!--
  <tr id="tid_(#=obj.id#)" taskId="(#=obj.id#)" class="taskEditRow (#=obj.isParent()?'isParent':''#) (#=obj.collapsed?'collapsed':''#)" level="(#=level#)">
    <th class="gdfCell edit" align="right" style="cursor:pointer;"><span class="taskRowIndex">(#=obj.getRow()+1#)</span> <span class="teamworkIcon" style="font-size:12px;" >e</span></th>
    <td class="gdfCell noClip" align="center"><div class="taskStatus cvcColorSquare" status="(#=obj.status#)"></div></td>
    <td class="gdfCell"><input type="text" name="code" value="(#=obj.code?obj.code:''#)" placeholder="{% trans 'No/Kısa Ad' %}"></td>
    <td class="gdfCell indentCell" style="padding-left:(#=obj.level*10+18#)px;">
      <div class="exp-controller" align="center"></div>
      <input type="text" name="name" value="(#=obj.name#)" placeholder="{% trans 'name' %}">
    </td>
    <td class="gdfCell" align="center"><input type="checkbox" name="startIsMilestone"></td>
    <td class="gdfCell"><input type="text" name="start"  value="" class="date"></td>
    <td class="gdfCell" align="center"><input type="checkbox" name="endIsMilestone"></td>
    <td class="gdfCell"><input type="text" name="end" value="" class="date"></td>
    <td class="gdfCell"><input type="text" name="duration" autocomplete="off" value="(#=obj.duration#)"></td>
    <td class="gdfCell"><input type="text" name="progress" class="validated" entrytype="PERCENTILE" autocomplete="off" value="(#=obj.progress?obj.progress:''#)" (#=obj.progressByWorklog?"readOnly":""#)></td>
    <td class="gdfCell requireCanSeeDep"><input type="text" name="depends" autocomplete="off" value="(#=obj.depends#)" (#=obj.hasExternalDep?"readonly":""#)></td>
    <td class="gdfCell taskAssigs">(#=obj.getAssigsString()#)</td>
  </tr>
  --></div>

<div class="__template__" type="TASKEMPTYROW"><!--
  <tr class="taskEditRow emptyRow" >
    <th class="gdfCell" align="right"></th>
    <td class="gdfCell noClip" align="center"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell requireCanSeeDep"></td>
    <td class="gdfCell"></td>
  </tr>
  --></div>

<div class="__template__" type="TASKBAR"><!--
  <div class="taskBox taskBoxDiv" taskId="(#=obj.id#)" >
    <div class="layout (#=obj.hasExternalDep?'extDep':''#)">
      <div class="taskStatus" status="(#=obj.status#)"></div>
      <div class="taskProgress" style="width:(#=obj.progress>100?100:obj.progress#)%; background-color:(#=obj.progress>100?'red':'rgb(153,255,51);'#);"></div>
      <div class="milestone (#=obj.startIsMilestone?'active':''#)" ></div>

      <div class="taskLabel"></div>
      <div class="milestone end (#=obj.endIsMilestone?'active':''#)" ></div>
    </div>
  </div>
  --></div>


<div class="__template__" type="CHANGE_STATUS"><!--
    <div class="taskStatusBox">
    <div class="taskStatus cvcColorSquare" status="STATUS_ACTIVE" title="{% trans 'Aktif' %}"></div>
    <div class="taskStatus cvcColorSquare" status="STATUS_DONE" title="{% trans 'Tamamlandı' %}"></div>
    <div class="taskStatus cvcColorSquare" status="STATUS_FAILED" title="{% trans 'Hatalı' %}"></div>
    <div class="taskStatus cvcColorSquare" status="STATUS_SUSPENDED" title="{% trans 'Duraklatıldı' %}"></div>
    <div class="taskStatus cvcColorSquare" status="STATUS_WAITING" title="{% trans 'Beklemede' %}" style="display: none;"></div>
    <div class="taskStatus cvcColorSquare" status="STATUS_UNDEFINED" title="{% trans 'Bilinmiyor' %}"></div>
    </div>
  --></div>




<div class="__template__" type="TASK_EDITOR"><!--
  <div class="ganttTaskEditor">
    <h2 class="taskData">{% trans 'İmalat Editörü' %}</h2>
    <table  cellspacing="1" cellpadding="5" width="100%" class="taskData table" border="0">
          <tr>
        <td width="200" style="height: 80px"  valign="top">
          <label for="code">{% trans 'No / Kısa ad' %}</label><br>
          <input type="text" name="code" id="code" value="" size=15 class="formElements" autocomplete='off' maxlength=255 style='width:100%' oldvalue="1">
        </td>
        <td colspan="3" valign="top"><label for="name" class="required">{% trans 'İmalat' %}</label><br><input type="text" name="name" id="name"class="formElements" autocomplete='off' maxlength=255 style='width:100%' value="" required="true" oldvalue="1"></td>
          </tr>


      <tr class="dateRow">
        <td nowrap="">
          <div style="position:relative">
            <label for="start">{% trans 'Başlangıç' %}</label>&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="checkbox" id="startIsMilestone" name="startIsMilestone" value="yes"> &nbsp;<label for="startIsMilestone">{% trans 'dönüm noktası' %}</label>&nbsp;
            <br><input type="text" name="start" id="start" size="8" class="formElements dateField validated date" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DATE">
            <span title="{% trans 'calendar' %}" id="starts_inputDate" class="teamworkIcon openCalendar" onclick="$(this).dateField({inputField:$(this).prevAll(':input:first'),isSearchField:false});">m</span>          </div>
        </td>
        <td nowrap="">
          <label for="end">{% trans 'Bitiş' %}</label>&nbsp;&nbsp;&nbsp;&nbsp;
          <input type="checkbox" id="endIsMilestone" name="endIsMilestone" value="yes"> &nbsp;<label for="endIsMilestone">{% trans 'dönüm noktası' %}</label>&nbsp;
          <br><input type="text" name="end" id="end" size="8" class="formElements dateField validated date" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DATE">
          <span title="{% trans 'calendar' %}" id="ends_inputDate" class="teamworkIcon openCalendar" onclick="$(this).dateField({inputField:$(this).prevAll(':input:first'),isSearchField:false});">m</span>
        </td>
        <td nowrap="" >
          <label for="duration" class=" ">{% trans 'Gün' %}</label><br>
          <input type="text" name="duration" id="duration" size="4" class="formElements validated durationdays" title="{% trans 'Duration is in working days.' %}" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DURATIONDAYS">&nbsp;
        </td>
      </tr>

      <tr>
        <td  colspan="2">
          <label for="status" class=" ">{% trans 'Durum' %}</label><br>
          <select id="durum" name="Durum" class="taskStatus" status="(#=obj.status#)"  onchange="$(this).attr('STATUS',$(this).val());">
            <option value="STATUS_ACTIVE" class="taskStatus" status="STATUS_ACTIVE" >{% trans 'Aktif' %}</option>
            <option value="STATUS_WAITING" class="taskStatus" status="STATUS_WAITING" >{% trans 'Beklemede' %}</option>
            <option value="STATUS_SUSPENDED" class="taskStatus" status="STATUS_SUSPENDED" >{% trans 'Duraklatıldı' %}</option>
            <option value="STATUS_DONE" class="taskStatus" status="STATUS_DONE" >{% trans 'Tamamlandı' %}</option>
            <option value="STATUS_FAILED" class="taskStatus" status="STATUS_FAILED" >{% trans 'Hatalı' %}</option>
            <option value="STATUS_UNDEFINED" class="taskStatus" status="STATUS_UNDEFINED" >{% trans 'Bilinmiyor' %}</option>
          </select>
        </td>

        <td valign="top" nowrap>
          <label>{% trans 'İlerleme' %}</label><br>
          <input type="text" name="progress" id="progress" size="7" class="formElements validated percentile" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="PERCENTILE">
        </td>
      </tr>

          </tr>
          <tr>
            <td colspan="4">
              <label for="description">{% trans 'Açıklama' %}</label><br>
              <textarea rows="3" cols="30" id="description" name="description" class="formElements" style="width:100%"></textarea>
            </td>
          </tr>
        </table>


  <div style="text-align: right; padding-top: 20px">
    <span id="saveButton" class="button first" onClick="$(this).trigger('saveFullEditor.gantt');">{% trans 'Ekle' %}</span>
  </div>

  </div>
  --></div>







<div class="__template__" type="RESOURCE_EDITOR"><!--
  <div class="resourceEditor" style="padding: 5px;">

    <h2>{% trans 'Project team' %}</h2>
    <table  cellspacing="1" cellpadding="0" width="100%" id="resourcesTable">
      <tr>
        <th style="width:100px;">{% trans 'name' %}</th>
        <th style="width:30px;" id="addResource"><span class="teamworkIcon" style="cursor: pointer">+</span></th>
      </tr>
    </table>

    <div style="text-align: right; padding-top: 20px"><button id="resSaveButton" class="button big">{% trans 'Save' %}</button></div>
  </div>
  --></div>



<div class="__template__" type="RESOURCE_ROW"><!--
  <tr resId="(#=obj.id#)" class="resRow" >
    <td ><input type="text" name="name" value="(#=obj.name#)" style="width:100%;" class="formElements"></td>
    <td align="center"><span class="teamworkIcon delRes del" style="cursor: pointer">d</span></td>
  </tr>
  --></div>


</div>
<script type="text/javascript">
  $.JST.loadDecorator("RESOURCE_ROW", function(resTr, res){
    resTr.find(".delRes").click(function(){$(this).closest("tr").remove()});
  });

  $.JST.loadDecorator("ASSIGNMENT_ROW", function(assigTr, taskAssig){
    var resEl = assigTr.find("[name=resourceId]");
    var opt = $("<option>");
    resEl.append(opt);
    for(var i=0; i< taskAssig.task.master.resources.length;i++){
      var res = taskAssig.task.master.resources[i];
      opt = $("<option>");
      opt.val(res.id).html(res.name);
      if(taskAssig.assig.resourceId == res.id)
        opt.attr("selected", "true");
      resEl.append(opt);
    }
    var roleEl = assigTr.find("[name=roleId]");
    for(var i=0; i< taskAssig.task.master.roles.length;i++){
      var role = taskAssig.task.master.roles[i];
      var optr = $("<option>");
      optr.val(role.id).html(role.name);
      if(taskAssig.assig.roleId == role.id)
        optr.attr("selected", "true");
      roleEl.append(optr);
    }

    if(taskAssig.task.master.permissions.canWrite && taskAssig.task.canWrite){
      assigTr.find(".delAssig").click(function(){
        var tr = $(this).closest("[assId]").fadeOut(200, function(){$(this).remove()});
      });
    }

  });


  function loadI18n(){
    GanttMaster.messages = {
      "CANNOT_WRITE":"No permission to change the following task:",
      "CHANGE_OUT_OF_SCOPE":"Project update not possible as you lack rights for updating a parent project.",
      "START_IS_MILESTONE":"Start date is a milestone.",
      "END_IS_MILESTONE":"End date is a milestone.",
      "TASK_HAS_CONSTRAINTS":"Task has constraints.",
      "GANTT_ERROR_DEPENDS_ON_OPEN_TASK":"Error: there is a dependency on an open task.",
      "GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK":"Error: due to a descendant of a closed task.",
      "TASK_HAS_EXTERNAL_DEPS":"This task has external dependencies.",
      "GANNT_ERROR_LOADING_DATA_TASK_REMOVED":"GANNT_ERROR_LOADING_DATA_TASK_REMOVED",
      "CIRCULAR_REFERENCE":"Circular reference.",
      "CANNOT_DEPENDS_ON_ANCESTORS":"Cannot depend on ancestors.",
      "INVALID_DATE_FORMAT":"The data inserted are invalid for the field format.",
      "GANTT_ERROR_LOADING_DATA_TASK_REMOVED":"An error has occurred while loading the data. A task has been trashed.",
      "CANNOT_CLOSE_TASK_IF_OPEN_ISSUE":"Cannot close a task with open issues",
      "TASK_MOVE_INCONSISTENT_LEVEL":"You cannot exchange tasks of different depth.",
      "CANNOT_MOVE_TASK":"CANNOT_MOVE_TASK",
      "PLEASE_SAVE_PROJECT":"PLEASE_SAVE_PROJECT",
      "GANTT_SEMESTER":"Semester",
      "GANTT_SEMESTER_SHORT":"s.",
      "GANTT_QUARTER":"Quarter",
      "GANTT_QUARTER_SHORT":"q.",
      "GANTT_WEEK":"Week",
      "GANTT_WEEK_SHORT":"w."
    };
  }



  function createNewResource(el) {
    var row = el.closest("tr[taskid]");
    var name = row.find("[name=resourceId_txt]").val();
    var url = contextPath + "/applications/teamwork/resource/resourceNew.jsp?CM=ADD&name=" + encodeURI(name);

    openBlackPopup(url, 700, 320, function (response) {
      //fillare lo smart combo
      if (response && response.resId && response.resName) {
        //fillare lo smart combo e chiudere l'editor
        row.find("[name=resourceId]").val(response.resId);
        row.find("[name=resourceId_txt]").val(response.resName).focus().blur();
      }

    });
  }

$(document).on("change", "#load-file", function() {
  var uploadedFile = $("#load-file").prop("files")[0];
  upload(uploadedFile);
});

</script>

<script>
// Tab Sistemi için JavaScript
let tabCounter = 1;
let gantInstances = {}; // Her tab için ayrı gantt örneği saklamak için

// Sayfa yüklendiğinde ilk tab için gantt'ı başlat
document.addEventListener("DOMContentLoaded", function() {
    // İlk tab için Gantt örneği oluştur
    initializeGanttForTab('tab1');
    
    // İlk tab başlığını ayarla
    const firstTab = document.querySelector('.gantt-tab-item');
    if (firstTab) {
        updateTabTitle(firstTab.textContent.trim());
    }
});

// Tab değiştirme
function switchTab(tabId) {
    // Tüm tabları inaktif yap
    document.querySelectorAll('.gantt-tab-item').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.gantt-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Seçilen tabı aktif yap
    const selectedTab = document.querySelector(`[data-tab="${tabId}"]`);
    selectedTab.classList.add('active');
    document.getElementById(`${tabId}-content`).classList.add('active');
    
    // Başlığı güncelle
    updateTabTitle(selectedTab.textContent.trim());
    
    // İlgili Gantt örneğini al ve ilk göreve odakla
    const ge = gantInstances[tabId];
    if (ge) {
        setTimeout(() => {
            centerGanttOnToday(ge);
        }, 300);
    }
}

// Başlığı güncelleme fonksiyonu
function updateTabTitle(tabName) {
    // Edit ve delete ikonlarını temizle
    let cleanTabName = tabName.replace(/\s*<span.*<\/span>\s*/g, '').trim();
    document.getElementById('activeTabTitle').innerHTML = `{% trans 'Stratejik İş Planı (GANTT)' %} - ${cleanTabName}`;
}

// Yeni tab eklemek için
function addNewTab() {
    const tabName = document.getElementById('newTabName').value.trim();
    if (!tabName) {
        alert("{% trans 'Lütfen tab için bir isim girin!' %}");
        return;
    }
    
    tabCounter++;
    const tabId = `tab${tabCounter}`;
    
    // Tüm tabları inaktif yap
    document.querySelectorAll('.gantt-tab-item').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.gantt-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Yeni tab ve içeriğini ekle
    const tabsContainer = document.getElementById('ganttTabs');
    const newTab = document.createElement('li');
    newTab.className = 'gantt-tab-item active';
    newTab.setAttribute('data-tab', tabId);
    newTab.innerHTML = `${tabName} <span class="gantt-tab-action edit" onclick="renameTab(event, '${tabId}')"><i class="icon icon-action-edit"></i></span><span class="gantt-tab-action delete" onclick="deleteTab(event, '${tabId}')"><i class="icon icon-action-delete"></i></span>`;
    
    tabsContainer.appendChild(newTab);
    
    // Tab içeriği oluştur
    const tabContentContainer = document.createElement('div');
    tabContentContainer.className = 'gantt-tab-content active';
    tabContentContainer.id = `${tabId}-content`;
    
    // workSpace div'ini oluştur
    const workSpaceDiv = document.createElement('div');
    workSpaceDiv.id = `${tabId}-workSpace`;
    workSpaceDiv.style.width = "100%";
    workSpaceDiv.style.height = "500px"; // Belirli bir yükseklik verelim
    tabContentContainer.appendChild(workSpaceDiv);
    
    // Tab içerik konteynerini sayfaya ekle
    const tabsContainerParent = document.querySelector('.gantt-tabs-container').parentNode;
    tabsContainerParent.insertBefore(tabContentContainer, document.querySelector('.large-stats-card-footer-actions'));
    
    // Başlığı güncelle
    updateTabTitle(tabName);
    
    // Input alanını temizle
    document.getElementById('newTabName').value = '';
    
    // Yeni tab için gantt başlat (DOM'a eklendikten sonra)
    setTimeout(() => {
        initializeGanttForTab(tabId);
    }, 300); // Biraz daha uzun bekletelim
}

// Tab'a tıklandığında
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('gantt-tab-item') || e.target.closest('.gantt-tab-item')) {
        const targetTab = e.target.classList.contains('gantt-tab-item') ? e.target : e.target.closest('.gantt-tab-item');
        
        // Tıklanan bir aksiyon değilse (düzenle/sil butonu)
        if (!e.target.closest('.gantt-tab-action')) {
            const tabId = targetTab.getAttribute('data-tab');
            
            // Bu tab için Gantt örneği henüz oluşturulmadıysa oluştur
            if (tabId !== 'tab1' && !gantInstances[tabId]) {
                console.log(`Tab ${tabId} için Gantt yükleniyor (lazy loading)`);
                initializeGanttForTab(tabId);
            } else {
                switchTab(tabId);
            }
        }
    }
});

// Tab ismini düzenleme
function renameTab(event, tabId) {
    event.stopPropagation();
    
    const tab = document.querySelector(`[data-tab="${tabId}"]`);
    const currentName = tab.childNodes[0].nodeValue.trim();
    
    // Halihazırda düzenleme formu var mı kontrol et
    if (tab.querySelector('.gantt-tab-rename-form')) {
        return;
    }
    
    // Düzenleme formunu oluştur
    const renameForm = document.createElement('div');
    renameForm.className = 'gantt-tab-rename-form';
    renameForm.innerHTML = `
        <input type="text" value="${currentName}">
        <button type="button" onclick="saveTabName('${tabId}')"><i class="icon icon-action-success"></i></button>
        <button type="button" class="cancel" onclick="cancelRename('${tabId}')"><i class="icon icon-action-reject"></i></button>
    `;
    
    tab.appendChild(renameForm);
    renameForm.style.display = 'flex';
    
    // Input'a odaklan
    const input = renameForm.querySelector('input');
    input.focus();
    input.select();
    
    // Enter tuşu ile kaydet, Escape ile iptal et
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveTabName(tabId);
        } else if (e.key === 'Escape') {
            cancelRename(tabId);
        }
    });
}

// Tab ismini kaydet
function saveTabName(tabId) {
    const tab = document.querySelector(`[data-tab="${tabId}"]`);
    const form = tab.querySelector('.gantt-tab-rename-form');
    const newName = form.querySelector('input').value.trim();
    
    if (newName) {
        // İlk düğümü (metin düğümü) bul ve değiştir
        let replaced = false;
        for (let i = 0; i < tab.childNodes.length; i++) {
            if (tab.childNodes[i].nodeType === Node.TEXT_NODE) {
                tab.childNodes[i].nodeValue = newName + ' ';
                replaced = true;
                break;
            }
        }
        
        // Eğer metin düğümü bulunamadıysa, yeni bir tane ekle
        if (!replaced) {
            tab.insertBefore(document.createTextNode(newName + ' '), tab.firstChild);
        }
        
        // Aktif tab ise başlığı da güncelle
        if (tab.classList.contains('active')) {
            updateTabTitle(newName);
        }
        
        // Tabları localStorage'a kaydet
        saveTabsToStorage();
    }
    
    // Düzenleme formunu kaldır
    form.remove();
}

// Tab ismi düzenlemeyi iptal et
function cancelRename(tabId) {
    const tab = document.querySelector(`[data-tab="${tabId}"]`);
    const form = tab.querySelector('.gantt-tab-rename-form');
    form.remove();
}

// Tab silme
function deleteTab(event, tabId) {
    event.stopPropagation();
    
    // İlk tab silinmesin
    if (tabId === 'tab1') {
        alert("{% trans 'Varsayılan tab silinemez!' %}");
        return;
    }
    
    if (confirm("{% trans 'Bu tabı silmek istediğinize emin misiniz?' %}")) {
        // Tab ve içeriğini kaldır
        const tab = document.querySelector(`[data-tab="${tabId}"]`);
        const tabContent = document.getElementById(`${tabId}-content`);
        
        tab.remove();
        tabContent.remove();
        
        // Gantt örneğini temizle
        if (gantInstances[tabId]) {
            delete gantInstances[tabId];
        }
        
        // Tabları localStorage'a kaydet
        saveTabsToStorage();
        
        // İlk taba geç
        switchTab('tab1');
    }
}

// Gantt şemasını bugünün tarihine odaklama
function centerGanttOnToday(ganttMaster) {
    console.log("Bugünün tarihine odaklanılıyor...");
    
    setTimeout(() => {
        try {
            // Gantt nesnesini al
            const gantt = ganttMaster.gantt;
            if (!gantt) {
                console.error("Gantt nesnesi bulunamadı");
                return;
            }
            
            // Bugünün tarihini al
            const today = new Date();
            console.log("Bugünün tarihi:", today.toLocaleDateString());
            
            // Gantt'ı yeniden çiz ve zoom'u ayarla
            console.log("Gantt yeniden çiziliyor...");
            gantt.zoom = "3M"; // Üç aylık periyot
            
            // Bugüne odaklan özelliğini aç
            gantt.centerOnToday = true;
            
            // Yeniden çiz
            ganttMaster.redraw();
            
            // Gantt'ı bugünün tarihine scroll yap
            setTimeout(() => {
                try {
                    // Bugüne en yakın zaman çizgisi başlığını bul
                    const ganttEl = gantt.element;
                    const todayMs = today.getTime();
                    
                    // Bugüne en yakın zaman çizgisi başlığını bul
                    const headers = ganttEl.find(".headTimeline2 .col");
                    if (headers.length > 0) {
                        console.log("Zaman çizgisi başlıkları bulundu:", headers.length);
                        
                        let closestHeader = null;
                        let closestDiff = Number.MAX_SAFE_INTEGER;
                        
                        headers.each(function() {
                            const dateAttr = $(this).attr("date");
                            if (dateAttr) {
                                const headerDate = new Date(parseInt(dateAttr));
                                const diffTime = Math.abs(headerDate - today);
                                
                                if (diffTime < closestDiff) {
                                    closestDiff = diffTime;
                                    closestHeader = $(this);
                                }
                            }
                        });
                        
                        if (closestHeader) {
                            console.log("Bugüne en yakın başlık bulundu");
                            
                            // Scroll pozisyonunu hesapla
                            const scrollElement = ganttEl.find(".gantt-body-scroll");
                            const headerOffset = closestHeader.position().left;
                            
                            // Biraz soldan boşluk bırak
                            const scrollPos = Math.max(0, headerOffset - 100);
                            console.log("Scroll pozisyonu:", scrollPos);
                            
                            // Scroll yap
                            scrollElement.scrollLeft(scrollPos);
                            
                            // Scroll'u tekrar kontrol et
                            setTimeout(() => {
                                scrollElement.scrollLeft(scrollPos);
                                console.log("Scroll tekrar uygulandı");
                            }, 300);
                        } else {
                            console.error("Bugüne yakın başlık bulunamadı");
                        }
                    } else {
                        console.error("Zaman çizgisi başlıkları bulunamadı");
                    }
                } catch (error) {
                    console.error("Bugüne odaklanma hatası:", error);
                }
            }, 300);
        } catch (error) {
            console.error("Bugüne odaklanma hatası:", error);
        }
    }, 1000);
}

// Her tab için Gantt başlatma
function initializeGanttForTab(tabId) {
    console.log(`Initializing Gantt for tab: ${tabId}`);
    
    // workSpace div'ini kontrol et ve gerekirse oluştur
    let workSpaceElement = document.getElementById(`${tabId}-workSpace`);
    if (!workSpaceElement) {
        console.error(`WorkSpace element for ${tabId} not found!`);
        return;
    }
    
    // Gantt örneği oluştur
    try {
        const ge = new GanttMaster();
        ge.set100OnClose = true;
        ge.shrinkParent = true;
        
        // Tab workSpace'i için Gantt başlat
        ge.init(workSpaceElement);
        loadI18n();
        
        // Zoom ölçeğini ayarla - varsayılan zoom'u kaldırma
        delete ge.gantt.zoom;
        
        // Proje verisini yükle
        let project;
        // Tab adını al
        const tabElement = document.querySelector(`[data-tab="${tabId}"]`);
        const tabName = tabElement ? tabElement.textContent.trim() : "Yeni Proje";
        
        if (tabId === 'tab1') {
            project = loadFromLocalStorage(tabId);
        } else {
            // Yeni tablar için boş bir proje yapısı oluştur
            project = getDemoProject();
            // Tab adını projede kullan
            project.tasks[0].name = tabName;
        }
        
        if (!project.canWrite) {
            document.querySelectorAll(".ganttButtonBar button.requireWrite").forEach(btn => {
                btn.setAttribute("disabled", "true");
            });
        }
        
        // Projeyi yükle ve checkpoint oluştur
        ge.loadProject(project);
        ge.checkpoint();
        
        // Bu tab için Gantt örneğini kaydet
        gantInstances[tabId] = ge;
        
        // Bugünün tarihine odaklan
        setTimeout(() => {
            centerGanttOnToday(ge);
        }, 1000);
        
        console.log(`Gantt initialized for tab: ${tabId}`);
    } catch (error) {
        console.error(`Error initializing Gantt for tab ${tabId}:`, error);
    }
}

// Tabları sürükle-bırak ile sıralanabilir yapma
document.addEventListener("DOMContentLoaded", function() {
    initSortableTabs();
    loadTabsFromStorage();
});

// Tabları sürüklenebilir yapma
function initSortableTabs() {
    const tabsList = document.getElementById('ganttTabs');
    if (tabsList) {
        new Sortable(tabsList, {
            animation: 150,
            ghostClass: 'gantt-tabs-sortable-ghost',
            onEnd: function() {
                // Tab sıralaması değiştikten sonra saklama
                saveTabsToStorage();
            }
        });
    }
}

// Tab isimlerini ve sıralamasını localStorage'a saklama
function saveTabsToStorage() {
    const tabs = [];
    document.querySelectorAll('.gantt-tab-item').forEach(tab => {
        const tabId = tab.getAttribute('data-tab');
        const tabName = tab.textContent.trim().replace(/\s*<span.*<\/span>\s*/g, '');
        tabs.push({ id: tabId, name: tabName });
    });
    
    localStorage.setItem('ganttTabs', JSON.stringify(tabs));
    console.log('Tab isimleri ve sıralaması saklandı');
}

// Tab isimlerini ve sıralamasını localStorage'dan yükleme
function loadTabsFromStorage() {
    const savedTabs = localStorage.getItem('ganttTabs');
    if (savedTabs) {
        try {
            const tabs = JSON.parse(savedTabs);
            if (tabs.length > 0) {
                console.log('Kaydedilmiş tablar yükleniyor:', tabs.length);
                
                // İlk tab dışındaki (varsayılan) tüm tabları temizle
                const tabsList = document.getElementById('ganttTabs');
                const firstTab = tabsList.querySelector('.gantt-tab-item');
                if (firstTab) {
                    // İlk tabın adını güncelle
                    const firstTabData = tabs.find(t => t.id === 'tab1');
                    if (firstTabData) {
                        updateTabTextNode(firstTab, firstTabData.name);
                    }
                    
                    // Diğer tabları yükle
                    tabs.forEach((tab, index) => {
                        if (tab.id !== 'tab1') {
                            // Yeni tab oluştur
                            const newTab = document.createElement('li');
                            newTab.className = 'gantt-tab-item';
                            newTab.setAttribute('data-tab', tab.id);
                            newTab.innerHTML = `${tab.name} <span class="gantt-tab-action edit" onclick="renameTab(event, '${tab.id}')"><i class="icon icon-action-edit"></i></span><span class="gantt-tab-action delete" onclick="deleteTab(event, '${tab.id}')"><i class="icon icon-action-delete"></i></span>`;
                            tabsList.appendChild(newTab);
                            
                            // Tab içeriği oluştur
                            const tabContentContainer = document.createElement('div');
                            tabContentContainer.className = 'gantt-tab-content';
                            tabContentContainer.id = `${tab.id}-content`;
                            
                            // workSpace div'ini oluştur
                            const workSpaceDiv = document.createElement('div');
                            workSpaceDiv.id = `${tab.id}-workSpace`;
                            workSpaceDiv.style.width = "100%";
                            workSpaceDiv.style.height = "500px";
                            tabContentContainer.appendChild(workSpaceDiv);
                            
                            // Tab içerik konteynerini sayfaya ekle
                            const tabsContainerParent = document.querySelector('.gantt-tabs-container').parentNode;
                            tabsContainerParent.insertBefore(tabContentContainer, document.querySelector('.large-stats-card-footer-actions'));
                            
                            // Tab içeriğini hazırla, ancak şimdi yükleme - kullanıcı sekmeye tıkladığında yüklenecek
                            console.log(`Tab ${tab.id} oluşturuldu`);
                        }
                    });
                }
            }
        } catch (e) {
            console.error('Tab verilerini yükleme hatası:', e);
        }
    }
}

// Tab metnini güncellemek için yardımcı fonksiyon
function updateTabTextNode(tabElement, newText) {
    // İlk düğümü (metin düğümü) bul ve değiştir
    let replaced = false;
    for (let i = 0; i < tabElement.childNodes.length; i++) {
        if (tabElement.childNodes[i].nodeType === Node.TEXT_NODE) {
            tabElement.childNodes[i].nodeValue = newText + ' ';
            replaced = true;
            break;
        }
    }
    
    // Eğer metin düğümü bulunamadıysa, yeni bir tane ekle
    if (!replaced) {
        tabElement.insertBefore(document.createTextNode(newText + ' '), tabElement.firstChild);
    }
}
</script>
{% endblock sidebar %}
